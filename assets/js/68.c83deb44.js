(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{492:function(s,t,n){"use strict";n.r(t);var a=n(2),e=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("很多时候，我们想在系统启动的时候干一些“私活”，这个时候，我们就可以添加开机自启动的脚本来完成。下面我们介绍一个简单的示例：")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("device/Jelly/Rice14")]),s._v(" 目录下添加如下的文件与文件夹：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("initscript\n├── Android.bp\n├── initscript.rc\n└── initscript.sh\n\nsepolicy    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#部分文件为 seandroid 入门添加的内容")]),s._v("\n├── device.te      \n├── file_contexts\n├── hello_se.te\n└── initscript.te\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("initscript.sh 是一个简单的 shell 脚本：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/vendor/bin/sh")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"this is init script"')]),s._v("\nlog "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" initscript "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"this is initscript!"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#打 log")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("需要注意的是 shebang 的内容是 "),t("code",[s._v("#!/vendor/bin/sh")]),s._v("。")]),s._v(" "),t("p",[s._v("initscript.rc 的内容如下：")]),s._v(" "),t("div",{staticClass:"language-rc line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("service initscript /vendor/bin/initscript\n    class main\n    user root\n    group root system\n    oneshot\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("class main 指明当前服务时系统的基本服务,保证了系统启动时，会启动这个服务")]),s._v(" "),t("li",[s._v("oneshot 表示服务只执行一次")])]),s._v(" "),t("p",[s._v("Android.bp 的内容如下：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("cc_prebuilt_binary "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"initscript"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    srcs"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"initscript.sh"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    init_rc"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"initscript.rc"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n    strip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    vendor"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("接着是配置 selinux：")]),s._v(" "),t("p",[s._v("initscript.te 的内容如下：")]),s._v(" "),t("div",{staticClass:"language-te line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("type initscript_dt, domain;\ntype initscript_dt_exec, exec_type, vendor_file_type, file_type;\n\ninit_daemon_domain(initscript_dt)\ndomain_auto_trans(shell, initscript_dt_exec, initscript_dt);\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("file_contexts 中添加如下内容：")]),s._v(" "),t("div",{staticClass:"language-te line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("/vendor/bin/initscript          u:object_r:initscript_dt_exec:s0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("最后修改 "),t("code",[s._v("device/Jelly/Rice14/Rice14.mk")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-Makefile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-makefile"}},[t("code",[s._v("PRODUCT_PACKAGES "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" \\\n    helloseandroid \\\n    initscript\n\nBOARD_SEPOLICY_DIRS "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" \\\n    device/Jelly/Rice14/sepolicy\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("接着编译系统，启动模拟器：")]),s._v(" "),t("div",{staticClass:"language-Makefile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-makefile"}},[t("code",[s._v("source build/envsetup.sh\nlunch Rice14-userdebug\nmake -j16\nemulator\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("接着我们查看 log：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("logcat "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" initscript\n\n04-08 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":34:06.250  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1600")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1600")]),s._v(" W initscript: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1400")]),s._v(" audit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(":6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": avc: denied "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" execute_no_trans "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/vendor/bin/toybox_vendor"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dm-1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ino")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("205")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("scontext")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("u:r:initscript_dt:s0 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tcontext")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("u:object_r:vendor_toolbox_exec:s0 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tclass")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("file "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("permissive")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("错误信息，提示我们缺少权限，按照之前介绍的方法使用 audit2allow 命令，发现并没有生成缺失的权限。那怎么办？看报错信息喽：")]),s._v(" "),t("p",[s._v("报错信息的意思是：当 initscript_dt 执行安全上下文为 "),t("code",[s._v("u:object_r:vendor_toolbox_exec:s0")]),s._v(" 的 "),t("code",[s._v("/vendor/bin/toybox_vendor")]),s._v(" 时，缺少 execute_no_trans 权限。")]),s._v(" "),t("p",[s._v("什么意思呢？")]),s._v(" "),t("p",[s._v("我们先看下 "),t("code",[s._v("/vendor/bin/toybox_vendor")]),s._v(" 文件：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#切换为 root")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#带 x 权限，是一个可执行文件")]),s._v("\n-rwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root shell "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("503304")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2023")]),s._v("-04-08 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":04 /vendor/bin/toybox_vendor\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#不带参数执行一下")]),s._v("\n/vendor/bin/toybox_vendor                                                                                            \nacpi base64 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("basename")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bc")]),s._v(" blkid blockdev "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cal")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" chattr chcon "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chgrp")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chroot")]),s._v(" chrt "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cksum")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("clear")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cmp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("comm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" cpio "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cut")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" devmem\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("df")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dirname")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dmesg")]),s._v(" dos2unix "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("du")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expand")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("expr")]),s._v(" fallocate\n"),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fgrep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" flock "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fmt")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v(" freeramdisk fsfreeze fsync getconf\ngetenforce getfattr "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("groups")]),s._v(" gunzip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gzip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("help")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("hostname")]),s._v(" hwclock\ni2cdetect i2cdump i2cget i2cset "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("iconv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" inotifyd insmod\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ionice iorenice iotop "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("killall")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" load_policy log "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("logname")]),s._v("\nlosetup "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" lsattr lsmod "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" lspci lsusb makedevs md5sum microcom\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkfifo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mknod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkswap")]),s._v(" mktemp modinfo modprobe "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" mountpoint\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" nbd-client "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nc")]),s._v(" netcat "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nice")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" nproc nsenter od partprobe\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("paste")]),s._v(" patch pgrep pidof "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" ping6 pivot_root "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("pkill")]),s._v(" pmap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printenv")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" prlimit "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),s._v(" pwdx readlink realpath "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("renice")]),s._v(" restorecon "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rev")]),s._v("\nrfkill "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rmdir")]),s._v(" rmmod runcon "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" sendevent "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" setenforce setfattr\nsetprop setsid sha1sum sha224sum sha256sum sha384sum sha512sum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sort")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("split")]),s._v(" start "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stat")]),s._v(" stop strings stty swapoff "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("swapon")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sysctl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tac")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" taskset "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tr")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("traceroute")]),s._v(" traceroute6\n"),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" truncate "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tty")]),s._v(" tunctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("umount")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("uname")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("uniq")]),s._v(" unix2dos unlink\nunshare "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("uptime")]),s._v(" usleep "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("uudecode")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("uuencode")]),s._v(" uuidgen vconfig "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vmstat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("从以上的操作可以看出 toybox_vendor 是一个命令集合，我们常用的 shell 命令均会通过 toybox_vendor 来执行。")]),s._v(" "),t("p",[s._v("再回到权限那里，我们的脚本调用了 echo log 两个命令，这两个命令会通过执行 toybox_vendor 来实现，当执行 toybox_vendor 时，我们就需要 toybox_vendor 的打开，读取，执行权限，以及配置 domain 转换（A 程序到 B 程序都需要配置域转换）。 domain 转换可以简单配置执行时不转换 execute_no_trans 即可，综上，我们在 initscript.te 中添加如下权限：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("allow initscript_dt vendor_toolbox_exec:file "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" execute execute_no_trans "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接着再次编译系统，启动模拟器：")]),s._v(" "),t("div",{staticClass:"language-Makefile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-makefile"}},[t("code",[s._v("source build/envsetup.sh\nlunch Rice14-userdebug\nmake -j16\nemulator\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("进入 adb shell 查看信息：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230705163316.png",alt:""}})]),s._v(" "),t("p",[s._v("启动时打的 log，以及启动相关的属性值均正常，证明我们添加的脚本执行成功了。")]),s._v(" "),t("h2",{attrs:{id:"关于"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关于"}},[s._v("#")]),s._v(" 关于")]),s._v(" "),t("p",[s._v("我叫阿豪，2015 年本科毕业于国防科学技术大学指挥信息系统专业，毕业后从事信息化装备的研发工作，主要研究方向是 Android Framework 与 Linux Kernel。")]),s._v(" "),t("p",[s._v("如果你对 Android Framework 感兴趣或者正在学习 Android Framework，可以关注我的微信公众号和抖音，我会持续分享我的学习经验，帮助正在学习的你少走一些弯路。学习过程中如果你有疑问或者你的经验想要分享给大家可以添加我的微信，我拉你进技术交流群。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg",alt:""}})])])}),[],!1,null,null,null);t.default=e.exports}}]);