(window.webpackJsonp=window.webpackJsonp||[]).push([[127],{553:function(s,a,t){"use strict";t.r(a);var e=t(2),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("这是一个介绍 Android 属性系统的系列文章:")]),s._v(" "),a("ul",[a("li",[s._v("Android 属性系统入门")]),s._v(" "),a("li",[s._v("属性文件生成过程分析")]),s._v(" "),a("li",[s._v("如何添加系统属性 （本文）")]),s._v(" "),a("li",[s._v("属性与 Selinux")]),s._v(" "),a("li",[s._v("属性系统整体框架与启动过程分析")]),s._v(" "),a("li",[s._v("属性读写过程源码分析")])]),s._v(" "),a("p",[s._v("常见的自定义系统属性有三类：")]),s._v(" "),a("ul",[a("li",[s._v("添加系统属性到 /system/build.prop")]),s._v(" "),a("li",[s._v("添加系统属性到 /vendor/build.prop")]),s._v(" "),a("li",[s._v("添加系统属性到 /product/build.prop")])]),s._v(" "),a("h2",{attrs:{id:"添加系统属性到-system-build-prop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加系统属性到-system-build-prop"}},[s._v("#")]),s._v(" 添加系统属性到 /system/build.prop")]),s._v(" "),a("p",[s._v("我们先看看生成 "),a("code",[s._v("/system/build.prop")]),s._v(" 文件相关的部分源码：")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# build/make/core/Makefile")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ifdef")]),s._v(" TARGET_SYSTEM_PROP\nsystem_prop_file "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TARGET_SYSTEM_PROP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\nsystem_prop_file "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wildcard")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TARGET_DEVICE_DIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/system.prop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("endif")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("在上文我们分析过 system_prop_file 文件的内容最终会写入到 "),a("code",[s._v("/system/build.prop")]),s._v(" 中，"),a("code",[s._v("/system/build.prop")]),s._v(" 的值又来自 "),a("code",[s._v("TARGET_SYSTEM_PROP")]),s._v("，所以我们添加一个属性文件，再修改 "),a("code",[s._v("TARGET_SYSTEM_PROP")]),s._v(" 的值即可。")]),s._v(" "),a("p",[s._v("在我们的自定义 Product "),a("code",[s._v("device/jelly/rice14")]),s._v(" 目录下，添加一个 "),a("code",[s._v("system.prop")]),s._v(" 文件，文件的内容如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ro.rice14.test")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("接着在 "),a("code",[s._v("device/jelly/rice14/BoardConfig.mk")]),s._v(" 中添加：")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[s._v("TARGET_SYSTEM_PROP "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" device/jelly/rice14/system.prop\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后重新编译系统，启动模拟器：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" build/envsetup.sh\nlunch rice14-eng\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j16")]),s._v("\nemulator\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("启动虚拟机后，我们可以进入虚拟机终端查看属性值：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb shell\n\nrice14:/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# getprop ro.rice14.test                                     ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.0")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# end of device/jelly/rice14/system.prop")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("这里查询到了我们刚添加的属性。")]),s._v(" "),a("h2",{attrs:{id:"添加系统属性到-vendor-build-prop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加系统属性到-vendor-build-prop"}},[s._v("#")]),s._v(" 添加系统属性到 /vendor/build.prop")]),s._v(" "),a("p",[s._v("同样的，我们先看看生成 "),a("code",[s._v("/vendor/build.prop")]),s._v(" 文件相关的部分源码：")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ifdef")]),s._v(" property_overrides_split_enabled\nFINAL_VENDOR_BUILD_PROPERTIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" \\\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),s._v(" collapse-pairs, "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PRODUCT_PROPERTY_OVERRIDES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nFINAL_VENDOR_BUILD_PROPERTIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),s._v(" uniq-pairs-by-first-component, \\\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("FINAL_VENDOR_BUILD_PROPERTIES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(","),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("endif")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# property_overrides_split_enabled")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这里会把 "),a("code",[s._v("PRODUCT_PROPERTY_OVERRIDES")]),s._v(" 变量中的值赋值写入到 "),a("code",[s._v("FINAL_VENDOR_BUILD_PROPERTIES")]),s._v("，从变量名字就可以看出，这就是最终的 vendor 属性文件，所以我们通过修改 PRODUCT_PROPERTY_OVERRIDES 变量的值即可添加属性：")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# device/jelly/rice14/rice14.mk")]),s._v("\nPRODUCT_PROPERTY_OVERRIDES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" \\\n    ro.vendor.xxx"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xxx \\\n    ro.vendor.yyy"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yyy\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"添加系统属性到-product-build-prop"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加系统属性到-product-build-prop"}},[s._v("#")]),s._v(" 添加系统属性到 /product/build.prop")]),s._v(" "),a("p",[s._v("同样的，我们先看看生成 "),a("code",[s._v("/product/build.prop")]),s._v(" 文件相关的部分源码：")]),s._v(" "),a("div",{staticClass:"language-makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ifdef")]),s._v(" TARGET_PRODUCT_PROP\nproduct_prop_files "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TARGET_PRODUCT_PROP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\nproduct_prop_files "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wildcard")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TARGET_DEVICE_DIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/product.prop"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("endif")]),s._v("\n\nFINAL_PRODUCT_PROPERTIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" \\\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),s._v(" collapse-pairs, "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PRODUCT_PRODUCT_PROPERTIES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ADDITIONAL_PRODUCT_PROPERTIES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nFINAL_PRODUCT_PROPERTIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),s._v(" uniq-pairs-by-first-component, \\\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("FINAL_PRODUCT_PROPERTIES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(","),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("可以看到这里会把 "),a("code",[s._v("product_prop_files")]),s._v(" 文件和 "),a("code",[s._v("PRODUCT_PRODUCT_PROPERTIES")]),s._v(" 变量以及 "),a("code",[s._v("ADDITIONAL_PRODUCT_PROPERTIES")]),s._v(" 变量中的值都会写入到最终的属性文件中。")]),s._v(" "),a("p",[s._v("所以上两节介绍的两种方式都可以，这里我们演示先通过添加变量值的方式添加属性：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# device/jelly/rice14/rice14.mk")]),s._v("\nPRODUCT_PRODUCT_PROPERTIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ro.product.xxx")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xxx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ro.product.yyy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yyy\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);