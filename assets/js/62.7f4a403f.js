(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{486:function(s,a,n){"use strict";n.r(a);var t=n(2),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("iframe",{attrs:{src:"//player.bilibili.com/player.html?aid=825943689&bvid=BV12g4y157hw&cid=1123534102&page=1",scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"true"}}),s._v(" "),a("p",[s._v("AOSP 添加的可执行程序，可以分为两类：")]),s._v(" "),a("ul",[a("li",[s._v("C/C++ 可执行程序")]),s._v(" "),a("li",[s._v("Java 可执行程序")])]),s._v(" "),a("p",[s._v("在了解如何给 AOSP 添加可执行程序前，我们需要了解一下ARM + Android 行业流程与 Android 常用的四个分区：")]),s._v(" "),a("ul",[a("li",[s._v("System 分区")]),s._v(" "),a("li",[s._v("Vender 分区")]),s._v(" "),a("li",[s._v("Odm 分区")]),s._v(" "),a("li",[s._v("Product 分区")])]),s._v(" "),a("h2",{attrs:{id:"_1-arm-android-行业流程与-android-分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-arm-android-行业流程与-android-分区"}},[s._v("#")]),s._v(" 1. ARM + Android 行业流程与 Android 分区")]),s._v(" "),a("p",[s._v("ARM + Android 这个行业，一个简化的普遍流程：")]),s._v(" "),a("ol",[a("li",[s._v("Google 开发迭代 AOSP + Kernel")]),s._v(" "),a("li",[s._v("芯片厂商，针对自己的芯片特点，移植 AOSP 和 Kernel，使其可以在自己的芯片上跑起来。")]),s._v(" "),a("li",[s._v("方案厂商（很多芯片厂商也扮演了方案厂商的角色），设计电路板，给芯片添加外设，在芯片厂商源码基础上开发外设相关软件，主要是驱动和 hal，改进性能和稳定性。")]),s._v(" "),a("li",[s._v("产品厂商，主要是系统软件开发，UI 定制以及硬件上的定制(添加自己的外设)，改进性能和稳定性.")])]),s._v(" "),a("p",[s._v("Google 开发的通用 Android 系统组件编译后会被存放到 System 分区，原则上不同厂商、不同型号的设备都通用。")]),s._v(" "),a("p",[s._v("芯片厂商和方案厂商针对硬件相关的平台通用的可执行程序、库、系统服务和 app 等一般放到 Vender 分区。（开发的驱动程序是放在 boot 分区的 kernel 部分）")]),s._v(" "),a("p",[s._v("到了产品厂商这里，情况稍微复杂一点，通常针对同一套软硬件平台，可能会开发多个产品。比如：小米 12s，小米12s pro，小米12s ultra 均源于骁龙8+平台。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230705161951.png",alt:""}})]),s._v(" "),a("p",[s._v("每一个产品，我们称之为一个 Variant（变体）。")]),s._v(" "),a("p",[s._v("通常情况下，做产品的厂商在同一个硬件平台上针对不同的产品会从硬件和软件两个维度来做定制。")]),s._v(" "),a("p",[s._v("硬件上，产品 A 可能用的是京东方的屏，产品 B 可能用的是三星的屏；差异硬件相关的软件部分都会放在 Odm 分区。这样，产品 A 和产品 B 之间 Odm 以外的分区都是一样的，便于统一维护与升级。(硬件相关的软件共用部分放在 vendor 分区)")]),s._v(" "),a("p",[s._v("软件上，产品 A 可能是带广告的版本，产品 B 可能是不带广告的版本。这些有差异的软件部分都放在 Product 分区，这样产品 A 和产品 B 之间 Product 以外的分区都是一样的，便于统一维护与升级。(软件共用部分都放在 System分区)")]),s._v(" "),a("p",[s._v("总结一下，不同产品之间公共的部分放在 System 和 Vender 分区，差异的部分放在 Odm 和 Product 分区。")]),s._v(" "),a("h2",{attrs:{id:"_2-动手在系统源码中添加一个-c-c-可执行程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-动手在系统源码中添加一个-c-c-可执行程序"}},[s._v("#")]),s._v(" 2. 动手在系统源码中添加一个 C/C++ 可执行程序")]),s._v(" "),a("h3",{attrs:{id:"_2-1-源码添加"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-源码添加"}},[s._v("#")]),s._v(" 2.1 源码添加")]),s._v(" "),a("p",[s._v("我们先看看如何以源码的方式来添加一个可执行程序。")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("device/Jelly/Rice14")]),s._v(" 目录下创建如下的文件结构：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hello\n├── Android.bp\n└── hello.cpp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("其中 hello.cpp 的内容如下")]),s._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("<cstdio>")])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello Android\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("Android.bp是程序的编译配置文件，作用类似于 App 开发中的 gradle.build 文件，其格式为 json。Android.bp 的内容如下：")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("cc_binary "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//模块类型为可执行文件")]),s._v("\n    name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//模块名hello")]),s._v("\n    srcs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello.cpp"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//源文件列表")]),s._v("\n    cflags"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Werror"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//添加编译选项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("在 "),a("code",[s._v("device/Jelly/Rice14/Rice14.mk")]),s._v(" 中添加：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("PRODUCT_PACKAGES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" hello\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("接下来编译系统：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" build/envsetup.sh\nlunch Rice14-eng\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j16")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("你会发现报错了：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Offending entries:\nsystem/bin/helloworld\nbuild/make/core/main.mk:1414: error: Build failed.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("默认情况下，我们的模块会被安装到 System 分区，编译系统限制了我们在 System 分区添加东西，理论上来说， System 分区应该只能由 Google 来添加和修改内容。")]),s._v(" "),a("p",[s._v("这种错误一般都能搜到解决办法，通过搜索引擎我找到了 Android "),a("a",{attrs:{href:"https://groups.google.com/g/android-building/c/KE-Sfavd4Ds/m/GDqP5XGMAwAJ",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方论坛的回复"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("大概意思说，我们得改下编译系统的某个文件，具体咋改他也没说，要么就写到 product 分区。")]),s._v(" "),a("p",[s._v("如果现在的情况是，我就想把它预制到 system 分区，咋整？那我们就看看 google 自己是怎么干的。")]),s._v(" "),a("p",[s._v("首先思路梳理清楚：")]),s._v(" "),a("ul",[a("li",[s._v("找个原生系统中预制的 app，看下它的 Android.mk 或者 Android.bp")]),s._v(" "),a("li",[s._v("build/target 中搜一下这个 app 是怎么添加的")])]),s._v(" "),a("p",[s._v("app 一般定义在 packages/apps 中，我看下这个目录中的 Messaging，看下它的 Android.mk")]),s._v(" "),a("div",{staticClass:"language-Makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[s._v("LOCAL_PATH"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),s._v(" my-dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CLEAR_VARS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nLOCAL_MODULE_TAGS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" optional\n\nLOCAL_SRC_FILES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),s._v(" all-java-files-under, src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nLOCAL_RESOURCE_DIR "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LOCAL_PATH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/res\nLOCAL_USE_AAPT2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" true\n\nLOCAL_STATIC_ANDROID_LIBRARIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" \\\n    androidx.core_core \\\n    androidx.media_media \\\n    androidx.legacy_legacy-support-core-utils \\\n    androidx.legacy_legacy-support-core-ui \\\n    androidx.fragment_fragment \\\n    androidx.appcompat_appcompat \\\n    androidx.palette_palette \\\n    androidx.recyclerview_recyclerview \\\n    androidx.legacy_legacy-support-v13 \\\n    colorpicker \\\n    libchips \\\n    libphotoviewer\n\nLOCAL_STATIC_JAVA_LIBRARIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" \\\n    androidx.annotation_annotation \\\n    android-common \\\n    android-common-framesequence \\\n    com.android.vcard \\\n    guava \\\n    libphonenumber\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LOCAL_PATH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("/version.mk\n\nLOCAL_AAPT_FLAGS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" --version-name "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$(version_name_package)"')]),s._v("\nLOCAL_AAPT_FLAGS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" --version-code "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("version_code_package"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ifdef")]),s._v(" TARGET_BUILD_APPS\n    LOCAL_JNI_SHARED_LIBRARIES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" libframesequence libgiftranscode\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    LOCAL_REQUIRED_MODULES"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" libframesequence libgiftranscode\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("endif")]),s._v("\n\nLOCAL_PROGUARD_ENABLED "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" obfuscation optimization\n\nLOCAL_PROGUARD_FLAG_FILES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" proguard.flags\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ifeq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eng,"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TARGET_BUILD_VARIANT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    LOCAL_PROGUARD_FLAG_FILES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" proguard-test.flags\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    LOCAL_PROGUARD_FLAG_FILES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" proguard-release.flags\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("endif")]),s._v("\n\nLOCAL_PACKAGE_NAME "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" messaging\n\nLOCAL_CERTIFICATE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" platform\n\nLOCAL_SDK_VERSION "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" current\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BUILD_PACKAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),s._v(" all-makefiles-under, "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LOCAL_PATH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br")])]),a("p",[s._v("没什么特别的，对我们有用的信息就是模块名是 messaging，那打包出来的 apk 名就叫 messaging.apk")]),s._v(" "),a("p",[s._v("我们接着在 build/target 目录下搜一下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"messaging.apk"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n./product/gsi_common.mk:    system/app/messaging/messaging.apk "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("看看 "),a("code",[s._v("gsi_common.mk")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-Makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[s._v("PRODUCT_ARTIFACT_PATH_REQUIREMENT_WHITELIST "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" \\\n    system/app/messaging/messaging.apk \\\n    system/app/WAPPushManager/WAPPushManager.apk \\\n    system/bin/healthd \\\n    system/etc/init/healthd.rc \\\n    system/etc/seccomp_policy/crash_dump.%.policy \\\n    system/etc/seccomp_policy/mediacodec.policy \\\n    system/etc/vintf/manifest/manifest_healthd.xml \\\n    system/lib/libframesequence.so \\\n    system/lib/libgiftranscode.so \\\n    system/lib64/libframesequence.so \\\n    system/lib64/libgiftranscode.so \\\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("答案就出来了，我们需要添加到 System 的模块，添加到 PRODUCT_ARTIFACT_PATH_REQUIREMENT_WHITELIST 变量即可。")]),s._v(" "),a("p",[s._v("修改 device/Jelly/Rice14/Rice14.mk，添加以下内容 ：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("PRODUCT_ARTIFACT_PATH_REQUIREMENT_WHITELIST += \\\n    system/bin/helloworld \\\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("再次编译执行即可。")]),s._v(" "),a("p",[s._v("以上的方法是可行的，但是是不推荐的，对于软件相关的定制，我们应该安装"),a("a",{attrs:{href:"https://groups.google.com/g/android-building/c/KE-Sfavd4Ds/m/GDqP5XGMAwAJ",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方论坛的回复"),a("OutboundLink")],1),s._v("的要求将其放到 product 分区。")]),s._v(" "),a("p",[s._v("要把 helloworld 模块放到 product 分区也很简单，在其 Android.bp 中添加 product_specific: true 即可：")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("cc_binary "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//模块类型为可执行文件")]),s._v("\n    name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"helloworld"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//模块名hellobp")]),s._v("\n    srcs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"helloworld.cpp"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//源文件列表")]),s._v("\n    product_specific"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//编译出来放在/product目录下(默认是放在/system目录下)")]),s._v("\n    cflags"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-Werror"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//添加编译选项")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("再删除 device/Jelly/Rice14/Rice14.mk 中的以下内容 ：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("PRODUCT_ARTIFACT_PATH_REQUIREMENT_WHITELIST += \\\n    system/bin/helloworld \\\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("再次编译执行即可。")]),s._v(" "),a("p",[s._v("这里给出一个安装位置配置的总结：")]),s._v(" "),a("ul",[a("li",[s._v("System 分区\n"),a("ul",[a("li",[s._v("Android.mk 默认就是输出到 system 分区，不用指定")]),s._v(" "),a("li",[s._v("Android.bp 默认就是输出到 system 分区，不用指定")])])]),s._v(" "),a("li",[s._v("Vendor\n"),a("ul",[a("li",[s._v("Android.mk LOCAL_VENDOR_MODULE := true")]),s._v(" "),a("li",[s._v("Android.bp vendor: true")])])]),s._v(" "),a("li",[s._v("Odm 分区\n"),a("ul",[a("li",[s._v("Android.mk LOCAL_ODM_MODULE := true")]),s._v(" "),a("li",[s._v("Android.bp device_specific: true")])])]),s._v(" "),a("li",[s._v("product 分区\n"),a("ul",[a("li",[s._v("Android.mk LOCAL_PRODUCT_MODULE := true")]),s._v(" "),a("li",[s._v("Android.bp product_specific: true")])])])]),s._v(" "),a("h3",{attrs:{id:"_2-2-可执行文件添加"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-可执行文件添加"}},[s._v("#")]),s._v(" 2.2 可执行文件添加")]),s._v(" "),a("p",[s._v("有的时候，我们需要添加到系统的程序只有编译好的可执行文件，没有源码。接下来我们看看如何在系统源码中添加一个可执行文件：")]),s._v(" "),a("p",[s._v("BusyBox 是打包为单个二进制文件的核心 Unix 实用程序的集合。常用于嵌入式设备。")]),s._v(" "),a("p",[s._v("适用于 x86 架构的 busybox 可通过以下命令下载：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://busybox.net/downloads/binaries/1.30.0-i686/busybox\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("接下来我们把它添加到我们的 aosp 中：")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("device/Jelly/Rice14/")]),s._v(" 目录下创建如下的目录结构：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("prebuilt/\n└── busybox\n    ├── Android.bp\n    └── busybox\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("busybox 就是我们之前的下载的文件。")]),s._v(" "),a("p",[s._v("其中 Android.bp 的内容如下：")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("cc_prebuilt_binary "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"busybox"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    srcs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"busybox"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    product_specific"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("接下来在 "),a("code",[s._v("device/Jelly/Rice14/Rice14.mk")]),s._v(" 中添加该模块")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("PRODUCT_PACKAGES += busybox\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("编译源代码，启动模拟器：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" build/envsetup.sh\nlunch Rice14-eng\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j16")]),s._v("\nemulator\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("进入 adb shell，执行 busybox 命令")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb shell\nbusybox\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230705162014.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"_3-添加-java-可执行程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-添加-java-可执行程序"}},[s._v("#")]),s._v(" 3. 添加 Java 可执行程序")]),s._v(" "),a("h3",{attrs:{id:"_3-1-源码添加"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-源码添加"}},[s._v("#")]),s._v(" 3.1 源码添加")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("device/Jelly/Rice14/")]),s._v(" 目录下创建以下的目录和文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hellojava\n├── Android.bp\n└── com\n    └── ahaoyuandaima\n        └── main\n            └── HelloJava.java\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("其中 Android.bp 的内容如下：")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("java_library "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hellojava"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    installable"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    product_specific"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    srcs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"**/*.java"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    sdk_version"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"current"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("这里着重解释一下 installable 这个选项，如果不指定 installable: true, 则编译出来的 jar 包里面是 .class 文件。这种包是没法安装到系统上的，只能给其他 java 模块作为 static_libs 依赖。")]),s._v(" "),a("p",[s._v("指定 installable: true, 则编译出来的 jar 包里面是 classes.dex 文件。这种才是 Android 虚拟机可以加载的格式。")]),s._v(" "),a("p",[s._v("HelloJava.java 内容如下：")]),s._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[s._v("package com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ahaoyuandaima"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HelloJava")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tSystem"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello Java"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("接着在 "),a("code",[s._v("device/Jelly/Rice14/Rice14.mk")]),s._v(" 中添加：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("PRODUCT_PACKAGES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    hellojava\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("接下来编译系统：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" build/envsetup.sh\nlunch Rice14-eng\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j16")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("编译完成启动虚拟机后，进入 adb shell 执行程序：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入模拟器shell")]),s._v("\nadb shell\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 classpath")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CLASSPATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/product/framework/hellojava.jar \napp_process /product/framework/ com.ahaoyuandaima.main.HelloJava\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("执行结果如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230705162025.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"_3-2-可执行-jar-包添加"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-可执行-jar-包添加"}},[s._v("#")]),s._v(" 3.2 可执行 jar 包添加")]),s._v(" "),a("p",[s._v("有的时候我们可能需要在源码中添加别人编译好的可执行 jar 包，接着我们看看具体怎么操作：")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("device/Jelly/Rice14/")]),s._v(" 目录下创建以下的目录和文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("hellojavajar\n├── Android.bp\n└── hellojava.jar\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("其中 hellojava.jar，是从 "),a("code",[s._v("out/target/product/Rice14/system/product/framework/hellojava.jar")]),s._v(" 移动过来的。")]),s._v(" "),a("p",[s._v("Android.bp 的内容如下：")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[s._v("java_import "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hellojavajar"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    installable"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    jars"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hellojava.jar"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    product_specific"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("   \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("为了避免冲突，我们把 hellojava 文件夹删除。在 "),a("code",[s._v("device/Jelly/Rice14/Rice14.mk")]),s._v(" 中删除已添加的 hellojava 模块。并重新添加 javahellojar 模块")]),s._v(" "),a("div",{staticClass:"language-Makefile line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-makefile"}},[a("code",[s._v("PRODUCT_PACKAGES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" \\\n    hellojavajar\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("接下来编译系统：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" build/envsetup.sh\nlunch Rice14-eng\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j16")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("编译完成启动虚拟机后，进入 adb shell 执行程序：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入模拟器shell")]),s._v("\nadb shell\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 classpath")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CLASSPATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/product/framework/hellojavajar.jar\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行可执行程序 ")]),s._v("\napp_process /product/framework/ com.ahaoyuandaima.main.HelloJava\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("本文主要讲解了如何将")]),s._v(" "),a("ul",[a("li",[s._v("C/C++ 可执行程序源码")]),s._v(" "),a("li",[s._v("Java 可执行程序源码")])]),s._v(" "),a("p",[s._v("两类模块添加到源码中，以实际操作为主，同学们可以自己实践体验。")]),s._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://qiushao.net/2019/11/22/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/4-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Android系统开发入门-4.添加自定义模块"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/ldswfun/article/details/120834205?spm=1001.2014.3001.5502",target:"_blank",rel:"noopener noreferrer"}},[s._v("Android 10 根文件系统和编译系统(十九)：Android.bp各种模块编译规则"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://ci.android.com/builds/submitted/9155974/linux/latest/view/soong_build.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Soong Modules Reference"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/tkwxty/article/details/105142182",target:"_blank",rel:"noopener noreferrer"}},[s._v("Android.bp编译提示ninja: error: unknown target ‘MODULES-IN-xxx‘终极指南"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/lineageos4microg/android_vendor_partner_gms/issues/5",target:"_blank",rel:"noopener noreferrer"}},[s._v("Failing builds for Lineage-19.0 due to artifact path requirement"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://source.android.google.cn/docs/security/selinux/customize?hl=zh-cn",target:"_blank",rel:"noopener noreferrer"}},[s._v("自定义 SELinux"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://maoao530.github.io/2017/01/31/android-build-sign/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Android系统build阶段签名机制"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/zhonglunshun/articdetails/70256727",target:"_blank",rel:"noopener noreferrer"}},[s._v("android系统源码中添加app源码（源码部署移植"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"关于"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于"}},[s._v("#")]),s._v(" 关于")]),s._v(" "),a("p",[s._v("我叫阿豪，2015 年本科毕业于国防科学技术大学指挥信息系统专业，毕业后从事信息化装备的研发工作，主要研究方向是 Android Framework 与 Linux Kernel。")]),s._v(" "),a("p",[s._v("如果你对 Android Framework 感兴趣或者正在学习 Android Framework，可以关注我的微信公众号和抖音，我会持续分享我的学习经验，帮助正在学习的你少走一些弯路。学习过程中如果你有疑问或者你的经验想要分享给大家可以添加我的微信，我拉你进技术交流群。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg",alt:""}})])])}),[],!1,null,null,null);a.default=e.exports}}]);