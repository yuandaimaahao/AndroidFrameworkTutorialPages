<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Android Binder 驱动情景分析之服务注册过程 | Android Framework</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css" as="style"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/app.a5dad8b6.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/81.fec13824.js" as="script"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/10.337b766a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/100.1af765a2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/101.e96f0d69.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/102.b4e844a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/103.7fd8b73f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/104.3027cd01.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/105.1d287f51.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/106.775741ca.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/107.3c18da36.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/108.bc5b9d09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/109.6d0bfeff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/11.be2e0167.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/110.fb6f0c28.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/111.16370887.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/112.c7849d37.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/113.2ad757fa.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/114.8e71b0e4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/115.8ff602ee.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/116.43fbb597.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/117.0f8b1a2b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/118.4f51c7fd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/119.dc4ce472.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/120.0c35e50f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/121.d6ce64e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/122.afb666c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/123.a78c9f32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/124.cda8de32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/125.24ec5bd0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/126.69e9053c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/127.7c1ca90f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/128.35da468e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/129.0add3757.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/130.bd1f91fa.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/131.fe641bce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/132.2aee8a67.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/133.02c0e89d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/134.5e724532.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/135.b1c2411f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/136.844acb24.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/137.b9fa8a82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/138.78b4a9d7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/139.bb0caf5b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/14.7d944ea8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/140.c24c1c08.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/141.397612b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/142.c21a8fa4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/143.47e3beb6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/144.8d4b76d0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/145.5e7bedeb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/146.90e8ff0b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/147.0c73c160.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/148.613f0013.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/149.c72f81b8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/15.bf19b574.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/150.82fbb5a7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/151.339a1276.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/152.62bc0603.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/153.d4db757f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/154.7a80eb2c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/155.46d6d977.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/156.f032bb76.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/157.34314806.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/158.92790a71.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/159.a2d23ebb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/16.91ebb564.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/160.0179cfaf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/161.e9960d05.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/162.456e6e1b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/163.245efdf2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/164.33654df0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/165.d2f7f7bf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/166.b00be4c6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/167.2e76ebcc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/168.cc793aa2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/169.4233d468.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/17.bfe50ee3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/170.154bf18a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/171.9a47af6a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/172.2df208f4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/173.db64d3bc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/174.76ed09e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/18.05ccfb53.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/19.afa41ba1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/20.e9510ad7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/21.86ad6466.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/22.09086018.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/23.62e146ab.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/24.36df6bff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/25.99201ee4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/26.0dad3cd4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/27.be36597a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/28.4a19ff25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/29.5c2b113e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/3.97bbbdc8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/30.38a9b8bb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/31.0d5a08c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/32.804ecc25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/33.a8e71e21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/34.da185bf8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/35.e45072d9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/36.b81c8de2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/37.f26d2d52.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/38.057aa3b4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/39.8de59f74.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/4.983d15c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/40.b47d4570.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/41.516c396f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/42.b405090a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/43.4f3cf1ea.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/44.9020abbc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/45.76ee68b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/46.24ca3ec6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/47.ce306e3f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/48.594e18b2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/49.1ac45e0a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/5.574f6fbb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/50.5cf1e47d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/51.037e5442.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/52.141d9248.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/53.6b1fbef2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/54.e55084df.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/55.9e651b61.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/56.ac520841.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/57.63b15773.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/58.9810e4ec.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/59.61908f2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/6.a4122f72.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/60.a8c87ab2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/61.5f078d82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/62.7f4a403f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/63.8c484ea1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/64.cc875fce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/65.82180ec7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/66.2eb988a8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/67.6bdd390f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/68.c83deb44.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/69.add77acc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/70.25f6b2ba.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/71.e5e79631.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/72.d0b4c7a1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/73.914aa049.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/74.731ff6ad.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/75.41ae114b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/76.3707b690.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/77.57d6d63d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/78.32d3f538.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/79.86fe3a2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/8.9d6eb8a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/80.c048f8e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/82.ef5208fd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/83.ca729155.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/84.a8042c7e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/85.1b1e7f09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/86.702f2cd5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/87.7a90d741.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/88.8da58920.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/89.72be0795.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/9.bee9eff5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/90.34ba496d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/91.90e76ecb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/92.e6126fdf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/93.d83bc007.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/94.c2341ec2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/95.9f2d2ece.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/96.1e7ed15a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/97.fb305dd8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/98.50e603c5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/99.72017f6d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/vendors~docsearch.833ce4c0.js">
    <link rel="stylesheet" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Android Framework</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AndroidFrameworkTutorialPages/" class="home-link router-link-active"><!----> <span class="site-name">Android Framework</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>130</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <!----> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习路线与指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>玩转AOSP篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>学穿Binder篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/000.Binder 专题导学 —— 如何深入掌握 Binder.html" class="sidebar-link">1.专题导学 —— 如何深入掌握 Binder</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/001.学习 Binder 的预备知识.html" class="sidebar-link">2.学习 Binder 的预备知识</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/002.Binder 基本原理.html" class="sidebar-link">3.Binder 基本原理</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/003.Binder 程序示例之C语言篇.html" class="sidebar-link">4.Binder 程序示例之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/004.Binder 服务注册过程情景分析之C语言篇.html" class="sidebar-link">5.Binder 服务注册过程情景分析之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/005.Binder 服务获取与使用过程情景分析之C语言篇.html" class="sidebar-link">6.Binder 服务获取与使用过程情景分析之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/006.Android Binder 驱动框架设计分析.html" class="sidebar-link">7.Android Binder 驱动框架设计分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/007.Binder 驱动情景分析之 ServiceManager 启动过程.html" class="sidebar-link">8.Binder 驱动情景分析之 ServiceManager 启动过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/008.Binder 驱动情景分析之服务注册过程.html" class="active sidebar-link">9.Binder 驱动情景分析之服务注册过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/009.Binder 驱动情景分析之服务获取与使用过程.html" class="sidebar-link">10.Binder 驱动情景分析之服务获取与使用过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/010.Binder 程序示例之C++篇.html" class="sidebar-link">11.Binder 程序示例之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/011.Binder C++ 程序分析之主要类解析.html" class="sidebar-link">12.Binder C++ 程序分析之主要类解析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/012.Binder 服务注册过程情景分析之C++篇.html" class="sidebar-link">13.Binder 服务注册过程情景分析之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/013.Binder 服务获取与使用过程情景分析之C++篇.html" class="sidebar-link">14.Binder 服务获取与使用过程情景分析之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/014.Binder 程序示例之 aidl-cpp 篇.html" class="sidebar-link">15.Binder 程序示例之 aidl-cpp 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/015.添加 Native 系统服务.html" class="sidebar-link">16.添加 Native 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/016.添加 Native 系统服务回调.html" class="sidebar-link">17.添加 Native 系统服务回调</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/017.Binder 程序示例之 Java 篇.html" class="sidebar-link">18.Binder 程序示例之 Java 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/018.Binder Java 层初始化.html" class="sidebar-link">19.Binder Java 层初始化</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/019.Binder Java 层服务注册过程分析.html" class="sidebar-link">20.Binder Java 层服务注册过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/020.Binder Java 层服务获取与使用过程分析.html" class="sidebar-link">21.Binder Java 层服务获取与使用过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/021.添加 Java 系统服务.html" class="sidebar-link">22.添加 Java 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/022.Android Java 系统服务框架与第三方 App 使用自定义 Java 系统服务.html" class="sidebar-link">23.Android Java 系统服务框架与第三方 App 使用自定义 Java 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/023.添加 Java 系统服务回调.html" class="sidebar-link">24.添加 Java 系统服务回调</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/024.AIDL 数据类型详解之 Java 篇.html" class="sidebar-link">25.AIDL 数据类型详解之 Java 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/025.AIDL 数据类型详解之 C++ 篇.html" class="sidebar-link">26.AIDL 数据类型详解之 C++ 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/026.Java 调用 Native 服务.html" class="sidebar-link">27.Java 调用 Native 服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/027.Native 调用 Java 服务.html" class="sidebar-link">28.Native 调用 Java 服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/028.AIDL 关键字 in out inout oneway 解析.html" class="sidebar-link">29.AIDL 关键字 in out inout oneway 解析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/029.Binder 驱动 Debug 入门指南.html" class="sidebar-link">30.Binder 驱动 Debug 入门指南</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/030.Binder 匿名服务源码分析.html" class="sidebar-link">031.Binder 匿名服务源码分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/031.Binder 中的 Parcel 数据结构分析（C++）.html" class="sidebar-link">032.Binder 中的 Parcel 数据结构分析（C++）</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/032.Binder 中的 Parcel 数据结构分析（Java）.html" class="sidebar-link">033.Binder 中的 Parcel 数据结构分析（Java）</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/033.Binder 多线程情景分析.html" class="sidebar-link">034.Binder 多线程情景分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/034.Binder 线程池溢出问题.html" class="sidebar-link">035.Binder 线程池溢出问题</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/035.Binder 代理对象泄露问题分析.html" class="sidebar-link">036.Binder 代理对象泄露问题分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/036.Binder 死亡通知情景分析.html" class="sidebar-link">037.Binder 死亡通知情景分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/037.Binder 异常处理机制.html" class="sidebar-link">038.Binder 异常处理机制</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/039.Binder 面试题汇总.html" class="sidebar-link">039.Binder 面试题汇总</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础组件篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统启动篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>应用层框架篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hal 与硬件服务篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图形系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>输入系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统应用篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>构造系统篇</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Android Binder 驱动情景分析之服务注册过程</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">Android Binder 驱动情景分析之服务注册过程</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>阿豪</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/20/2023</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/AndroidFrameworkTutorialPages/003.%E5%AD%A6%E7%A9%BFBinder%E7%AF%87/008.Binder%20%E9%A9%B1%E5%8A%A8%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90%E4%B9%8B%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><p>本文系统源码版本：</p> <ul><li>AOSP 分支：android-10.0.0_r41</li> <li>Kernel 分支：android-goldfish-4.14-gchips</li></ul> <p>本文依托于<a href="https://yuandaimaahao.github.io/AndroidFrameworkTutorialPages/003.%E5%AD%A6%E7%A9%BFBinder%E7%AF%87/003.%20Binder%20%E7%A8%8B%E5%BA%8F%E7%A4%BA%E4%BE%8B%E4%B9%8BC%E8%AF%AD%E8%A8%80%E7%AF%87.html" target="_blank" rel="noopener noreferrer">Binder 程序示例之 C 语言篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中介绍的应用层示例程序来对驱动的实现做情景化分析。</p> <p>上文说到，ServiceManager 进入循环，开始读数据后，就进入休眠状态，直到有其他进程写入数据并唤醒他为止。接下来我们就来看看 ServiceManager 是怎么被 Server 端唤醒的。</p> <h2 id="_1-server-主函数"><a href="#_1-server-主函数" class="header-anchor">#</a> 1. Server 主函数</h2> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> svcmgr <span class="token operator">=</span> BINDER_SERVICE_MANAGER<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> handle<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
  
    <span class="token comment">//Binder 初始化</span>
    bs <span class="token operator">=</span> <span class="token function">binder_open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/binder&quot;</span><span class="token punctuation">,</span> 
	<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to open binder driver\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//svcmgr 的值是 0，表示发送信息给 servicemanager</span>
	<span class="token comment">//注册服务</span>
	ret <span class="token operator">=</span> <span class="token function">svcmgr_publish</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> svcmgr<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> hello_service_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to publish hello service\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//进入 loop， 等待 client 请求服务</span>
    <span class="token function">binder_loop</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> test_server_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>Server 端发起服务注册请求的流程如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230725220409.png" alt=""></p> <h2 id="_2-binder-open"><a href="#_2-binder-open" class="header-anchor">#</a> 2. binder_open</h2> <p>binder_open 的调用流程与 ServiceManager 一致，这里不再重复，总结一下就是：binder_open 主要是初始化了一个 binder_proc 结构体，并插入到全局的链表 procs 中了。</p> <h2 id="_3-svcmgr-publish-实现分析"><a href="#_3-svcmgr-publish-实现分析" class="header-anchor">#</a> 3. svcmgr_publish 实现分析</h2> <p>svcmgr_publish 用于发布一个服务,其具体实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">svcmgr_publish</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> iodata<span class="token punctuation">[</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">,</span> reply<span class="token punctuation">;</span>
    <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> iodata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iodata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// strict mode header</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//SVC_MGR_NAME 值为 &quot;android.os.IServiceManager&quot;</span>
    <span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> SVC_MGR_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//name 的值是 hello</span>
    <span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ptr 是一个函数指针指向 hello_service_handler </span>
    <span class="token function">bio_put_obj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//通过 binder_call 发起远程函数调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_call</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> target<span class="token punctuation">,</span> SVC_MGR_ADD_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//fprintf(stderr, &quot;svcmgr_public 远程调用失败\n&quot;);</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">//解析返回值</span>
    status <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用成功返回0</span>
    <span class="token comment">//远程调用结束，通知驱动清理内存</span>
    <span class="token function">binder_done</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>svcmgr_publish 工作流程如下：</p> <ul><li>通过 binder_io 构造需要发送的数据 msg</li> <li>通过 binder_call 发起远程调用</li> <li>解析回复的数据，通过 binder_done 函数通知驱动通信完成,清理内存</li></ul> <p>接下来我们深入到内核一一分析这三个阶段：</p> <h3 id="_3-1-通过-binder-io-构造需要发送的数据-msg"><a href="#_3-1-通过-binder-io-构造需要发送的数据-msg" class="header-anchor">#</a> 3.1 通过 binder_io 构造需要发送的数据 msg</h3> <p>binder_io 可以理解为一个数据集合，数据发送端将数据按照一定的顺序写入集合，数据接受端按照相同的顺序读取数据。</p> <p>svcmgr_publish 中使用如下代码构建了一个 binder_io 结构体：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> iodata<span class="token punctuation">[</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">,</span> reply<span class="token punctuation">;</span>
<span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> iodata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iodata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// strict mode header</span>
<span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//SVC_MGR_NAME 值为 &quot;android.os.IServiceManager&quot;</span>
<span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> SVC_MGR_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//name 的值是 hello</span>
<span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//ptr 是一个函数指针指向 hello_service_handler </span>
<span class="token function">bio_put_obj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>接下来我们看看 binder_io 的具体定义：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">binder_io</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>            <span class="token comment">/* pointer to read/write from */</span>
    <span class="token class-name">binder_size_t</span> <span class="token operator">*</span>offs<span class="token punctuation">;</span>   <span class="token comment">/* array of offsets */</span>
    <span class="token class-name">size_t</span> data_avail<span class="token punctuation">;</span>     <span class="token comment">/* bytes available in data buffer */</span>
    <span class="token class-name">size_t</span> offs_avail<span class="token punctuation">;</span>     <span class="token comment">/* entries available in offsets array */</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>data0<span class="token punctuation">;</span>           <span class="token comment">/* start of data buffer */</span>
    <span class="token class-name">binder_size_t</span> <span class="token operator">*</span>offs0<span class="token punctuation">;</span>  <span class="token comment">/* start of offsets buffer */</span>
    <span class="token class-name">uint32_t</span> flags<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> unused<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>binder_io 的初始化过程：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//初始化过程</span>
<span class="token keyword">unsigned</span> iodata<span class="token punctuation">[</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">;</span>
<span class="token comment">//初始化 binder_io </span>
<span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> iodata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iodata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>
              <span class="token class-name">size_t</span> maxdata<span class="token punctuation">,</span> <span class="token class-name">size_t</span> maxoffs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> n <span class="token operator">=</span> maxoffs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//溢出处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> maxdata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bio<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> BIO_F_OVERFLOW<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data_avail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>offs_avail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将 bio 一分为二</span>
    bio<span class="token operator">-&gt;</span>data <span class="token operator">=</span> bio<span class="token operator">-&gt;</span>data0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data <span class="token operator">+</span> n<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>offs <span class="token operator">=</span> bio<span class="token operator">-&gt;</span>offs0 <span class="token operator">=</span> data<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>data_avail <span class="token operator">=</span> maxdata <span class="token operator">-</span> n<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>offs_avail <span class="token operator">=</span> maxoffs<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>从 binder_io 的定义和初始化过程中可以看出，binder_io 用于管理一块内存，同时将内存分为了两部分管理：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230725220428.png" alt=""></p> <p>为方便叙述，本文称这两个区为偏移区和数据区。</p> <p>maxdata 是这块内存总的字节数，偏移区的大小为 n 字节，其中 n = maxoffs * sizeof(size_t)，数据区的大小为 maxdata - n</p> <p>两块内存如何使用？</p> <p>接下来我们看看如何将一个 unit32_t 数据存入 binder_io：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//分配内存</span>
    <span class="token class-name">uint32_t</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">bio_alloc</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
        <span class="token operator">*</span>ptr <span class="token operator">=</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//在 binder_io 的第二部分分配 size 大小的内存</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">bio_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    <span class="token comment">//size 最终等于 4,8,12,16,20 ......</span>
    <span class="token comment">//size 的值比原始的值大</span>
    size <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//溢出操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> bio<span class="token operator">-&gt;</span>data_avail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bio<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> BIO_F_OVERFLOW<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//分配位置</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> bio<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data_avail <span class="token operator">-=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>写入一个 32 位整数的过程如下：</p> <ul><li>在数据区分配 4 字节倍数的数据</li> <li>将整数值写入已分配的内存</li></ul> <p>写入后一个 <code>uint32_t n</code> 后，内存结构如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230725220438.png" alt=""></p> <p>字符串的写入稍微复杂一点，但是本质原理和写入 unit_32 相同，有兴趣的同学可以自行分析下面的代码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>_str<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> _str<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    
    <span class="token comment">//写入一个标记位</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>MAX_BIO_SIZE <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Note: The payload will carry 32bit size instead of size_t */</span>
    <span class="token comment">//写入字符串长度</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//写入字符串内容</span>
    ptr <span class="token operator">=</span> <span class="token function">bio_alloc</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptr<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
        <span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>接下来我们看看，如何在 binder_io 中存一个指针数据。（在服务注册场景下，这个指针指向一个函数，是 server 端收到调用后的回调函数）</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">bio_put_obj</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>obj<span class="token punctuation">;</span>

    <span class="token comment">//分配内存</span>
    obj <span class="token operator">=</span> <span class="token function">bio_alloc_obj</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    obj<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0x7f</span> <span class="token operator">|</span> FLAT_BINDER_FLAG_ACCEPTS_FDS<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>hdr<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_TYPE_BINDER<span class="token punctuation">;</span>
    <span class="token comment">//ptr 保存在 flat_binder_object 的 binder 成员中</span>
    obj<span class="token operator">-&gt;</span>binder <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>ptr<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span><span class="token function">bio_alloc_obj</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>obj<span class="token punctuation">;</span>
    <span class="token comment">//在数据区分配内存</span>
    obj <span class="token operator">=</span> <span class="token function">bio_alloc</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//在第一部分保存偏移量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">&amp;&amp;</span> bio<span class="token operator">-&gt;</span>offs_avail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bio<span class="token operator">-&gt;</span>offs_avail<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token comment">//保存 flat_binder_object 结构在偏移区的偏移值</span>
        <span class="token operator">*</span>bio<span class="token operator">-&gt;</span>offs<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> bio<span class="token operator">-&gt;</span>data0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    bio<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> BIO_F_OVERFLOW<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span>	hdr<span class="token punctuation">;</span>
	__u32				flags<span class="token punctuation">;</span>

	<span class="token comment">/* 8 bytes of data. */</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token class-name">binder_uintptr_t</span>	binder<span class="token punctuation">;</span>	<span class="token comment">/* local object */</span>
		__u32			handle<span class="token punctuation">;</span>	<span class="token comment">/* remote object */</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">/* extra data associated with local object */</span>
	<span class="token class-name">binder_uintptr_t</span>	cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span> <span class="token punctuation">{</span>
	__u32        type<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token punctuation">{</span>
    <span class="token comment">//hdr.type = BINDER_TYPE_BINDER</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span>	hdr<span class="token punctuation">;</span>
    <span class="token comment">//flags = 0x7f | FLAT_BINDER_FLAG_ACCEPTS_FDS;</span>
	__u32				flags<span class="token punctuation">;</span>

	<span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token comment">//binder = (uintptr_t)ptr</span>
        <span class="token comment">//ptr 就是传入的函数指针  hello_service_handler</span>
		<span class="token class-name">binder_uintptr_t</span>	binder<span class="token punctuation">;</span>	
		__u32			handle<span class="token punctuation">;</span>	
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//cookie = 0</span>
	<span class="token class-name">binder_uintptr_t</span>	cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>对于指针类型，会在数据区分配一个 flat_binder_object 结构体的数据，将指针数据保存在结构体的 binder 成员中。在偏移区将 flat_binder_object 相对 data0 的偏移值保存在 offs 指向的内存，offs 再加 1。完成数据保存后，其内存结构如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230725220452.png" alt=""></p> <p>通过上面的分析我们可以画出 svcmgr_publish 中构建的 binder_io 的结构：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230725220500.png" alt=""></p> <h3 id="_3-2-通过-binder-call-发起远程调用"><a href="#_3-2-通过-binder-call-发起远程调用" class="header-anchor">#</a> 3.2 通过 binder_call 发起远程调用</h3> <p>构造好 binder_io 以后，接着就通过 binder_call 发起远程过程调用：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// target 的值为 0 ，用于指示数据发送给哪个进程</span>
<span class="token comment">// msg 就是我们上面构造的数据结构</span>
<span class="token comment">// SVC_MGR_ADD_SERVICE 用于指示需要调用的远程函数</span>
<span class="token function">binder_call</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> target<span class="token punctuation">,</span>SVC_MGR_ADD_SERVICE<span class="token punctuation">)</span>

<span class="token keyword">int</span> <span class="token function">binder_call</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>

    <span class="token comment">//关注点1 binder_io *msg 转为 binder_write_read</span>
    <span class="token comment">//声明数据</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>

    <span class="token comment">//binder_write_read 内部成员 write_buffer 的结构</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> writebuf<span class="token punctuation">;</span>
  
    <span class="token keyword">unsigned</span> readbuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//...... 省略非核心代码</span>

    <span class="token comment">//构造 binder_write_read 内部结构 writebuf</span>
    <span class="token comment">// BC_TRANSACTION 表示当前数据是用于发起远程调用</span>
    writebuf<span class="token punctuation">.</span>cmd <span class="token operator">=</span> BC_TRANSACTION<span class="token punctuation">;</span>
    <span class="token comment">// target 用于找到远程进程，即我们要调用哪个进程的函数</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>target<span class="token punctuation">.</span>handle <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token comment">// code 表示调用哪个函数</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>data <span class="token operator">-</span> msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> msg<span class="token operator">-&gt;</span>offs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> msg<span class="token operator">-&gt;</span>offs0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// data 是数据区，指向一个 binder_io 结构体</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>msg<span class="token operator">-&gt;</span>offs0<span class="token punctuation">;</span>

    <span class="token comment">//给 write 相关变量赋值</span>
    <span class="token comment">//表示当前进程是写入数据，即发送数据</span>
    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>writebuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>writebuf<span class="token punctuation">;</span>

    <span class="token function">hexdump</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>data <span class="token operator">-</span> msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//关注点2 写的同时也要读数据</span>
        <span class="token comment">//给 read 相关变量赋值</span>
        <span class="token comment">//同时，我们也要读取返回的结果值</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>

        <span class="token comment">//关注点3 发起读写操作</span>
        <span class="token comment">//发送 binder_write_read 数据</span>
        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//省略部分代码 ......</span>
    <span class="token punctuation">}</span>

fail<span class="token operator">:</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>reply<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reply<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> BIO_F_IOERROR<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p>首先构建好需要发送的数据，其格式如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230725220511.png" alt=""></p> <p>接着调用：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>软中断陷入内核，经过 vfs 的处理后，最终会调用到 binder 驱动的 binder_ioctl 函数：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">binder_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ubuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

    <span class="token comment">//获得当前进程的 binder_thread 结构体</span>
    <span class="token comment">//没有就新建一个，并插入 binder_proc 的 threads 链表中</span>
	thread <span class="token operator">=</span> <span class="token function">binder_get_thread</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> BINDER_WRITE_READ<span class="token operator">:</span> <span class="token comment">//进 binder_ioctl_write_read 函数 </span>
		ret <span class="token operator">=</span> <span class="token function">binder_ioctl_write_read</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token comment">//省略不相关case</span>
	<span class="token keyword">default</span><span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
err<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token punctuation">)</span>
		thread<span class="token operator">-&gt;</span>looper_need_return <span class="token operator">=</span> false<span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>接着我们看看 binder_ioctl_write_read 的实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_ioctl_write_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>
				<span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">,</span>
				<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ubuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>

    <span class="token comment">//......</span>

    <span class="token comment">//将应用层的 binder_write_read 拷贝到内核层</span>
	<span class="token comment">//注意，这里只拷贝了指针值，没有拷贝指针指向的数据</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//走这里</span>
		ret <span class="token operator">=</span> <span class="token function">binder_thread_write</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span>
					  bwr<span class="token punctuation">.</span>write_buffer<span class="token punctuation">,</span>
					  bwr<span class="token punctuation">.</span>write_size<span class="token punctuation">,</span>
					  <span class="token operator">&amp;</span>bwr<span class="token punctuation">.</span>write_consumed<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//写完以后接着读返回的信息</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token function">binder_thread_read</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_buffer<span class="token punctuation">,</span>
					 bwr<span class="token punctuation">.</span>read_size<span class="token punctuation">,</span>
					 <span class="token operator">&amp;</span>bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span>
					 filp<span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">trace_binder_read_done</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">binder_worklist_empty_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">binder_wakeup_proc_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
out<span class="token operator">:</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>接着看看 binder_thread_write 的实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_thread_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			<span class="token class-name">binder_uintptr_t</span> binder_buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span>
			<span class="token class-name">binder_size_t</span> <span class="token operator">*</span>consumed<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_context</span> <span class="token operator">*</span>context <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>context<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>binder_buffer<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ptr <span class="token operator">=</span> buffer <span class="token operator">+</span> <span class="token operator">*</span>consumed<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>end <span class="token operator">=</span> buffer <span class="token operator">+</span> size<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>ptr <span class="token operator">&lt;</span> end <span class="token operator">&amp;&amp;</span> thread<span class="token operator">-&gt;</span>return_error<span class="token punctuation">.</span>cmd <span class="token operator">==</span> BR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

        <span class="token comment">//获取到第一个数据 cmd</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_user</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//......</span>

		<span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//省略不相关的 case</span>
		<span class="token keyword">case</span> BC_TRANSACTION<span class="token operator">:</span>
		<span class="token keyword">case</span> BC_REPLY<span class="token operator">:</span> <span class="token punctuation">{</span> 
			<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> tr<span class="token punctuation">;</span>

            <span class="token comment">//将 binder_transaction_data 数据读到内核</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//binder_transaction 发起远程调用</span>
			<span class="token function">binder_transaction</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">,</span>
					   cmd <span class="token operator">==</span> BC_REPLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d unknown command %d\n&quot;</span><span class="token punctuation">,</span>
			       proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token operator">*</span>consumed <span class="token operator">=</span> ptr <span class="token operator">-</span> buffer<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>这里通过一个 while 循环解析应用层传过来的数据，数据中 cmd 为 BC_TRANSACTION，进入对于 case，然后调用 binder_transaction 发起远程调用。</p> <p>接着看 binder_transaction，这个函数巨长，但是其整体流程还是比较清晰：</p> <ul><li>获得目标进程/线程信息</li> <li>将数据拷贝到目标进程所映射的内存中（此时会建立实际的映射关系）</li> <li>将待处理的任务加入 todo 队列，唤醒目标线程</li></ul> <p>接着我们逐一分析：</p> <p><strong>获得目标进程/线程信息</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">,</span>
			       <span class="token class-name">binder_size_t</span> extra_buffers_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//一堆临时变量定义，用到再看</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token operator">*</span>tcomplete<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> buffer_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> off_start_offset<span class="token punctuation">,</span> off_end_offset<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> off_min<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> sg_buf_offset<span class="token punctuation">,</span> sg_buf_end_offset<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>target_proc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>target_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>target_node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>in_reply_to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_log_entry</span> <span class="token operator">*</span>e<span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> return_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> return_error_param <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> return_error_line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> last_fixup_obj_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> last_fixup_min_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_context</span> <span class="token operator">*</span>context <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>context<span class="token punctuation">;</span>
	<span class="token keyword">int</span> t_debug_id <span class="token operator">=</span> <span class="token function">atomic_inc_return</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_last_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>secctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	u32 secctx_sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token comment">//......</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//不是 reply，不走这</span>
		<span class="token comment">//......</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//传入的 handle 值为 0，代表我们要访问 ServiceManager</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//......</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context<span class="token operator">-&gt;</span>context_mgr_node_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 从 binder_proc context-&gt;binder_context_mgr_node</span>
            <span class="token comment">// 拿到 ServiceManager 对应的 binder_node</span>
			target_node <span class="token operator">=</span> context<span class="token operator">-&gt;</span>binder_context_mgr_node<span class="token punctuation">;</span>
            <span class="token comment">//通过 target_node 获得 target_proc</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token punctuation">)</span>
				target_node <span class="token operator">=</span> <span class="token function">binder_get_node_refs_for_txn</span><span class="token punctuation">(</span>
						target_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>target_proc<span class="token punctuation">,</span>
						<span class="token operator">&amp;</span>return_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				return_error <span class="token operator">=</span> BR_DEAD_REPLY<span class="token punctuation">;</span>
			<span class="token comment">//......</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//......</span>
		<span class="token punctuation">}</span>
		

        <span class="token comment">//此时，thread-&gt;transaction_stack 为空，不会进 if</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> thread<span class="token operator">-&gt;</span>transaction_stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//......</span>
		<span class="token punctuation">}</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//......</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>首先我们拿到保存在 <code>binder_proc-&gt;context-&gt;binder_context_mgr_node</code> 的 binder_node 节点，该结构体是对 ServiceManager 提供的服务的描述。接着通过 <code>binder_get_node_refs_for_txn</code> 函数，从 binder_node 得到 target_proc。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span><span class="token function">binder_get_node_refs_for_txn</span><span class="token punctuation">(</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span><span class="token operator">*</span>procp<span class="token punctuation">,</span>
		<span class="token class-name">uint32_t</span> <span class="token operator">*</span>error<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>target_node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token function">binder_node_inner_lock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>proc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		target_node <span class="token operator">=</span> node<span class="token punctuation">;</span>
		<span class="token function">binder_inc_node_nilocked</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inc_node_tmpref_ilocked</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
		node<span class="token operator">-&gt;</span>proc<span class="token operator">-&gt;</span>tmp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token comment">//关键，binder_node -&gt; binder_proc</span>
		<span class="token operator">*</span>procp <span class="token operator">=</span> node<span class="token operator">-&gt;</span>proc<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
		<span class="token operator">*</span>error <span class="token operator">=</span> BR_DEAD_REPLY<span class="token punctuation">;</span>
	<span class="token function">binder_node_inner_unlock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> target_node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>从源码可以看出，实际就是从 binder_node 的 proc 成员得到 target_proc。另外，需要注意，当一个函数的参数是二级指针，通常这个参数是用于返回数据的。</p> <p>接着我们看 <code>binder_transaction</code> 第二阶段：</p> <p><strong>将数据拷贝到目标进程所映射的内存中</strong></p> <p>分配缓存，建立映射：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">,</span>
			       <span class="token class-name">binder_size_t</span> extra_buffers_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

	<span class="token comment">//......</span>

	<span class="token comment">//为目标进程binder事务分配空间（后续会加到目标进程/线程的todo队列中，由目标进程/线程处理这个事务）</span>
	<span class="token comment">//struct binder_transaction *t;</span>
	t <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">//.....</span>

	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	tcomplete <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tcomplete<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	t<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> t_debug_id<span class="token punctuation">;</span>

	<span class="token comment">//主要是通过应用层传入的 binder_transaction_data 来构建 binder_transaction 结构体。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//走这</span>
		t<span class="token operator">-&gt;</span>from <span class="token operator">=</span> thread<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		t<span class="token operator">-&gt;</span>from <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>sender_euid <span class="token operator">=</span> <span class="token function">task_euid</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>to_proc <span class="token operator">=</span> target_proc<span class="token punctuation">;</span>
	<span class="token comment">//target_thread 目前为空</span>
	t<span class="token operator">-&gt;</span>to_thread <span class="token operator">=</span> target_thread<span class="token punctuation">;</span> <span class="token comment">//目前还是 null</span>
	t<span class="token operator">-&gt;</span>code <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>code<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
    
    <span class="token comment">//......</span>

	<span class="token comment">//分配内存并完成映射</span>
	t<span class="token operator">-&gt;</span>buffer <span class="token operator">=</span> <span class="token function">binder_alloc_new_buf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span>
		tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">,</span> extra_buffers_size<span class="token punctuation">,</span>
		<span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
    <span class="token comment">//......</span>

	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> t<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>transaction <span class="token operator">=</span> t<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>target_node <span class="token operator">=</span> target_node<span class="token punctuation">;</span>
    <span class="token comment">//......</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>这部分代码主要是分配并初始化一个 binder_transaction 结构体。
binder_transaction 结构体用来描述进程间通信过程（事务）：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> debug_id<span class="token punctuation">;</span>
    <span class="token comment">//用来描述需要处理的工作事项</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_work</span> work<span class="token punctuation">;</span>
    <span class="token comment">//发起事务的线程</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>from<span class="token punctuation">;</span>
    <span class="token comment">//事务所依赖的另一个事务</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>from_parent<span class="token punctuation">;</span>
    <span class="token comment">//处理该事务的进程</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>to_proc<span class="token punctuation">;</span>
    <span class="token comment">//处理该事务的线程</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>to_thread<span class="token punctuation">;</span>
    <span class="token comment">//目标线程下一个需要处理的事务</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>to_parent<span class="token punctuation">;</span>
    <span class="token comment">//1: 表示同步事务，需要等待对方回复</span>
    <span class="token comment">//0: 表示异步事务</span>
    <span class="token keyword">unsigned</span> need_reply<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">//指向为该事务分配的内核缓冲区</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>	code<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>	flags<span class="token punctuation">;</span>
    <span class="token comment">//发起事务线程的优先级</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_priority</span>	priority<span class="token punctuation">;</span>
    <span class="token comment">//线程在处理事务时，驱动会修改它的优先级以满足源线程和目标Service组建的要求</span>
    <span class="token comment">//在修改之前，会将它原来的线程优先级保存在该成员中，以便线程处理完该事务后可以恢复原来的优先级</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_priority</span>	saved_priority<span class="token punctuation">;</span>
    bool    set_priority_called<span class="token punctuation">;</span>
    <span class="token class-name">kuid_t</span>	sender_euid<span class="token punctuation">;</span>
    <span class="token class-name">binder_uintptr_t</span> security_ctx<span class="token punctuation">;</span>

    <span class="token class-name">spinlock_t</span> lock<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>这里我们先看一下 binder_alloc_new_buf 是如何分配内存的：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//加锁后调用 binder_alloc_new_buf_locked</span>
<span class="token comment">// alloc 来自 target_proc</span>
<span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span><span class="token function">binder_alloc_new_buf</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_alloc</span> <span class="token operator">*</span>alloc<span class="token punctuation">,</span>
					   <span class="token class-name">size_t</span> data_size<span class="token punctuation">,</span>
					   <span class="token class-name">size_t</span> offsets_size<span class="token punctuation">,</span>
					   <span class="token class-name">size_t</span> extra_buffers_size<span class="token punctuation">,</span>
					   <span class="token keyword">int</span> is_async<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span>

	<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	buffer <span class="token operator">=</span> <span class="token function">binder_alloc_new_buf_locked</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> data_size<span class="token punctuation">,</span> offsets_size<span class="token punctuation">,</span>extra_buffers_size<span class="token punctuation">,</span> is_async<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// alloc 来自 target_proc</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span><span class="token function">binder_alloc_new_buf_locked</span><span class="token punctuation">(</span>
				<span class="token keyword">struct</span> <span class="token class-name">binder_alloc</span> <span class="token operator">*</span>alloc<span class="token punctuation">,</span>
				<span class="token class-name">size_t</span> data_size<span class="token punctuation">,</span>
				<span class="token class-name">size_t</span> offsets_size<span class="token punctuation">,</span>
				<span class="token class-name">size_t</span> extra_buffers_size<span class="token punctuation">,</span>
				<span class="token keyword">int</span> is_async<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>n <span class="token operator">=</span> alloc<span class="token operator">-&gt;</span>free_buffers<span class="token punctuation">.</span>rb_node<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> buffer_size<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>best_fit <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>has_page_addr<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>end_page_addr<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> size<span class="token punctuation">,</span> data_offsets_size<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	<span class="token comment">//......</span>

	<span class="token comment">//ALIGN 宏 用于内存的对齐</span>
	 <span class="token comment">//计算需要的内存的大小</span>
    <span class="token comment">//这里需要将size对齐void *（32位下占用4字节，64位下占用8字节）</span>
	data_offsets_size <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
		<span class="token function">ALIGN</span><span class="token punctuation">(</span>offsets_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//......</span>

	size <span class="token operator">=</span> data_offsets_size <span class="token operator">+</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>extra_buffers_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//.......</span>

	<span class="token comment">/**
	 * 从上面代码开出，需要的内存大小又三部分组成
	 * data_size ： 应用层传入的数据区大小
	 * offsets_size：应用层传入的偏移区大小
	 * extra_buffers_size：这里传入的是 0
	 */</span>
	
	<span class="token comment">//在上一篇说过的 free_async_space</span>
	<span class="token comment">//这里是 oneway 模式，即异步模式，与当前代码情景无关，主要是解释面试题目</span>
	<span class="token comment">//传输的数据的大小不能超过 free_async_space</span>
	<span class="token comment">// free_async_space 默认值是映射区的一半</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>is_async <span class="token operator">&amp;&amp;</span>
	    alloc<span class="token operator">-&gt;</span>free_async_space <span class="token operator">&lt;</span> size <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_alloc_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_BUFFER_ALLOC<span class="token punctuation">,</span>
			     <span class="token string">&quot;%d: binder_alloc_buf size %zd failed, no async space left\n&quot;</span><span class="token punctuation">,</span>
			      alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOSPC<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//最终计算出一个需要的内存大小</span>
	size <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//开始在 alloc-&gt; free_buffers 中找一个大小合适的 binder_buffer</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		buffer <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span><span class="token punctuation">,</span> rb_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token operator">-&gt;</span>free<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//刚开始只有一个 buffer，buffer_size 就是整个缓冲区的大小</span>
		buffer_size <span class="token operator">=</span> <span class="token function">binder_alloc_buffer_size</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> buffer_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			best_fit <span class="token operator">=</span> n<span class="token punctuation">;</span>
			n <span class="token operator">=</span> n<span class="token operator">-&gt;</span>rb_left<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> buffer_size<span class="token punctuation">)</span>
			n <span class="token operator">=</span> n<span class="token operator">-&gt;</span>rb_right<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			best_fit <span class="token operator">=</span> n<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//......</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//选中的 binder_buffer</span>
		buffer <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>best_fit<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span><span class="token punctuation">,</span> rb_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
		buffer_size <span class="token operator">=</span> <span class="token function">binder_alloc_buffer_size</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token comment">//PAGE_MASK 判定 addr 是否是 4096 倍数</span>
	<span class="token comment">//缓存区还剩多少</span>
	has_page_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>
		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>buffer<span class="token operator">-&gt;</span>user_data <span class="token operator">+</span> buffer_size<span class="token punctuation">)</span> <span class="token operator">&amp;</span> PAGE_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">WARN_ON</span><span class="token punctuation">(</span>n <span class="token operator">&amp;&amp;</span> buffer_size <span class="token operator">!=</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//要使用的内存的终点位置</span>
	end_page_addr <span class="token operator">=</span>
		<span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>buffer<span class="token operator">-&gt;</span>user_data <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>end_page_addr <span class="token operator">&gt;</span> has_page_addr<span class="token punctuation">)</span>
		end_page_addr <span class="token operator">=</span> has_page_addr<span class="token punctuation">;</span>

	<span class="token comment">//分配物理内存，并完成用户空间与内核空间的映射</span>
	ret <span class="token operator">=</span> <span class="token function">binder_update_page_range</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>
		<span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>buffer<span class="token operator">-&gt;</span>user_data<span class="token punctuation">)</span><span class="token punctuation">,</span> end_page_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//......</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><p>这里会调用 binder_update_page_range 进行内存的分配与映射：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_update_page_range</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_alloc</span> <span class="token operator">*</span>alloc<span class="token punctuation">,</span> <span class="token keyword">int</span> allocate<span class="token punctuation">,</span>
				    <span class="token keyword">void</span> __user <span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token keyword">void</span> __user <span class="token operator">*</span>end<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>page_addr<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_page_addr<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_lru_page</span> <span class="token operator">*</span>page<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mm_struct</span> <span class="token operator">*</span>mm <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	bool need_mm <span class="token operator">=</span> false<span class="token punctuation">;</span>

	<span class="token function">binder_alloc_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_BUFFER_ALLOC<span class="token punctuation">,</span>
		     <span class="token string">&quot;%d: %s pages %pK-%pK\n&quot;</span><span class="token punctuation">,</span> alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
		     allocate <span class="token operator">?</span> <span class="token string">&quot;allocate&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;free&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&lt;=</span> start<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">trace_binder_update_page_range</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> allocate<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>allocate <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> free_range<span class="token punctuation">;</span>

	<span class="token comment">//检查是否有页需要分配</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>page_addr <span class="token operator">=</span> start<span class="token punctuation">;</span> page_addr <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> page_addr <span class="token operator">+=</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		page <span class="token operator">=</span> <span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>pages<span class="token punctuation">[</span><span class="token punctuation">(</span>page_addr <span class="token operator">-</span> alloc<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span> <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token operator">-&gt;</span>page_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			need_mm <span class="token operator">=</span> true<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>need_mm <span class="token operator">&amp;&amp;</span> <span class="token function">mmget_not_zero</span><span class="token punctuation">(</span>alloc<span class="token operator">-&gt;</span>vma_vm_mm<span class="token punctuation">)</span><span class="token punctuation">)</span>
		mm <span class="token operator">=</span> alloc<span class="token operator">-&gt;</span>vma_vm_mm<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>mm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">down_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mmap_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		vma <span class="token operator">=</span> alloc<span class="token operator">-&gt;</span>vma<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vma <span class="token operator">&amp;&amp;</span> need_mm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;%d: binder_alloc_buf failed to map pages in userspace, no vma\n&quot;</span><span class="token punctuation">,</span>
			alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_no_vma<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>page_addr <span class="token operator">=</span> start<span class="token punctuation">;</span> page_addr <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> page_addr <span class="token operator">+=</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
		bool on_lru<span class="token punctuation">;</span>
		<span class="token class-name">size_t</span> index<span class="token punctuation">;</span>

		index <span class="token operator">=</span> <span class="token punctuation">(</span>page_addr <span class="token operator">-</span> alloc<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span> <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">;</span>
		page <span class="token operator">=</span> <span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>pages<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">//page-&gt;page_ptr不为NULL说明之前已经分配并映射过了</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token operator">-&gt;</span>page_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">trace_binder_alloc_lru_start</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>

			on_lru <span class="token operator">=</span> <span class="token function">list_lru_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_alloc_lru<span class="token punctuation">,</span> <span class="token operator">&amp;</span>page<span class="token operator">-&gt;</span>lru<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>on_lru<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">trace_binder_alloc_lru_end</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>vma<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">goto</span> err_page_ptr_cleared<span class="token punctuation">;</span>

		<span class="token function">trace_binder_alloc_page_start</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//分配一个页的物理内存</span>
		page<span class="token operator">-&gt;</span>page_ptr <span class="token operator">=</span> <span class="token function">alloc_page</span><span class="token punctuation">(</span>GFP_KERNEL <span class="token operator">|</span>
					    __GFP_HIGHMEM <span class="token operator">|</span>
					    __GFP_ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token operator">-&gt;</span>page_ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;%d: binder_alloc_buf failed for page at %pK\n&quot;</span><span class="token punctuation">,</span>
				alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> page_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_alloc_page_failed<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		page<span class="token operator">-&gt;</span>alloc <span class="token operator">=</span> alloc<span class="token punctuation">;</span>
		<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>page<span class="token operator">-&gt;</span>lru<span class="token punctuation">)</span><span class="token punctuation">;</span>

		user_page_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>page_addr<span class="token punctuation">;</span>
		<span class="token comment">//将物理内存空间映射到目标用户进程虚拟内存空间</span>
		ret <span class="token operator">=</span> <span class="token function">vm_insert_page</span><span class="token punctuation">(</span>vma<span class="token punctuation">,</span> user_page_addr<span class="token punctuation">,</span> page<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>page_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;%d: binder_alloc_buf failed to map page at %lx in userspace\n&quot;</span><span class="token punctuation">,</span>
			       alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> user_page_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_vm_insert_page_failed<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> alloc<span class="token operator">-&gt;</span>pages_high<span class="token punctuation">)</span>
			alloc<span class="token operator">-&gt;</span>pages_high <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

		<span class="token function">trace_binder_alloc_page_end</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* vm_insert_page does not seem to increment the refcount */</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">up_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mmap_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mmput</span><span class="token punctuation">(</span>mm<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

free_range<span class="token operator">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>page_addr <span class="token operator">=</span> end <span class="token operator">-</span> PAGE_SIZE<span class="token punctuation">;</span> page_addr <span class="token operator">&gt;=</span> start<span class="token punctuation">;</span>
	     page_addr <span class="token operator">-=</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bool ret<span class="token punctuation">;</span>
		<span class="token class-name">size_t</span> index<span class="token punctuation">;</span>

		index <span class="token operator">=</span> <span class="token punctuation">(</span>page_addr <span class="token operator">-</span> alloc<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span> <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">;</span>
		page <span class="token operator">=</span> <span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>pages<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token function">trace_binder_free_lru_start</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>

		ret <span class="token operator">=</span> <span class="token function">list_lru_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_alloc_lru<span class="token punctuation">,</span> <span class="token operator">&amp;</span>page<span class="token operator">-&gt;</span>lru<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">trace_binder_free_lru_end</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">continue</span><span class="token punctuation">;</span>

err_vm_insert_page_failed<span class="token operator">:</span>
		<span class="token function">__free_page</span><span class="token punctuation">(</span>page<span class="token operator">-&gt;</span>page_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		page<span class="token operator">-&gt;</span>page_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
err_alloc_page_failed<span class="token operator">:</span>
err_page_ptr_cleared<span class="token operator">:</span>
		<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
err_no_vma<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">up_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mmap_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mmput</span><span class="token punctuation">(</span>mm<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> vma <span class="token operator">?</span> <span class="token operator">-</span>ENOMEM <span class="token operator">:</span> <span class="token operator">-</span>ESRCH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br></div></div><p>代码中的注释写的应该比较清楚了，总之就是先分配物理内存，再将这块物理内存分别映射到内核虚拟空间和用户进程虚拟空间，这样内核虚拟空间与用户进程虚拟空间相当于也间接的建立了映射关系。</p> <p>关于物理内存的分配以及映射，就是 Linux 内核层的事情了，感兴趣的同学可以再深入往里看看，这里就不再多说了</p> <p>回过头来，我们接着看 binder_alloc_new_buf_locked：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span><span class="token function">binder_alloc_new_buf_locked</span><span class="token punctuation">(</span>
   			<span class="token keyword">struct</span> <span class="token class-name">binder_alloc</span> <span class="token operator">*</span>alloc<span class="token punctuation">,</span>
   			<span class="token class-name">size_t</span> data_size<span class="token punctuation">,</span>
   			<span class="token class-name">size_t</span> offsets_size<span class="token punctuation">,</span>
   			<span class="token class-name">size_t</span> extra_buffers_size<span class="token punctuation">,</span>
   			<span class="token keyword">int</span> is_async<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

   <span class="token comment">//......</span>
   <span class="token comment">//分配好物理内存完成映射后</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token comment">//错误处理</span>
   	<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//缓存区如果没有使用完</span>
   <span class="token comment">//切分 binder_buffer</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer_size <span class="token operator">!=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
   	<span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span>new_buffer<span class="token punctuation">;</span>

   	new_buffer <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   		<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;%s: %d failed to alloc new buffer struct\n&quot;</span><span class="token punctuation">,</span>
   		       <span class="token constant">__func__</span><span class="token punctuation">,</span> alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   		<span class="token keyword">goto</span> err_alloc_buf_struct_failed<span class="token punctuation">;</span>
   	<span class="token punctuation">}</span>
   	new_buffer<span class="token operator">-&gt;</span>user_data <span class="token operator">=</span> <span class="token punctuation">(</span>u8 __user <span class="token operator">*</span><span class="token punctuation">)</span>buffer<span class="token operator">-&gt;</span>user_data <span class="token operator">+</span> size<span class="token punctuation">;</span>
   	<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_buffer<span class="token operator">-&gt;</span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token operator">-&gt;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
   	new_buffer<span class="token operator">-&gt;</span>free <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//binder_buffer 未使用</span>
   	<span class="token function">binder_insert_free_buffer</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> new_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token function">rb_erase</span><span class="token punctuation">(</span>best_fit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>free_buffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
   buffer<span class="token operator">-&gt;</span>free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//binder_buffer 已使用</span>
   buffer<span class="token operator">-&gt;</span>allow_user_free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">//将已使用 的 binder_buffer 插入 allocated_buffer</span>
   <span class="token function">binder_insert_allocated_buffer_locked</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">binder_alloc_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_BUFFER_ALLOC<span class="token punctuation">,</span>
   	     <span class="token string">&quot;%d: binder_alloc_buf size %zd got %pK\n&quot;</span><span class="token punctuation">,</span>
   	      alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> size<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//上面进行了切分，原来的 binder_buffer 的尺寸相关的值就要修改</span>
   buffer<span class="token operator">-&gt;</span>data_size <span class="token operator">=</span> data_size<span class="token punctuation">;</span>
   buffer<span class="token operator">-&gt;</span>offsets_size <span class="token operator">=</span> offsets_size<span class="token punctuation">;</span>
   buffer<span class="token operator">-&gt;</span>async_transaction <span class="token operator">=</span> is_async<span class="token punctuation">;</span>
   buffer<span class="token operator">-&gt;</span>extra_buffers_size <span class="token operator">=</span> extra_buffers_size<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>is_async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	alloc<span class="token operator">-&gt;</span>free_async_space <span class="token operator">-=</span> size <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token function">binder_alloc_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_BUFFER_ALLOC_ASYNC<span class="token punctuation">,</span>
   		     <span class="token string">&quot;%d: binder_alloc_buf size %zd async free %zd\n&quot;</span><span class="token punctuation">,</span>
   		      alloc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> size<span class="token punctuation">,</span> alloc<span class="token operator">-&gt;</span>free_async_space<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>

err_alloc_buf_struct_failed<span class="token operator">:</span>
   <span class="token function">binder_update_page_range</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>
   			 <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>buffer<span class="token operator">-&gt;</span>user_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
   			 end_page_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>内存的分配和映射部分就完成了，接着我们来看数据是如何拷贝给 ServiceManager 的：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">,</span>
			       <span class="token class-name">binder_size_t</span> extra_buffers_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//.......</span>

    <span class="token comment">//将用户态的数据（data部分）拷贝到目标进程的 binder_buffer中</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_alloc_copy_user_to_buffer</span><span class="token punctuation">(</span>
				<span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
				t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>
					<span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
				tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid data ptr\n&quot;</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//将用户态的数据（off部分）拷贝到目标进程的 binder_buffer中</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_alloc_copy_user_to_buffer</span><span class="token punctuation">(</span>
				<span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
				t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>
				<span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>
					<span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span>
				tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid offsets ptr\n&quot;</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	

	off_start_offset <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	buffer_offset <span class="token operator">=</span> off_start_offset<span class="token punctuation">;</span>
	off_end_offset <span class="token operator">=</span> off_start_offset <span class="token operator">+</span> tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">;</span>
	sg_buf_offset <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>off_end_offset<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sg_buf_end_offset <span class="token operator">=</span> sg_buf_offset <span class="token operator">+</span> extra_buffers_size<span class="token punctuation">;</span>
	off_min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//接着会对数据中的 flat_binder_object 做一些处理</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>buffer_offset <span class="token operator">=</span> off_start_offset<span class="token punctuation">;</span> buffer_offset <span class="token operator">&lt;</span> off_end_offset<span class="token punctuation">;</span>
	     buffer_offset <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span> <span class="token operator">*</span>hdr<span class="token punctuation">;</span>
		<span class="token class-name">size_t</span> object_size<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_object</span> object<span class="token punctuation">;</span>
		<span class="token class-name">binder_size_t</span> object_offset<span class="token punctuation">;</span>

		<span class="token function">binder_alloc_copy_from_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
					      <span class="token operator">&amp;</span>object_offset<span class="token punctuation">,</span>
					      t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>
					      buffer_offset<span class="token punctuation">,</span>
					      <span class="token keyword">sizeof</span><span class="token punctuation">(</span>object_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		object_size <span class="token operator">=</span> <span class="token function">binder_get_object</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>
						object_offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>object_size <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> object_offset <span class="token operator">&lt;</span> off_min<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid offset (%lld, min %lld max %lld) or object.\n&quot;</span><span class="token punctuation">,</span>
					  proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
					  <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>object_offset<span class="token punctuation">,</span>
					  <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>off_min<span class="token punctuation">,</span>
					  <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
			return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_bad_offset<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		hdr <span class="token operator">=</span> <span class="token operator">&amp;</span>object<span class="token punctuation">.</span>hdr<span class="token punctuation">;</span>
		off_min <span class="token operator">=</span> object_offset <span class="token operator">+</span> object_size<span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> BINDER_TYPE_BINDER<span class="token operator">:</span> <span class="token comment">//走这里</span>
		<span class="token keyword">case</span> BINDER_TYPE_WEAK_BINDER<span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>fp<span class="token punctuation">;</span>

			fp <span class="token operator">=</span> <span class="token function">to_flat_binder_object</span><span class="token punctuation">(</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//对数据做转换</span>
			ret <span class="token operator">=</span> <span class="token function">binder_translate_binder</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> t<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				return_error_param <span class="token operator">=</span> ret<span class="token punctuation">;</span>
				return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_translate_failed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//处理后的数据拷贝给目标进程</span>
			<span class="token function">binder_alloc_copy_to_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
						    t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span> object_offset<span class="token punctuation">,</span>
						    fp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid object type, %x\n&quot;</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> hdr<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
			return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_bad_object_type<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	tcomplete<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION_COMPLETE<span class="token punctuation">;</span>
	<span class="token comment">// binder_work 的类型</span>
	t<span class="token operator">-&gt;</span>work<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><p>上面的代码通过 binder_translate_binder 对应用层传过来的 flat_binder_object 进行了处理：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//flat_binder_object 定义</span>
<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span>	hdr<span class="token punctuation">;</span>
	__u32				flags<span class="token punctuation">;</span>

	<span class="token comment">/* 8 bytes of data. */</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token class-name">binder_uintptr_t</span>	binder<span class="token punctuation">;</span>	<span class="token comment">/* local object */</span>
		__u32			handle<span class="token punctuation">;</span>	<span class="token comment">/* remote object */</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">/* extra data associated with local object */</span>
	<span class="token class-name">binder_uintptr_t</span>	cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_translate_binder</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>fp<span class="token punctuation">,</span>
				   <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">,</span>
				   <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>target_proc <span class="token operator">=</span> t<span class="token operator">-&gt;</span>to_proc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_ref_data</span> rdata<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	node <span class="token operator">=</span> <span class="token function">binder_get_node</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>binder<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		node <span class="token operator">=</span> <span class="token function">binder_new_node</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>cookie <span class="token operator">!=</span> node<span class="token operator">-&gt;</span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d sending u%016llx node %d, cookie mismatch %016llx != %016llx\n&quot;</span><span class="token punctuation">,</span>
				  proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>fp<span class="token operator">-&gt;</span>binder<span class="token punctuation">,</span>
				  node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>fp<span class="token operator">-&gt;</span>cookie<span class="token punctuation">,</span>
				  <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>node<span class="token operator">-&gt;</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">security_binder_transfer_binder</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>tsk<span class="token punctuation">,</span> target_proc<span class="token operator">-&gt;</span>tsk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//创建服务对应的 binder_ref 结构体，并插入 refs_by_node refs_by_desc 两个红黑树中</span>
	<span class="token comment">// 根据插入的顺序计算出 binder_ref 的索引 desc， 并保存到 rdata 中</span>
	ret <span class="token operator">=</span> <span class="token function">binder_inc_ref_for_node</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> node<span class="token punctuation">,</span>
			fp<span class="token operator">-&gt;</span>hdr<span class="token punctuation">.</span>type <span class="token operator">==</span> BINDER_TYPE_BINDER<span class="token punctuation">,</span>
			<span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> done<span class="token punctuation">;</span>
	<span class="token comment">//对数据做一些处理</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>hdr<span class="token punctuation">.</span>type <span class="token operator">==</span> BINDER_TYPE_BINDER<span class="token punctuation">)</span>
		fp<span class="token operator">-&gt;</span>hdr<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_TYPE_HANDLE<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		fp<span class="token operator">-&gt;</span>hdr<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_TYPE_WEAK_HANDLE<span class="token punctuation">;</span>
	fp<span class="token operator">-&gt;</span>binder <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	fp<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> rdata<span class="token punctuation">.</span>desc<span class="token punctuation">;</span> <span class="token comment">// handle 值会被 ServiceManager 保存在用户态</span>
	fp<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">trace_binder_transaction_node_to_ref</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
		     <span class="token string">&quot;        node %d u%016llx -&gt; ref %d desc %d\n&quot;</span><span class="token punctuation">,</span>
		     node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>node<span class="token operator">-&gt;</span>ptr<span class="token punctuation">,</span>
		     rdata<span class="token punctuation">.</span>debug_id<span class="token punctuation">,</span> rdata<span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
done<span class="token operator">:</span>
	<span class="token function">binder_put_node</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_inc_ref_for_node</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>
			bool strong<span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>target_list<span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_ref_data</span> <span class="token operator">*</span>rdata<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>ref<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>new_ref <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">binder_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ref <span class="token operator">=</span> <span class="token function">binder_get_ref_for_node_olocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		new_ref <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ref<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_ref<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token function">binder_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ref <span class="token operator">=</span> <span class="token function">binder_get_ref_for_node_olocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> node<span class="token punctuation">,</span> new_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	ret <span class="token operator">=</span> <span class="token function">binder_inc_ref_olocked</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> strong<span class="token punctuation">,</span> target_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>rdata <span class="token operator">=</span> ref<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
	<span class="token function">binder_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref <span class="token operator">&amp;&amp;</span> ref <span class="token operator">!=</span> new_ref<span class="token punctuation">)</span>
		<span class="token comment">/*
		 * Another thread created the ref first so
		 * free the one we allocated
		 */</span>
		<span class="token function">kfree</span><span class="token punctuation">(</span>new_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span><span class="token function">binder_get_ref_for_node_olocked</span><span class="token punctuation">(</span>
					<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
					<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>
					<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>new_ref<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_context</span> <span class="token operator">*</span>context <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>context<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span><span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>refs_by_node<span class="token punctuation">.</span>rb_node<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>ref<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>n<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		parent <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
		ref <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_ref</span><span class="token punctuation">,</span> rb_node_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">&lt;</span> ref<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span>
			p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>rb_left<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">&gt;</span> ref<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span>
			p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>rb_right<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token keyword">return</span> ref<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_ref<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_REF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>debug_id <span class="token operator">=</span> <span class="token function">atomic_inc_return</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_last_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	new_ref<span class="token operator">-&gt;</span>proc <span class="token operator">=</span> proc<span class="token punctuation">;</span>
	new_ref<span class="token operator">-&gt;</span>node <span class="token operator">=</span> node<span class="token punctuation">;</span>
	<span class="token function">rb_link_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-&gt;</span>rb_node_node<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rb_insert_color</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-&gt;</span>rb_node_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>refs_by_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

	new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc <span class="token operator">=</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> context<span class="token operator">-&gt;</span>binder_context_mgr_node<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">rb_first</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>refs_by_desc<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> n <span class="token operator">=</span> <span class="token function">rb_next</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ref <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_ref</span><span class="token punctuation">,</span> rb_node_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc <span class="token operator">&gt;</span> new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc <span class="token operator">=</span> ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	p <span class="token operator">=</span> <span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>refs_by_desc<span class="token punctuation">.</span>rb_node<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		parent <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
		ref <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_ref</span><span class="token punctuation">,</span> rb_node_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc <span class="token operator">&lt;</span> ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
			p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>rb_left<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc <span class="token operator">&gt;</span> ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
			p <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>rb_right<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">rb_link_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-&gt;</span>rb_node_desc<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rb_insert_color</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-&gt;</span>rb_node_desc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>refs_by_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">binder_node_lock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">hlist_add_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>new_ref<span class="token operator">-&gt;</span>node_entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>node<span class="token operator">-&gt;</span>refs<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_INTERNAL_REFS<span class="token punctuation">,</span>
		     <span class="token string">&quot;%d new ref %d desc %d for node %d\n&quot;</span><span class="token punctuation">,</span>
		      proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>debug_id<span class="token punctuation">,</span> new_ref<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>desc<span class="token punctuation">,</span>
		      node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_node_unlock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> new_ref<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br></div></div><p>至此，数据的拷贝就完成了，接着我们来看第三阶段：</p> <p><strong>将待处理的任务加入 todo 队列，唤醒目标线程</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">,</span>
			       <span class="token class-name">binder_size_t</span> extra_buffers_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//......</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//......</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//将 tcomplete 插入到事务发起 binder 线程的 todo 队列中</span>
		<span class="token comment">//等 Server 端收到 ServiceManager 的回复后就会执行这个 binder_work</span>
		<span class="token function">binder_enqueue_deferred_thread_work_ilocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> tcomplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//记录一些信息</span>
		t<span class="token operator">-&gt;</span>need_reply <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		t<span class="token operator">-&gt;</span>from_parent <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>transaction_stack<span class="token punctuation">;</span>
		thread<span class="token operator">-&gt;</span>transaction_stack <span class="token operator">=</span> t<span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//将t-&gt;work插入目标线程的todo队列中并唤醒目标进程</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">binder_proc_transaction</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> target_proc<span class="token punctuation">,</span> target_thread<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">binder_pop_transaction_ilocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_dead_proc_or_thread<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">//......</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread<span class="token punctuation">)</span>
		<span class="token function">binder_thread_dec_tmpref</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_proc_dec_tmpref</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token punctuation">)</span>
		<span class="token function">binder_dec_node_tmpref</span><span class="token punctuation">(</span>target_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	 * write barrier to synchronize with initialization
	 * of log entry
	 */</span>
	<span class="token function">smp_wmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">WRITE_ONCE</span><span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>debug_id_done<span class="token punctuation">,</span> t_debug_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>binder_proc_transaction 的实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> bool <span class="token function">binder_proc_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">,</span>
				    <span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
				    <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>node <span class="token operator">=</span> t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>target_node<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_priority</span> node_prio<span class="token punctuation">;</span>
	bool oneway <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bool pending_async <span class="token operator">=</span> false<span class="token punctuation">;</span>

	<span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_node_lock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	node_prio<span class="token punctuation">.</span>prio <span class="token operator">=</span> node<span class="token operator">-&gt;</span>min_priority<span class="token punctuation">;</span>
	node_prio<span class="token punctuation">.</span>sched_policy <span class="token operator">=</span> node<span class="token operator">-&gt;</span>sched_policy<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>oneway<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>has_async_transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			pending_async <span class="token operator">=</span> true<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			node<span class="token operator">-&gt;</span>has_async_transaction <span class="token operator">=</span> true<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//如果目标进程死亡或者目标线程不为NULL且死亡</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>is_dead <span class="token operator">||</span> <span class="token punctuation">(</span>thread <span class="token operator">&amp;&amp;</span> thread<span class="token operator">-&gt;</span>is_dead<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_node_unlock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> false<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// thread 为空</span>
	<span class="token comment">// pending_async false</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>thread <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pending_async<span class="token punctuation">)</span> <span class="token comment">//走这</span>
	<span class="token comment">//从 target_proc 的 waiting_threads 链表中选择第一个作为 target_thread</span>
		thread <span class="token operator">=</span> <span class="token function">binder_select_thread_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//走这</span>
		<span class="token function">binder_transaction_priority</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span>task<span class="token punctuation">,</span> t<span class="token punctuation">,</span> node_prio<span class="token punctuation">,</span>
					    node<span class="token operator">-&gt;</span>inherit_rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//把 binder_transaction 插入到 target_thread 的 todo 链表中</span>
		<span class="token function">binder_enqueue_thread_work_ilocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending_async<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
		<span class="token function">binder_enqueue_work_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>work<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">binder_enqueue_work_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>work<span class="token punctuation">,</span> <span class="token operator">&amp;</span>node<span class="token operator">-&gt;</span>async_todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending_async<span class="token punctuation">)</span> <span class="token comment">//走这</span>
		<span class="token comment">//唤醒远程线程</span>
		<span class="token function">binder_wakeup_thread_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> <span class="token operator">!</span>oneway <span class="token comment">/* sync */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_node_unlock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//从 target_proc 的 waiting_threads 链表中选择第一个作为 target_thread</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>
<span class="token function">binder_select_thread_ilocked</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">;</span>

	<span class="token function">assert_spin_locked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>inner_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	thread <span class="token operator">=</span> <span class="token function">list_first_entry_or_null</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>waiting_threads<span class="token punctuation">,</span>
					  <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span><span class="token punctuation">,</span>
					  waiting_thread_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token punctuation">)</span>
		<span class="token function">list_del_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>waiting_thread_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> thread<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//把 binder_transaction 插入到 target_thread 的 todo 链表中</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">binder_enqueue_thread_work_ilocked</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
				   <span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token operator">*</span>work<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">binder_enqueue_work_ilocked</span><span class="token punctuation">(</span>work<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	thread<span class="token operator">-&gt;</span>process_todo <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">binder_enqueue_work_ilocked</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token operator">*</span>work<span class="token punctuation">,</span>
			   <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>target_list<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">BUG_ON</span><span class="token punctuation">(</span>target_list <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">BUG_ON</span><span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>entry<span class="token punctuation">.</span>next <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token operator">-&gt;</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token operator">-&gt;</span>entry<span class="token punctuation">,</span> target_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//唤醒接收端</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_wakeup_thread_ilocked</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
					 <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
					 bool sync<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">assert_spin_locked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>inner_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sync<span class="token punctuation">)</span> <span class="token comment">//走这</span>
			<span class="token comment">//唤醒 ServiceManager</span>
			<span class="token function">wake_up_interruptible_sync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">binder_wakeup_poll_threads_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> sync<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br></div></div><p>至此，binder_transaction 的三个阶段就执行完了：</p> <ul><li>获得目标进程/线程信息</li> <li>将数据拷贝到目标进程所映射的内存中（此时会建立实际的映射关系）</li> <li>将待处理的任务加入 todo 队列，唤醒目标线程</li></ul> <p>接着我们就来看看 ServiceManager 被唤醒后的操作：</p> <h2 id="_4-servicemanager-被唤醒"><a href="#_4-servicemanager-被唤醒" class="header-anchor">#</a> 4. ServiceManager 被唤醒</h2> <p>ServiceManager 在 binder_thread_read 函数处，调用进程调度函数进入休眠：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_thread_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			      <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			      <span class="token class-name">binder_uintptr_t</span> binder_buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span>
			      <span class="token class-name">binder_size_t</span> <span class="token operator">*</span>consumed<span class="token punctuation">,</span> <span class="token keyword">int</span> non_block<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>binder_buffer<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ptr <span class="token operator">=</span> buffer <span class="token operator">+</span> <span class="token operator">*</span>consumed<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>end <span class="token operator">=</span> buffer <span class="token operator">+</span> size<span class="token punctuation">;</span>

	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> wait_for_proc_work<span class="token punctuation">;</span>

	<span class="token comment">//......</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>non_block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">binder_has_work</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> wait_for_proc_work<span class="token punctuation">)</span><span class="token punctuation">)</span>
			ret <span class="token operator">=</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">//ServiceManager 从这里唤醒</span>
		ret <span class="token operator">=</span> <span class="token function">binder_wait_for_work</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> wait_for_proc_work<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//把 BINDER_LOOPER_STATE_WAITING 状态取消掉</span>
	thread<span class="token operator">-&gt;</span>looper <span class="token operator">&amp;=</span> <span class="token operator">~</span>BINDER_LOOPER_STATE_WAITING<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

	<span class="token comment">//进入循环解析收到的数据</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> tr<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>trd <span class="token operator">=</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">.</span>transaction_data<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token operator">*</span>w <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>t_from<span class="token punctuation">;</span>
		<span class="token class-name">size_t</span> trsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>trd<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//拿到 todo 链表</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">binder_worklist_empty_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">)</span>
			list <span class="token operator">=</span> <span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">;</span> <span class="token comment">//走这</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">binder_worklist_empty_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
			   wait_for_proc_work<span class="token punctuation">)</span>
			list <span class="token operator">=</span> <span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">/* no data added */</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">-</span> buffer <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>thread<span class="token operator">-&gt;</span>looper_need_return<span class="token punctuation">)</span>
				<span class="token keyword">goto</span> retry<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> ptr <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//拿到 Server 端插入的 binder_workd</span>
		<span class="token comment">//struct binder_work *w</span>
		w <span class="token operator">=</span> <span class="token function">binder_dequeue_work_head_ilocked</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_worklist_empty_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">)</span>
			thread<span class="token operator">-&gt;</span>process_todo <span class="token operator">=</span> false<span class="token punctuation">;</span>

		<span class="token keyword">switch</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//执行 binder_work</span>
		<span class="token keyword">case</span> BINDER_WORK_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//struct binder_transaction *t = NULL;</span>
			<span class="token comment">//从 binder_work 得到 binder_transaction</span>
			t <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span><span class="token punctuation">,</span> work<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token comment">//省略不相关 case</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>

		<span class="token comment">//通过 binder_transaction 构建  binder_transaction_data</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>target_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>target_node <span class="token operator">=</span> t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>target_node<span class="token punctuation">;</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_priority</span> node_prio<span class="token punctuation">;</span>

			trd<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> target_node<span class="token operator">-&gt;</span>ptr<span class="token punctuation">;</span>
			trd<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span>  target_node<span class="token operator">-&gt;</span>cookie<span class="token punctuation">;</span>
			node_prio<span class="token punctuation">.</span>sched_policy <span class="token operator">=</span> target_node<span class="token operator">-&gt;</span>sched_policy<span class="token punctuation">;</span>
			node_prio<span class="token punctuation">.</span>prio <span class="token operator">=</span> target_node<span class="token operator">-&gt;</span>min_priority<span class="token punctuation">;</span>
			<span class="token function">binder_transaction_priority</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> t<span class="token punctuation">,</span> node_prio<span class="token punctuation">,</span>
						    target_node<span class="token operator">-&gt;</span>inherit_rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			cmd <span class="token operator">=</span> BR_TRANSACTION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			trd<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			trd<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			cmd <span class="token operator">=</span> BR_REPLY<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		trd<span class="token operator">-&gt;</span>code <span class="token operator">=</span> t<span class="token operator">-&gt;</span>code<span class="token punctuation">;</span>
		trd<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> t<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
		trd<span class="token operator">-&gt;</span>sender_euid <span class="token operator">=</span> <span class="token function">from_kuid</span><span class="token punctuation">(</span><span class="token function">current_user_ns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">;</span>

		t_from <span class="token operator">=</span> <span class="token function">binder_get_txn_from</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>t_from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>sender <span class="token operator">=</span> t_from<span class="token operator">-&gt;</span>proc<span class="token operator">-&gt;</span>tsk<span class="token punctuation">;</span>

			trd<span class="token operator">-&gt;</span>sender_pid <span class="token operator">=</span>
				<span class="token function">task_tgid_nr_ns</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span>
						<span class="token function">task_active_pid_ns</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			trd<span class="token operator">-&gt;</span>sender_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		trd<span class="token operator">-&gt;</span>data_size <span class="token operator">=</span> t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data_size<span class="token punctuation">;</span>
		trd<span class="token operator">-&gt;</span>offsets_size <span class="token operator">=</span> t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">;</span>
		trd<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>user_data<span class="token punctuation">;</span>
		trd<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> trd<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">+</span>
					<span class="token function">ALIGN</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span>
					    <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		tr<span class="token punctuation">.</span>secctx <span class="token operator">=</span> t<span class="token operator">-&gt;</span>security_ctx<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>security_ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			cmd <span class="token operator">=</span> BR_TRANSACTION_SEC_CTX<span class="token punctuation">;</span>
			trsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//构建好了，开始将数据写回用户态</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">put_user</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>t_from<span class="token punctuation">)</span>
				<span class="token function">binder_thread_dec_tmpref</span><span class="token punctuation">(</span>t_from<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">binder_cleanup_transaction</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">&quot;put_user failed&quot;</span><span class="token punctuation">,</span>
						   BR_FAILED_REPLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> trsize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>t_from<span class="token punctuation">)</span>
				<span class="token function">binder_thread_dec_tmpref</span><span class="token punctuation">(</span>t_from<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">binder_cleanup_transaction</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">&quot;copy_to_user failed&quot;</span><span class="token punctuation">,</span>
						   BR_FAILED_REPLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ptr <span class="token operator">+=</span> trsize<span class="token punctuation">;</span>

		<span class="token function">trace_binder_transaction_received</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_stat_br</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
			     <span class="token string">&quot;%d:%d %s %d %d:%d, cmd %d size %zd-%zd ptr %016llx-%016llx\n&quot;</span><span class="token punctuation">,</span>
			     proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
			     <span class="token punctuation">(</span>cmd <span class="token operator">==</span> BR_TRANSACTION<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;BR_TRANSACTION&quot;</span> <span class="token operator">:</span>
				<span class="token punctuation">(</span>cmd <span class="token operator">==</span> BR_TRANSACTION_SEC_CTX<span class="token punctuation">)</span> <span class="token operator">?</span>
				     <span class="token string">&quot;BR_TRANSACTION_SEC_CTX&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;BR_REPLY&quot;</span><span class="token punctuation">,</span>
			     t<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span> t_from <span class="token operator">?</span> t_from<span class="token operator">-&gt;</span>proc<span class="token operator">-&gt;</span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			     t_from <span class="token operator">?</span> t_from<span class="token operator">-&gt;</span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> cmd<span class="token punctuation">,</span>
			     t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">,</span>
			     <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>trd<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
			     <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>trd<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>t_from<span class="token punctuation">)</span>
			<span class="token function">binder_thread_dec_tmpref</span><span class="token punctuation">(</span>t_from<span class="token punctuation">)</span><span class="token punctuation">;</span>
		t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>allow_user_free <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">!=</span> BR_REPLY <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
			t<span class="token operator">-&gt;</span>to_parent <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>transaction_stack<span class="token punctuation">;</span>
			t<span class="token operator">-&gt;</span>to_thread <span class="token operator">=</span> thread<span class="token punctuation">;</span>
			thread<span class="token operator">-&gt;</span>transaction_stack <span class="token operator">=</span> t<span class="token punctuation">;</span>
			<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">binder_free_transaction</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

done<span class="token operator">:</span>

	<span class="token operator">*</span>consumed <span class="token operator">=</span> ptr <span class="token operator">-</span> buffer<span class="token punctuation">;</span>
	<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>requested_threads <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
	    <span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>proc<span class="token operator">-&gt;</span>waiting_threads<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
	    proc<span class="token operator">-&gt;</span>requested_threads_started <span class="token operator">&lt;</span> proc<span class="token operator">-&gt;</span>max_threads <span class="token operator">&amp;&amp;</span>
	    <span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span>looper <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BINDER_LOOPER_STATE_REGISTERED <span class="token operator">|</span>
	     BINDER_LOOPER_STATE_ENTERED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* the user-space code fails to */</span>
	     <span class="token comment">/*spawn a new thread if we leave this out */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		proc<span class="token operator">-&gt;</span>requested_threads<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_THREADS<span class="token punctuation">,</span>
			     <span class="token string">&quot;%d:%d BR_SPAWN_LOOPER\n&quot;</span><span class="token punctuation">,</span>
			     proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">put_user</span><span class="token punctuation">(</span>BR_SPAWN_LOOPER<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token function">binder_stat_br</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> BR_SPAWN_LOOPER<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br></div></div><p>接着程序就会回到用户层：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_loop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> readbuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> BC_ENTER_LOOPER<span class="token punctuation">;</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> readbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>

		<span class="token comment">//从这里被唤醒，获取到数据 bwr</span>
        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//解析数据</span>
        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: unexpected reply?!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: io error %d %s\n&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span>
                 <span class="token class-name">uintptr_t</span> ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uintptr_t</span> end <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> size<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>ptr <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
        ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRACE</span></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;%s:\n&quot;</span><span class="token punctuation">,</span> <span class="token function">cmd_name</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//省略不相关 case</span>
        <span class="token keyword">case</span> BR_TRANSACTION_SEC_CTX<span class="token operator">:</span>
        <span class="token keyword">case</span> BR_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{</span> 
            <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> txn<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> BR_TRANSACTION_SEC_CTX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> ptr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;parse: txn too small (binder_transaction_data_secctx)!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token comment">/* BR_TRANSACTION */</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> ptr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;parse: txn too small (binder_transaction_data)!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
				<span class="token comment">//又拷贝了一次</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                txn<span class="token punctuation">.</span>secctx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">binder_dump_txn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//拿到数据后调用回调函数 func 即传入的 svcmgr_handler</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unsigned</span> rdata<span class="token punctuation">[</span><span class="token number">256</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">;</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> reply<span class="token punctuation">;</span>
                <span class="token keyword">int</span> res<span class="token punctuation">;</span>

                <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> rdata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">bio_init_from_txn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//返回值是 0</span>
                res <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">binder_free_buffer</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//走这里，发送返回数据</span>
					<span class="token comment">//res 值为 0</span>
                    <span class="token function">binder_send_reply</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//省略不相关 case</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;parse: OOPS %d\n&quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">svcmgr_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> <span class="token operator">*</span>txn_secctx<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> handle<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> strict_policy<span class="token punctuation">;</span>
    <span class="token keyword">int</span> allow_isolated<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> dumpsys_priority<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>txn <span class="token operator">=</span> <span class="token operator">&amp;</span>txn_secctx<span class="token operator">-&gt;</span>transaction_data<span class="token punctuation">;</span>

    <span class="token comment">//ALOGI(&quot;target=%p code=%d pid=%d uid=%d\n&quot;,</span>
    <span class="token comment">//      (void*) txn-&gt;target.ptr, txn-&gt;code, txn-&gt;sender_pid, txn-&gt;sender_euid);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>ptr <span class="token operator">!=</span> BINDER_SERVICE_MANAGER<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>code <span class="token operator">==</span> PING_TRANSACTION<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// Equivalent to Parcel::enforceInterface(), reading the RPC</span>
    <span class="token comment">// header with the strict mode policy mask and the interface name.</span>
    <span class="token comment">// Note that we ignore the strict_policy and don't propagate it</span>
    <span class="token comment">// further (since we do no outbound RPCs anyway).</span>
    strict_policy <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Ignore worksource header.</span>
    s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">memcmp</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;invalid id %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sehandle <span class="token operator">&amp;&amp;</span> <span class="token function">selinux_status_updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">VENDORSERVICEMANAGER</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">selabel_handle</span> <span class="token operator">*</span>tmp_sehandle <span class="token operator">=</span> <span class="token function">selinux_android_vendor_service_context_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">selabel_handle</span> <span class="token operator">*</span>tmp_sehandle <span class="token operator">=</span> <span class="token function">selinux_android_service_context_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp_sehandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">selabel_close</span><span class="token punctuation">(</span>sehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sehandle <span class="token operator">=</span> tmp_sehandle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//根据 code 调用对于函数</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> SVC_MGR_GET_SERVICE<span class="token operator">:</span>
    <span class="token keyword">case</span> SVC_MGR_CHECK_SERVICE<span class="token operator">:</span>
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        handle <span class="token operator">=</span> <span class="token function">do_find_service</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">,</span>
                                 <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> txn_secctx<span class="token operator">-&gt;</span>secctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token function">bio_put_ref</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> SVC_MGR_ADD_SERVICE<span class="token operator">:</span> <span class="token comment">//这里会执行链表插入操作</span>
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        handle <span class="token operator">=</span> <span class="token function">bio_get_ref</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        allow_isolated <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        dumpsys_priority <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">do_add_service</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">,</span> allow_isolated<span class="token punctuation">,</span> dumpsys_priority<span class="token punctuation">,</span>
                           txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> txn_secctx<span class="token operator">-&gt;</span>secctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> SVC_MGR_LIST_SERVICES<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> n <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span> req_dumpsys_priority <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">svc_can_list</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> txn_secctx<span class="token operator">-&gt;</span>secctx<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;list_service() uid=%d - PERMISSION DENIED\n&quot;</span><span class="token punctuation">,</span>
                    txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        si <span class="token operator">=</span> svclist<span class="token punctuation">;</span>
        <span class="token comment">// walk through the list of services n times skipping services that</span>
        <span class="token comment">// do not support the requested priority</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>dumpsys_priority <span class="token operator">&amp;</span> req_dumpsys_priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                n<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            si <span class="token operator">=</span> si<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">bio_put_string16</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;unknown code %d\n&quot;</span><span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//返回信息，就一个 0</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br></div></div><h2 id="_5-数据返回过程"><a href="#_5-数据返回过程" class="header-anchor">#</a> 5. 数据返回过程</h2> <p>接着看如何返回数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_send_reply</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                       <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                       <span class="token class-name">binder_uintptr_t</span> buffer_to_free<span class="token punctuation">,</span>
                       <span class="token keyword">int</span> status<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd_free<span class="token punctuation">;</span>
        <span class="token class-name">binder_uintptr_t</span> buffer<span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span> cmd_reply<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>

    data<span class="token punctuation">.</span>cmd_free <span class="token operator">=</span> BC_FREE_BUFFER<span class="token punctuation">;</span> <span class="token comment">//先执行一个 free</span>
    data<span class="token punctuation">.</span>buffer <span class="token operator">=</span> buffer_to_free<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>cmd_reply <span class="token operator">=</span> BC_REPLY<span class="token punctuation">;</span> <span class="token comment">//在来一个 reply</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> TF_STATUS_CODE<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>status<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//走这</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> reply<span class="token operator">-&gt;</span>data <span class="token operator">-</span> reply<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span>offs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span>offs0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>reply<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>reply<span class="token operator">-&gt;</span>offs0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//发起远程写操作</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//通过 ioctl 发起写操作</span>
<span class="token keyword">int</span> <span class="token function">binder_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> len<span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder_write: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span>
                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>接着陷入内核：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">binder_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ubuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

	<span class="token comment">/*pr_info(&quot;binder_ioctl: %d:%d %x %lx\n&quot;,
			proc-&gt;pid, current-&gt;pid, cmd, arg);*/</span>

	<span class="token function">binder_selftest_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">trace_binder_ioctl</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>binder_user_error_wait<span class="token punctuation">,</span> binder_stop_on_user_error <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> err_unlocked<span class="token punctuation">;</span>
	<span class="token comment">//从 proc 的 threads 红黑树中找 pid 相同的 thread ，没有就新建一个</span>
	thread <span class="token operator">=</span> <span class="token function">binder_get_thread</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> BINDER_WRITE_READ<span class="token operator">:</span> <span class="token comment">//走这</span>
		ret <span class="token operator">=</span> <span class="token function">binder_ioctl_write_read</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token comment">//省略不相关 case</span>
	<span class="token keyword">default</span><span class="token operator">:</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token comment">//......</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_ioctl_write_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>
				<span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">,</span>
				<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ubuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//......</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//走这，写数据</span>
		ret <span class="token operator">=</span> <span class="token function">binder_thread_write</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span>
					  bwr<span class="token punctuation">.</span>write_buffer<span class="token punctuation">,</span>
					  bwr<span class="token punctuation">.</span>write_size<span class="token punctuation">,</span>
					  <span class="token operator">&amp;</span>bwr<span class="token punctuation">.</span>write_consumed<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">trace_binder_write_done</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token function">binder_thread_read</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_buffer<span class="token punctuation">,</span>
					 bwr<span class="token punctuation">.</span>read_size<span class="token punctuation">,</span>
					 <span class="token operator">&amp;</span>bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span>
					 filp<span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">trace_binder_read_done</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">binder_worklist_empty_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">binder_wakeup_proc_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//......</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
out<span class="token operator">:</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//开始写数据了</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_thread_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			<span class="token class-name">binder_uintptr_t</span> binder_buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span>
			<span class="token class-name">binder_size_t</span> <span class="token operator">*</span>consumed<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_context</span> <span class="token operator">*</span>context <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>context<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>binder_buffer<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ptr <span class="token operator">=</span> buffer <span class="token operator">+</span> <span class="token operator">*</span>consumed<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>end <span class="token operator">=</span> buffer <span class="token operator">+</span> size<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>ptr <span class="token operator">&lt;</span> end <span class="token operator">&amp;&amp;</span> thread<span class="token operator">-&gt;</span>return_error<span class="token punctuation">.</span>cmd <span class="token operator">==</span> BR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_user</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">trace_binder_command</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IOC_NR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>binder_stats<span class="token punctuation">.</span>bc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_stats<span class="token punctuation">.</span>bc<span class="token punctuation">[</span><span class="token function">_IOC_NR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>stats<span class="token punctuation">.</span>bc<span class="token punctuation">[</span><span class="token function">_IOC_NR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>stats<span class="token punctuation">.</span>bc<span class="token punctuation">[</span><span class="token function">_IOC_NR</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//省略不相关 case</span>

		<span class="token keyword">case</span> BC_FREE_BUFFER<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//先走这，主要是完成内存的释放</span>
			<span class="token class-name">binder_uintptr_t</span> data_ptr<span class="token punctuation">;</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_user</span><span class="token punctuation">(</span>data_ptr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">binder_uintptr_t</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_uintptr_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			buffer <span class="token operator">=</span> <span class="token function">binder_alloc_prepare_to_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
							      data_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR_OR_NULL</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTR_ERR</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span>EPERM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">binder_user_error</span><span class="token punctuation">(</span>
						<span class="token string">&quot;%d:%d BC_FREE_BUFFER u%016llx matched unreturned or currently freeing buffer\n&quot;</span><span class="token punctuation">,</span>
						proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
						<span class="token punctuation">(</span>u64<span class="token punctuation">)</span>data_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token function">binder_user_error</span><span class="token punctuation">(</span>
						<span class="token string">&quot;%d:%d BC_FREE_BUFFER u%016llx no match\n&quot;</span><span class="token punctuation">,</span>
						proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
						<span class="token punctuation">(</span>u64<span class="token punctuation">)</span>data_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_FREE_BUFFER<span class="token punctuation">,</span>
				     <span class="token string">&quot;%d:%d BC_FREE_BUFFER u%016llx found buffer %d for %s transaction\n&quot;</span><span class="token punctuation">,</span>
				     proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>data_ptr<span class="token punctuation">,</span>
				     buffer<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
				     buffer<span class="token operator">-&gt;</span>transaction <span class="token operator">?</span> <span class="token string">&quot;active&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;finished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-&gt;</span>transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				buffer<span class="token operator">-&gt;</span>transaction<span class="token operator">-&gt;</span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				buffer<span class="token operator">-&gt;</span>transaction <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token operator">-&gt;</span>async_transaction <span class="token operator">&amp;&amp;</span> buffer<span class="token operator">-&gt;</span>target_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>buf_node<span class="token punctuation">;</span>
				<span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token operator">*</span>w<span class="token punctuation">;</span>

				buf_node <span class="token operator">=</span> buffer<span class="token operator">-&gt;</span>target_node<span class="token punctuation">;</span>
				<span class="token function">binder_node_inner_lock</span><span class="token punctuation">(</span>buf_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>buf_node<span class="token operator">-&gt;</span>has_async_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">BUG_ON</span><span class="token punctuation">(</span>buf_node<span class="token operator">-&gt;</span>proc <span class="token operator">!=</span> proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
				w <span class="token operator">=</span> <span class="token function">binder_dequeue_work_head_ilocked</span><span class="token punctuation">(</span>
						<span class="token operator">&amp;</span>buf_node<span class="token operator">-&gt;</span>async_todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					buf_node<span class="token operator">-&gt;</span>has_async_transaction <span class="token operator">=</span> false<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token function">binder_enqueue_work_ilocked</span><span class="token punctuation">(</span>
							w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">binder_wakeup_proc_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">binder_node_inner_unlock</span><span class="token punctuation">(</span>buf_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">trace_binder_transaction_buffer_release</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">binder_transaction_buffer_release</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">binder_alloc_free_buf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//.......</span>
		<span class="token keyword">case</span> BC_TRANSACTION<span class="token operator">:</span>
		<span class="token keyword">case</span> BC_REPLY<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//然后再走这里</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> tr<span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//一样的调用 binder_transaction 返回数据</span>
			<span class="token function">binder_transaction</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">,</span>
					   cmd <span class="token operator">==</span> BC_REPLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//省略不相关 case</span>

		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d unknown command %d\n&quot;</span><span class="token punctuation">,</span>
			       proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token operator">*</span>consumed <span class="token operator">=</span> ptr <span class="token operator">-</span> buffer<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br></div></div><p>接下来看一看 binder_alloc_prepare_to_free 函数的具体实现：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span><span class="token function">binder_alloc_prepare_to_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_alloc</span> <span class="token operator">*</span>alloc<span class="token punctuation">,</span>
						   uintptr_t user_ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span>

	<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	buffer <span class="token operator">=</span> <span class="token function">binder_alloc_prepare_to_free_locked</span><span class="token punctuation">(</span>alloc<span class="token punctuation">,</span> user_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>alloc<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span><span class="token function">binder_alloc_prepare_to_free_locked</span><span class="token punctuation">(</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_alloc</span> <span class="token operator">*</span>alloc<span class="token punctuation">,</span>
		uintptr_t user_ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>n <span class="token operator">=</span> alloc<span class="token operator">-&gt;</span>allocated_buffers<span class="token punctuation">.</span>rb_node<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>uptr<span class="token punctuation">;</span>

	uptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>user_ptr<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		buffer <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_buffer</span><span class="token punctuation">,</span> rb_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>buffer<span class="token operator">-&gt;</span>free<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>uptr <span class="token operator">&lt;</span> buffer<span class="token operator">-&gt;</span>user_data<span class="token punctuation">)</span>
			n <span class="token operator">=</span> n<span class="token operator">-&gt;</span>rb_left<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>uptr <span class="token operator">&gt;</span> buffer<span class="token operator">-&gt;</span>user_data<span class="token punctuation">)</span>
			n <span class="token operator">=</span> n<span class="token operator">-&gt;</span>rb_right<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">/*
			 * Guard against user threads attempting to
			 * free the buffer when in use by kernel or
			 * after it's already been freed.
			 */</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token operator">-&gt;</span>allow_user_free<span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EPERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
			buffer<span class="token operator">-&gt;</span>allow_user_free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>接着我们再来看看返回数据时，binder_transaction 是如何执行的，流程和之前的分析基本一直，只是都是走的 reply 部分：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//发起数据传输</span>
<span class="token function">binder_transaction</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tr<span class="token punctuation">,</span>cmd <span class="token operator">==</span> BC_REPLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
			       <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">,</span>
			       <span class="token class-name">binder_size_t</span> extra_buffers_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token operator">*</span>tcomplete<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> buffer_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> off_start_offset<span class="token punctuation">,</span> off_end_offset<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> off_min<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> sg_buf_offset<span class="token punctuation">,</span> sg_buf_end_offset<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>target_proc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>target_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>target_node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>in_reply_to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_log_entry</span> <span class="token operator">*</span>e<span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> return_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> return_error_param <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> return_error_line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> last_fixup_obj_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> last_fixup_min_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_context</span> <span class="token operator">*</span>context <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>context<span class="token punctuation">;</span>
	<span class="token keyword">int</span> t_debug_id <span class="token operator">=</span> <span class="token function">atomic_inc_return</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_last_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>secctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	u32 secctx_sz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	e <span class="token operator">=</span> <span class="token function">binder_transaction_log_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_transaction_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> t_debug_id<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>call_type <span class="token operator">=</span> reply <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>from_proc <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>from_thread <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>target_handle <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>data_size <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>offsets_size <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>context_name <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>context<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//走这</span>
		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// ServiceManager 收到数据时做了相关保存</span>
		<span class="token comment">// if (cmd != BR_REPLY &amp;&amp; !(t-&gt;flags &amp; TF_ONE_WAY)) {</span>
		<span class="token comment">// 	binder_inner_proc_lock(thread-&gt;proc);</span>
		<span class="token comment">// 	t-&gt;to_parent = thread-&gt;transaction_stack;</span>
		<span class="token comment">// 	t-&gt;to_thread = thread;</span>
		<span class="token comment">// 	thread-&gt;transaction_stack = t;</span>
		<span class="token comment">// 	binder_inner_proc_unlock(thread-&gt;proc);</span>
		<span class="token comment">// } </span>

		<span class="token comment">//in_reply_to 就是之前发过来的数据</span>
		in_reply_to <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>transaction_stack <span class="token punctuation">;</span>

		<span class="token comment">//错误情况的处理</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>in_reply_to <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//......</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>in_reply_to<span class="token operator">-&gt;</span>to_thread <span class="token operator">!=</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//......</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//出栈，恢复成空</span>
		thread<span class="token operator">-&gt;</span>transaction_stack <span class="token operator">=</span> in_reply_to<span class="token operator">-&gt;</span>to_parent<span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//通过收到的 binder_transaction 得到当前需要的 target_thread</span>
		target_thread <span class="token operator">=</span> <span class="token function">binder_get_txn_from_and_acq_inner</span><span class="token punctuation">(</span>in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//......</span>
		target_proc <span class="token operator">=</span> target_thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">;</span>
		target_proc<span class="token operator">-&gt;</span>tmp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>target_thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">//......</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread<span class="token punctuation">)</span>
		e<span class="token operator">-&gt;</span>to_thread <span class="token operator">=</span> target_thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>to_proc <span class="token operator">=</span> target_proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>

	<span class="token comment">/* TODO: reuse incoming transaction for reply */</span>
	t <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		return_error_param <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_alloc_t_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	tcomplete <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tcomplete<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tcomplete <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		return_error_param <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_alloc_tcomplete_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	t<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> t_debug_id<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span>
		t<span class="token operator">-&gt;</span>from <span class="token operator">=</span> thread<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		t<span class="token operator">-&gt;</span>from <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>sender_euid <span class="token operator">=</span> <span class="token function">task_euid</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>to_proc <span class="token operator">=</span> target_proc<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>to_thread <span class="token operator">=</span> target_thread<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>code <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>code<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
	    <span class="token function">binder_supported_policy</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>policy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">/* Inherit supported policies for synchronous transactions */</span>
		t<span class="token operator">-&gt;</span>priority<span class="token punctuation">.</span>sched_policy <span class="token operator">=</span> current<span class="token operator">-&gt;</span>policy<span class="token punctuation">;</span>
		t<span class="token operator">-&gt;</span>priority<span class="token punctuation">.</span>prio <span class="token operator">=</span> current<span class="token operator">-&gt;</span>normal_prio<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">/* Otherwise, fall back to the default priority */</span>
		t<span class="token operator">-&gt;</span>priority <span class="token operator">=</span> target_proc<span class="token operator">-&gt;</span>default_priority<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_node <span class="token operator">&amp;&amp;</span> target_node<span class="token operator">-&gt;</span>txn_security_ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		u32 secid<span class="token punctuation">;</span>

		<span class="token function">security_task_getsecid</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>tsk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>secid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token function">security_secid_to_secctx</span><span class="token punctuation">(</span>secid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>secctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>secctx_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			return_error_param <span class="token operator">=</span> ret<span class="token punctuation">;</span>
			return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_get_secctx_failed<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		extra_buffers_size <span class="token operator">+=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>secctx_sz<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">trace_binder_transaction</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> t<span class="token punctuation">,</span> target_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//分配内存并完成映射</span>
	t<span class="token operator">-&gt;</span>buffer <span class="token operator">=</span> <span class="token function">binder_alloc_new_buf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span>
		tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">,</span> extra_buffers_size<span class="token punctuation">,</span>
		<span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">/*
		 * -ESRCH indicates VMA cleared. The target is dying.
		 */</span>
		return_error_param <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> return_error_param <span class="token operator">==</span> <span class="token operator">-</span>ESRCH <span class="token operator">?</span>
			BR_DEAD_REPLY <span class="token operator">:</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
		t<span class="token operator">-&gt;</span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_binder_alloc_buf_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>secctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">size_t</span> buf_offset <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
				    <span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
				    <span class="token function">ALIGN</span><span class="token punctuation">(</span>extra_buffers_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span>
				    <span class="token function">ALIGN</span><span class="token punctuation">(</span>secctx_sz<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		t<span class="token operator">-&gt;</span>security_ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>user_data <span class="token operator">+</span> buf_offset<span class="token punctuation">;</span>
		<span class="token function">binder_alloc_copy_to_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
					    t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span> buf_offset<span class="token punctuation">,</span>
					    secctx<span class="token punctuation">,</span> secctx_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">security_release_secctx</span><span class="token punctuation">(</span>secctx<span class="token punctuation">,</span> secctx_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
		secctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> t<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>transaction <span class="token operator">=</span> t<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>target_node <span class="token operator">=</span> target_node<span class="token punctuation">;</span>
	<span class="token function">trace_binder_transaction_alloc_buf</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//将用户空间的数据拷贝到内核空间的 t-&gt;buffer，这里拷贝的是数据区</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_alloc_copy_user_to_buffer</span><span class="token punctuation">(</span>
				<span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
				t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>
					<span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
				tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid data ptr\n&quot;</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将用户空间的数据拷贝到内核空间的 t-&gt;buffer，这里拷贝的是偏移区</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_alloc_copy_user_to_buffer</span><span class="token punctuation">(</span>
				<span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
				t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>
				<span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>
					<span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span>
				tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid offsets ptr\n&quot;</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//......</span>
	off_start_offset <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	buffer_offset <span class="token operator">=</span> off_start_offset<span class="token punctuation">;</span>
	off_end_offset <span class="token operator">=</span> off_start_offset <span class="token operator">+</span> tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">;</span>
	sg_buf_offset <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>off_end_offset<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sg_buf_end_offset <span class="token operator">=</span> sg_buf_offset <span class="token operator">+</span> extra_buffers_size<span class="token punctuation">;</span>
	off_min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>buffer_offset <span class="token operator">=</span> off_start_offset<span class="token punctuation">;</span> buffer_offset <span class="token operator">&lt;</span> off_end_offset<span class="token punctuation">;</span>
	     buffer_offset <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//每次读 64 字节</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span> <span class="token operator">*</span>hdr<span class="token punctuation">;</span>
		<span class="token class-name">size_t</span> object_size<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_object</span> object<span class="token punctuation">;</span>
		<span class="token class-name">binder_size_t</span> object_offset<span class="token punctuation">;</span>

		<span class="token function">binder_alloc_copy_from_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
					      <span class="token operator">&amp;</span>object_offset<span class="token punctuation">,</span>
					      t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>
					      buffer_offset<span class="token punctuation">,</span>
					      <span class="token keyword">sizeof</span><span class="token punctuation">(</span>object_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		object_size <span class="token operator">=</span> <span class="token function">binder_get_object</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>
						object_offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>object_size <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> object_offset <span class="token operator">&lt;</span> off_min<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid offset (%lld, min %lld max %lld) or object.\n&quot;</span><span class="token punctuation">,</span>
					  proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
					  <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>object_offset<span class="token punctuation">,</span>
					  <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>off_min<span class="token punctuation">,</span>
					  <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
			return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_bad_offset<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		hdr <span class="token operator">=</span> <span class="token operator">&amp;</span>object<span class="token punctuation">.</span>hdr<span class="token punctuation">;</span>
		off_min <span class="token operator">=</span> object_offset <span class="token operator">+</span> object_size<span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>hdr<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> BINDER_TYPE_BINDER<span class="token operator">:</span>
		<span class="token keyword">case</span> BINDER_TYPE_WEAK_BINDER<span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>fp<span class="token punctuation">;</span>

			fp <span class="token operator">=</span> <span class="token function">to_flat_binder_object</span><span class="token punctuation">(</span>hdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">binder_translate_binder</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> t<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				return_error_param <span class="token operator">=</span> ret<span class="token punctuation">;</span>
				return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_translate_failed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">binder_alloc_copy_to_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>alloc<span class="token punctuation">,</span>
						    t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span> object_offset<span class="token punctuation">,</span>
						    fp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		
		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%d got transaction with invalid object type, %x\n&quot;</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> hdr<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			return_error_param <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
			return_error_line <span class="token operator">=</span> <span class="token constant">__LINE__</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_bad_object_type<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	tcomplete<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION_COMPLETE<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>work<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//插入 binder_work</span>
		<span class="token comment">// 唤醒 Server 端</span>
		<span class="token function">binder_enqueue_thread_work</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> tcomplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread<span class="token operator">-&gt;</span>is_dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_dead_proc_or_thread<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_pop_transaction_ilocked</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">,</span> in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_enqueue_thread_work_ilocked</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wake_up_interruptible_sync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>target_thread<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_restore_priority</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> in_reply_to<span class="token operator">-&gt;</span>saved_priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_free_transaction</span><span class="token punctuation">(</span>in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//......</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">//........</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread<span class="token punctuation">)</span>
		<span class="token function">binder_thread_dec_tmpref</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_proc_dec_tmpref</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token punctuation">)</span>
		<span class="token function">binder_dec_node_tmpref</span><span class="token punctuation">(</span>target_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	 * write barrier to synchronize with initialization
	 * of log entry
	 */</span>
	<span class="token function">smp_wmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">WRITE_ONCE</span><span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>debug_id_done<span class="token punctuation">,</span> t_debug_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br></div></div><p>接着 Server 端被唤醒：</p> <p>Server 端在完成写操作后，会立即进入读操作，并阻塞，当 ServiceManager 发回返回数据时被唤醒：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_ioctl_write_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>
				<span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">,</span>
				<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> __user <span class="token operator">*</span>ubuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>

    <span class="token comment">//......</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token function">binder_thread_write</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span>
					  bwr<span class="token punctuation">.</span>write_buffer<span class="token punctuation">,</span>
					  bwr<span class="token punctuation">.</span>write_size<span class="token punctuation">,</span>
					  <span class="token operator">&amp;</span>bwr<span class="token punctuation">.</span>write_consumed<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//写完以后接着读返回的信息，阻塞在这里</span>
	<span class="token comment">//ServiceManager 将其从这里唤醒</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token function">binder_thread_read</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_buffer<span class="token punctuation">,</span>
					 bwr<span class="token punctuation">.</span>read_size<span class="token punctuation">,</span>
					 <span class="token operator">&amp;</span>bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span>
					 filp<span class="token operator">-&gt;</span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">trace_binder_read_done</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">binder_worklist_empty_ilocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">binder_wakeup_proc_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>bwr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
out<span class="token operator">:</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>接着就回到了应用层：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_call</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   
    <span class="token comment">//......</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>

		<span class="token comment">//从这里唤醒</span>
        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 

	    <span class="token comment">//解析返回的数据</span>
        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

	<span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>解析返回数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span>
                 <span class="token class-name">uintptr_t</span> ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uintptr_t</span> end <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> size<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>ptr <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
        ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRACE</span></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;%s:\n&quot;</span><span class="token punctuation">,</span> <span class="token function">cmd_name</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//...... 省略部分代码</span>
        <span class="token keyword">case</span> BR_REPLY<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>txn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> ptr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>txn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;parse: reply too small!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">binder_dump_txn</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bio<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//数据放到 bio 中，即上一层传入的 reply</span>
                <span class="token function">bio_init_from_txn</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                bio <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/* todo FREE BUFFER */</span>
            <span class="token punctuation">}</span>
            ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//省略部分代码 ......</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>binder_parse 返回 0，收到的数据保存在 reply 中：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_call</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">//binder_parse 返回</span>
        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回值是 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>binder_call 返回到 svcmgr_publish</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">svcmgr_publish</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//......</span>

    <span class="token comment">//binder_call 返回 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_call</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> target<span class="token punctuation">,</span> SVC_MGR_ADD_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//fprintf(stderr, &quot;svcmgr_public 远程调用失败\n&quot;);</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">//解析返回值</span>
    <span class="token comment">//解析出的值是 0 表示调用成功</span>
    status <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用成功返回0</span>
    <span class="token comment">//远程调用结束，通知驱动清理内存</span>
    <span class="token function">binder_done</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> status<span class="token punctuation">;</span> <span class="token comment">//返回 0 给 main 主程序，调用成功</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>最后调用 binder_done 通知驱动清理内存:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_done</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                 __unused <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                 <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
        <span class="token class-name">uintptr_t</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BIO_F_SHARED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>cmd <span class="token operator">=</span> BC_FREE_BUFFER<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
        <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reply<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这里陷入内核执行一个 BC_FREE_BUFFER 操作，上文已做分析，这里不在重复</p> <p>至此，服务的注册过程就完成了</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li>《Android 框架解密》</li> <li><a href="http://gityuan.com/2015/11/01/binder-driver/" target="_blank" rel="noopener noreferrer">Binder系列1—Binder Driver初探<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/7069675794028560391" target="_blank" rel="noopener noreferrer">Android源码分析 - Binder驱动（中）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/7073783503791325214" target="_blank" rel="noopener noreferrer">Android源码分析 - Binder驱动（下）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://paul.pub/android-binder-driver/" target="_blank" rel="noopener noreferrer">理解Android Binder机制(1/3)：驱动篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://tinylab.org/lwn-550463/" target="_blank" rel="noopener noreferrer">更好的 Shrinker 机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/yangwen123/article/details/9100599" target="_blank" rel="noopener noreferrer">Android Binder通信数据结构介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://kernel.meizu.com/android-binder.html" target="_blank" rel="noopener noreferrer">Android Binder 魅族团队<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="关于"><a href="#关于" class="header-anchor">#</a> 关于</h2> <p>我叫阿豪，2015 年本科毕业于国防科学技术大学指挥信息系统专业，毕业后从事信息化装备的研发工作，主要研究方向是 Android Framework 与 Linux Kernel。</p> <p>如果你对 Android Framework 感兴趣或者正在学习 Android Framework，可以关注我的微信公众号和抖音，我会持续分享我的学习经验，帮助正在学习的你少走一些弯路。学习过程中如果你有疑问或者你的经验想要分享给大家可以添加我的微信，我拉你进技术交流群。</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg" alt=""></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/007.Binder 驱动情景分析之 ServiceManager 启动过程.html" class="prev">
          8.Binder 驱动情景分析之 ServiceManager 启动过程
        </a></span> <span class="next"><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/009.Binder 驱动情景分析之服务获取与使用过程.html">
          10.Binder 驱动情景分析之服务获取与使用过程
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/AndroidFrameworkTutorialPages/assets/js/app.a5dad8b6.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/81.fec13824.js" defer></script>
  </body>
</html>
