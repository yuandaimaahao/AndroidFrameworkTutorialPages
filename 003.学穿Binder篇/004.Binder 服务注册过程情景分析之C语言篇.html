<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Binder 服务注册过程情景分析之 C 语言篇 | Android Framework</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css" as="style"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/app.a5dad8b6.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/77.57d6d63d.js" as="script"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/10.337b766a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/100.1af765a2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/101.e96f0d69.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/102.b4e844a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/103.7fd8b73f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/104.3027cd01.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/105.1d287f51.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/106.775741ca.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/107.3c18da36.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/108.bc5b9d09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/109.6d0bfeff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/11.be2e0167.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/110.fb6f0c28.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/111.16370887.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/112.c7849d37.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/113.2ad757fa.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/114.8e71b0e4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/115.8ff602ee.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/116.43fbb597.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/117.0f8b1a2b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/118.4f51c7fd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/119.dc4ce472.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/120.0c35e50f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/121.d6ce64e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/122.afb666c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/123.a78c9f32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/124.cda8de32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/125.24ec5bd0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/126.69e9053c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/127.7c1ca90f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/128.35da468e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/129.0add3757.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/130.bd1f91fa.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/131.fe641bce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/132.2aee8a67.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/133.02c0e89d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/134.5e724532.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/135.b1c2411f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/136.844acb24.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/137.b9fa8a82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/138.78b4a9d7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/139.bb0caf5b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/14.7d944ea8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/140.c24c1c08.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/141.397612b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/142.c21a8fa4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/143.47e3beb6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/144.8d4b76d0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/145.5e7bedeb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/146.90e8ff0b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/147.0c73c160.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/148.613f0013.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/149.c72f81b8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/15.bf19b574.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/150.82fbb5a7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/151.339a1276.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/152.62bc0603.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/153.d4db757f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/154.7a80eb2c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/155.46d6d977.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/156.f032bb76.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/157.34314806.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/158.92790a71.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/159.a2d23ebb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/16.91ebb564.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/160.0179cfaf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/161.e9960d05.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/162.456e6e1b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/163.245efdf2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/164.33654df0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/165.d2f7f7bf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/166.b00be4c6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/167.2e76ebcc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/168.cc793aa2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/169.4233d468.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/17.bfe50ee3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/170.154bf18a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/171.9a47af6a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/172.2df208f4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/173.db64d3bc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/174.76ed09e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/18.05ccfb53.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/19.afa41ba1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/20.e9510ad7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/21.86ad6466.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/22.09086018.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/23.62e146ab.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/24.36df6bff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/25.99201ee4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/26.0dad3cd4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/27.be36597a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/28.4a19ff25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/29.5c2b113e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/3.97bbbdc8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/30.38a9b8bb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/31.0d5a08c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/32.804ecc25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/33.a8e71e21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/34.da185bf8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/35.e45072d9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/36.b81c8de2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/37.f26d2d52.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/38.057aa3b4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/39.8de59f74.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/4.983d15c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/40.b47d4570.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/41.516c396f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/42.b405090a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/43.4f3cf1ea.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/44.9020abbc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/45.76ee68b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/46.24ca3ec6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/47.ce306e3f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/48.594e18b2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/49.1ac45e0a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/5.574f6fbb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/50.5cf1e47d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/51.037e5442.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/52.141d9248.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/53.6b1fbef2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/54.e55084df.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/55.9e651b61.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/56.ac520841.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/57.63b15773.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/58.9810e4ec.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/59.61908f2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/6.a4122f72.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/60.a8c87ab2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/61.5f078d82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/62.7f4a403f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/63.8c484ea1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/64.cc875fce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/65.82180ec7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/66.2eb988a8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/67.6bdd390f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/68.c83deb44.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/69.add77acc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/70.25f6b2ba.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/71.e5e79631.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/72.d0b4c7a1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/73.914aa049.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/74.731ff6ad.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/75.41ae114b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/76.3707b690.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/78.32d3f538.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/79.86fe3a2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/8.9d6eb8a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/80.c048f8e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/81.fec13824.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/82.ef5208fd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/83.ca729155.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/84.a8042c7e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/85.1b1e7f09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/86.702f2cd5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/87.7a90d741.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/88.8da58920.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/89.72be0795.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/9.bee9eff5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/90.34ba496d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/91.90e76ecb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/92.e6126fdf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/93.d83bc007.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/94.c2341ec2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/95.9f2d2ece.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/96.1e7ed15a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/97.fb305dd8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/98.50e603c5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/99.72017f6d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/vendors~docsearch.833ce4c0.js">
    <link rel="stylesheet" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Android Framework</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AndroidFrameworkTutorialPages/" class="home-link router-link-active"><!----> <span class="site-name">Android Framework</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>130</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <!----> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习路线与指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>玩转AOSP篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>学穿Binder篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/000.Binder 专题导学 —— 如何深入掌握 Binder.html" class="sidebar-link">1.专题导学 —— 如何深入掌握 Binder</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/001.学习 Binder 的预备知识.html" class="sidebar-link">2.学习 Binder 的预备知识</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/002.Binder 基本原理.html" class="sidebar-link">3.Binder 基本原理</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/003.Binder 程序示例之C语言篇.html" class="sidebar-link">4.Binder 程序示例之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/004.Binder 服务注册过程情景分析之C语言篇.html" class="active sidebar-link">5.Binder 服务注册过程情景分析之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/005.Binder 服务获取与使用过程情景分析之C语言篇.html" class="sidebar-link">6.Binder 服务获取与使用过程情景分析之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/006.Android Binder 驱动框架设计分析.html" class="sidebar-link">7.Android Binder 驱动框架设计分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/007.Binder 驱动情景分析之 ServiceManager 启动过程.html" class="sidebar-link">8.Binder 驱动情景分析之 ServiceManager 启动过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/008.Binder 驱动情景分析之服务注册过程.html" class="sidebar-link">9.Binder 驱动情景分析之服务注册过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/009.Binder 驱动情景分析之服务获取与使用过程.html" class="sidebar-link">10.Binder 驱动情景分析之服务获取与使用过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/010.Binder 程序示例之C++篇.html" class="sidebar-link">11.Binder 程序示例之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/011.Binder C++ 程序分析之主要类解析.html" class="sidebar-link">12.Binder C++ 程序分析之主要类解析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/012.Binder 服务注册过程情景分析之C++篇.html" class="sidebar-link">13.Binder 服务注册过程情景分析之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/013.Binder 服务获取与使用过程情景分析之C++篇.html" class="sidebar-link">14.Binder 服务获取与使用过程情景分析之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/014.Binder 程序示例之 aidl-cpp 篇.html" class="sidebar-link">15.Binder 程序示例之 aidl-cpp 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/015.添加 Native 系统服务.html" class="sidebar-link">16.添加 Native 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/016.添加 Native 系统服务回调.html" class="sidebar-link">17.添加 Native 系统服务回调</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/017.Binder 程序示例之 Java 篇.html" class="sidebar-link">18.Binder 程序示例之 Java 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/018.Binder Java 层初始化.html" class="sidebar-link">19.Binder Java 层初始化</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/019.Binder Java 层服务注册过程分析.html" class="sidebar-link">20.Binder Java 层服务注册过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/020.Binder Java 层服务获取与使用过程分析.html" class="sidebar-link">21.Binder Java 层服务获取与使用过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/021.添加 Java 系统服务.html" class="sidebar-link">22.添加 Java 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/022.Android Java 系统服务框架与第三方 App 使用自定义 Java 系统服务.html" class="sidebar-link">23.Android Java 系统服务框架与第三方 App 使用自定义 Java 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/023.添加 Java 系统服务回调.html" class="sidebar-link">24.添加 Java 系统服务回调</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/024.AIDL 数据类型详解之 Java 篇.html" class="sidebar-link">25.AIDL 数据类型详解之 Java 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/025.AIDL 数据类型详解之 C++ 篇.html" class="sidebar-link">26.AIDL 数据类型详解之 C++ 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/026.Java 调用 Native 服务.html" class="sidebar-link">27.Java 调用 Native 服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/027.Native 调用 Java 服务.html" class="sidebar-link">28.Native 调用 Java 服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/028.AIDL 关键字 in out inout oneway 解析.html" class="sidebar-link">29.AIDL 关键字 in out inout oneway 解析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/029.Binder 驱动 Debug 入门指南.html" class="sidebar-link">30.Binder 驱动 Debug 入门指南</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/030.Binder 匿名服务源码分析.html" class="sidebar-link">031.Binder 匿名服务源码分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/031.Binder 中的 Parcel 数据结构分析（C++）.html" class="sidebar-link">032.Binder 中的 Parcel 数据结构分析（C++）</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/032.Binder 中的 Parcel 数据结构分析（Java）.html" class="sidebar-link">033.Binder 中的 Parcel 数据结构分析（Java）</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/033.Binder 多线程情景分析.html" class="sidebar-link">034.Binder 多线程情景分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/034.Binder 线程池溢出问题.html" class="sidebar-link">035.Binder 线程池溢出问题</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/035.Binder 代理对象泄露问题分析.html" class="sidebar-link">036.Binder 代理对象泄露问题分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/036.Binder 死亡通知情景分析.html" class="sidebar-link">037.Binder 死亡通知情景分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/037.Binder 异常处理机制.html" class="sidebar-link">038.Binder 异常处理机制</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/039.Binder 面试题汇总.html" class="sidebar-link">039.Binder 面试题汇总</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础组件篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统启动篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>应用层框架篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hal 与硬件服务篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图形系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>输入系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统应用篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>构造系统篇</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Binder 服务注册过程情景分析之 C 语言篇</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">Binder 服务注册过程情景分析之 C 语言篇</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>阿豪</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/3/2023</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/AndroidFrameworkTutorialPages/003.%E5%AD%A6%E7%A9%BFBinder%E7%AF%87/004.Binder%20%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90%E4%B9%8BC%E8%AF%AD%E8%A8%80%E7%AF%87.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><p>本文基于 <code>Android 10</code> 源码环境。</p> <p>在<a href="https://juejin.cn/post/7210245482861264955" target="_blank" rel="noopener noreferrer">Binder 示例程序之 C 语言篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中我们介绍了使用 C 语言完成的最简单的 Binder 示例程序，接下来我们开始详细分析这个示例中服务注册的过程。</p> <p>服务的注册过程分为以下几个步骤：</p> <ul><li>系统启动 ServiceManager</li> <li>Server 端发起服务注册请求</li> <li>ServiceManager 收到服务注册请求，完成服务注册，发送应答消息给 Server</li> <li>Server 收到并处理应答数据</li></ul> <h2 id="_1-binder-服务注册过程第一阶段-servicemanager-启动"><a href="#_1-binder-服务注册过程第一阶段-servicemanager-启动" class="header-anchor">#</a> 1. Binder 服务注册过程第一阶段——ServiceManager 启动</h2> <p>ServerManager由系统实现，对应的代码在：<code>frameworks/native/cmds/servicemanager/service_manager.c</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        driver <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        driver <span class="token operator">=</span> <span class="token string">&quot;/dev/binder&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关注点1，初始化 binder 驱动</span>
    bs <span class="token operator">=</span> <span class="token function">binder_open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> <span class="token number">128</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//省略 VENDORSERVICEMANAGER 相关代码 ......</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open binder driver %s\n&quot;</span><span class="token punctuation">,</span> driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关注点2， 注册当前进程为 context_manager</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_become_context_manager</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;cannot become context manager (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 省略 selinux 相关代码 ......</span>
    <span class="token comment">//关注点3</span>
    <span class="token comment">//进入循环，等待远程调用</span>
    <span class="token comment">//svcmgr_handler 是一个函数指针，是远程调用的回调函数</span>
    <span class="token function">binder_loop</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> svcmgr_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ul><li>关注点1：调用 <code>binder_open</code> 函数，完成驱动初始化</li> <li>关注点2：通过 <code>binder_become_context_manager</code> 函数将当前线程注册为 contextmanager</li> <li>关注点3：进入循环，调用 <code>binder_loop</code> 函数进入循环</li></ul> <p>整体工作流程如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174033.png" alt=""></p> <h3 id="_1-1-binder-open-实现分析"><a href="#_1-1-binder-open-实现分析" class="header-anchor">#</a> 1.1 binder_open 实现分析</h3> <p><strong>关注点1</strong>调用 binder_open 完成 Binder 驱动初始化。</p> <p>binder_open 的使用方法如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>bs <span class="token operator">=</span> <span class="token function">binder_open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/binder&quot;</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>binder_open 的实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// driver 通常是 &quot;/dev/binder&quot;</span>
<span class="token comment">// mapsize 是需要 mmap 的内存的大小</span>
<span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span><span class="token function">binder_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> driver<span class="token punctuation">,</span> <span class="token class-name">size_t</span> mapsize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">;</span> <span class="token comment">//用于存需要返回的值</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_version</span> vers<span class="token punctuation">;</span> 

    bs <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errno <span class="token operator">=</span> ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//O_CLOEXEC 是一种标志，用于在打开文件时告诉操作系统，当调用 exec 函数时该文件描述符应该被关闭。O_CLOEXEC 的作用是避免文件描述符被继承到子进程中。</span>
    <span class="token comment">//打开 /dev/binder，拿到内核返回的句柄</span>
    bs<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder: cannot open %s (%s)\n&quot;</span><span class="token punctuation">,</span>
                driver<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_open<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//查询版本</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_VERSION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>vers<span class="token punctuation">.</span>protocol_version <span class="token operator">!=</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
                <span class="token string">&quot;binder: kernel driver version (%d) differs from user space version (%d)\n&quot;</span><span class="token punctuation">,</span>
                vers<span class="token punctuation">.</span>protocol_version<span class="token punctuation">,</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_open<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//完成内存映射</span>
    bs<span class="token operator">-&gt;</span>mapsize <span class="token operator">=</span> mapsize<span class="token punctuation">;</span>
    bs<span class="token operator">-&gt;</span>mapped <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> mapsize<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>mapped <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder: cannot map device (%s)\n&quot;</span><span class="token punctuation">,</span>
                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> bs<span class="token punctuation">;</span>

fail_map<span class="token operator">:</span>
    <span class="token function">close</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
fail_open<span class="token operator">:</span>
    <span class="token function">free</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>其中 <code>struct binder_state *bs</code> 结构如下：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">binder_state</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>mapped<span class="token punctuation">;</span>
    size_t mapsize<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>用于保存 binder_open 的返回结果。</p> <p><code>binder_open</code> 的工作比较简单，分为以下几步：</p> <ol><li>通过系统调用 open() 来打开 <code>/dev/binder</code>，获得一个文件句柄信息。</li> <li>通过 ioctl 获取 binder 的版本信息，比较 binder 协议版本是否相同，不同则跳出。</li> <li>通过 mmap 内存映射 128K 的内存空间，即把 binder 驱动文件的 128K 字节映射到了内存空间。</li></ol> <p>很多面试喜欢问 binder 数据传输大小的限制，答案就在 binder mmap 函数的第二个参数，对于 ServiceManager 来说限制就是 128k（传输大小限制分多种情况，会在面试题部分详细讲解）。</p> <h3 id="_1-2-binder-become-context-manager-实现分析"><a href="#_1-2-binder-become-context-manager-实现分析" class="header-anchor">#</a> 1.2 binder_become_context_manager 实现分析</h3> <p><strong>关注点2</strong>调用 binder_become_context_manager 函数，将当前进程注册为整个系统中唯一的上下文管理器。</p> <p>具体实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_become_context_manager</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//构建需要发送的数据 flat_binder_object</span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> obj<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>flags <span class="token operator">=</span> FLAT_BINDER_FLAG_TXN_SECURITY_CTX<span class="token punctuation">;</span>

    <span class="token comment">//向 Binder 驱动发送数据</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_SET_CONTEXT_MGR_EXT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果失败，使用原始方式再次调用 ioctl</span>
    <span class="token comment">// fallback to original method</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">android_errorWriteLog</span><span class="token punctuation">(</span><span class="token number">0x534e4554</span><span class="token punctuation">,</span> <span class="token string">&quot;121035042&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        result <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_SET_CONTEXT_MGR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>流程如下：</p> <ul><li>构建需要发送的结构体 flat_binder_object</li> <li>通过 ioctl 将构造好的数据发送给 Binder 驱动，使用的协议是 BINDER_SET_CONTEXT_MGR_EXT</li> <li>如果失败，使用原始方式再次调用 ioctl</li></ul> <h3 id="_1-3-binder-loop-实现分析"><a href="#_1-3-binder-loop-实现分析" class="header-anchor">#</a> 1.3 binder_loop 实现分析</h3> <p><strong>关注点3</strong> 调用 binder_loop 进入循环，等待远程调用。</p> <p>binder_loop 的实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_loop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token comment">//ioctl 读写数据类型</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> readbuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//告诉驱动，应用程序要进入循环了</span>
    readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> BC_ENTER_LOOPER<span class="token punctuation">;</span>
    <span class="token comment">//ioctl 的基本封装</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> readbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//从驱动读数据</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>

        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//解析收到的数据，func 是解析好数据后的回调函数</span>
        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: unexpected reply?!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: io error %d %s\n&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174054.png" alt=""></p> <ol><li>调用 ioctl + BC_ENTER_LOOPER 告诉驱动，应用进程即将进入循环</li> <li>进入 for 循环，ioctl + BINDER_WRITE_READ 向驱动读取数据，读到的数据格式为 binder_write_read</li> <li>调用 binder_parse 会解析 binder_write_read，并将其转换为 binder_transaction_data 和 binder_io</li> <li>调用 func 函数指针，并将解析好的数据 binder_transaction_data 和 binder_io 传给 func 函数</li> <li>进入下一个循环周期，继续从驱动读取数据</li></ol> <p>进程调用 <code>binder_loop</code> 后，会进入读取数据，解析数据的循环。这样 Binder Server 才能一直运行下去。</p> <p>ServiceManager中，binder_loop 的调用方式如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">binder_loop</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> svcmgr_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中 svcmgr_handler 是一个函数指针，是收到远程调用后的回调，其实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//txn_secctx msg 是调用方发来的数据</span>
<span class="token comment">//reply 是返回给调用方的数据</span>
<span class="token keyword">int</span> <span class="token function">svcmgr_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> <span class="token operator">*</span>txn_secctx<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>调用 <code>binder_loop</code> 后，进程收到的 binder 数据格式为 <code>binder_write_read</code>，将数据解析为 <code>binder_transaction_data_secctx binder_io</code> 后就会调用 <code>binder_loop</code> 传入的函数指针,并传入解析好的数据。</p> <p>接下来我们先分析 binder_loop 涉及到的数据结构：</p> <p>binder_io 可以理解为一个数据集合，数据发送端将数据按照一定的顺序写入集合，数据接受端按照相同的顺序读取数据。</p> <p>binder_io 的使用方法如下：</p> <p>数据发送端：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> iodata<span class="token punctuation">[</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">;</span>

<span class="token comment">/* 构造binder_io */</span>
<span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> iodata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iodata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// strict mode header</span>
<span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token string">&quot;IHelloService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 放入参数 */</span>
<span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>数据接收端：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>strict_policy <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//&quot;IHelloService&quot;</span>
s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// name</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来我们看看 binder_io 的具体实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">binder_io</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>            <span class="token comment">/* pointer to read/write from */</span>
    <span class="token class-name">binder_size_t</span> <span class="token operator">*</span>offs<span class="token punctuation">;</span>   <span class="token comment">/* array of offsets */</span>
    <span class="token class-name">size_t</span> data_avail<span class="token punctuation">;</span>     <span class="token comment">/* bytes available in data buffer */</span>
    <span class="token class-name">size_t</span> offs_avail<span class="token punctuation">;</span>     <span class="token comment">/* entries available in offsets array */</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>data0<span class="token punctuation">;</span>           <span class="token comment">/* start of data buffer */</span>
    <span class="token class-name">binder_size_t</span> <span class="token operator">*</span>offs0<span class="token punctuation">;</span>  <span class="token comment">/* start of offsets buffer */</span>
    <span class="token class-name">uint32_t</span> flags<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> unused<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>binder_io 的初始化过程：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//初始化过程</span>
<span class="token keyword">unsigned</span> iodata<span class="token punctuation">[</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">;</span>
<span class="token comment">//初始化 binder_io </span>
<span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> iodata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iodata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>
              <span class="token class-name">size_t</span> maxdata<span class="token punctuation">,</span> <span class="token class-name">size_t</span> maxoffs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> n <span class="token operator">=</span> maxoffs <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//溢出处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> maxdata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bio<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> BIO_F_OVERFLOW<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data_avail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>offs_avail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将 bio 一分为二</span>
    bio<span class="token operator">-&gt;</span>data <span class="token operator">=</span> bio<span class="token operator">-&gt;</span>data0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> data <span class="token operator">+</span> n<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>offs <span class="token operator">=</span> bio<span class="token operator">-&gt;</span>offs0 <span class="token operator">=</span> data<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>data_avail <span class="token operator">=</span> maxdata <span class="token operator">-</span> n<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>offs_avail <span class="token operator">=</span> maxoffs<span class="token punctuation">;</span>
    bio<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>从 binder_io 的定义和初始化过程中可以看出，binder_io 用于管理一块内存，同时将内存分为了两部分管理：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174106.png" alt=""></p> <p>为方便叙述，本文称这两个区为偏移区和数据区。</p> <p>maxdata 是这块内存总的字节数，偏移区的大小为 n 字节，其中 n = maxoffs * sizeof(size_t)，数据区的大小为 maxdata - n</p> <p>两块内存如何使用？</p> <p>接下来我们看看如何将一个 unit32_t 数据存入 binder_io：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//分配内存</span>
    <span class="token class-name">uint32_t</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">bio_alloc</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span>
        <span class="token operator">*</span>ptr <span class="token operator">=</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//在 binder_io 的第二部分分配 size 大小的内存</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">bio_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    <span class="token comment">//size 最终等于 4,8,12,16,20 ......</span>
    <span class="token comment">//size 的值比原始的值大</span>
    size <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//溢出操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> bio<span class="token operator">-&gt;</span>data_avail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bio<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> BIO_F_OVERFLOW<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//分配位置</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> bio<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data_avail <span class="token operator">-=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>写入一个 32 位整数的过程如下：</p> <ul><li>在数据区分配 4 字节倍数的数据</li> <li>将整数值写入已分配的内存</li></ul> <p>写入后一个 <code>uint32_t n</code> 后，内存结构如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174117.png" alt=""></p> <p>字符串的写入稍微复杂一点，但是本质原理和写入 unit_32 相同，有兴趣的同学可以自行分析下面的代码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>_str<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> _str<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>MAX_BIO_SIZE <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Note: The payload will carry 32bit size instead of size_t */</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr <span class="token operator">=</span> <span class="token function">bio_alloc</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ptr<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
        <span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>接下来我们看看，如何在 binder_io 中存一个指针数据。（在服务注册场景下，这个指针指向一个函数，是 server 端收到调用后的回调函数）</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">bio_put_obj</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>obj<span class="token punctuation">;</span>

    <span class="token comment">//分配内存</span>
    obj <span class="token operator">=</span> <span class="token function">bio_alloc_obj</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    obj<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0x7f</span> <span class="token operator">|</span> FLAT_BINDER_FLAG_ACCEPTS_FDS<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>hdr<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_TYPE_BINDER<span class="token punctuation">;</span>
    <span class="token comment">//ptr 保存在 flat_binder_object 的 binder 成员中</span>
    obj<span class="token operator">-&gt;</span>binder <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>ptr<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span><span class="token function">bio_alloc_obj</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>obj<span class="token punctuation">;</span>
    <span class="token comment">//在数据区分配内存</span>
    obj <span class="token operator">=</span> <span class="token function">bio_alloc</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//在第一部分保存偏移量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">&amp;&amp;</span> bio<span class="token operator">-&gt;</span>offs_avail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bio<span class="token operator">-&gt;</span>offs_avail<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>bio<span class="token operator">-&gt;</span>offs<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> bio<span class="token operator">-&gt;</span>data0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    bio<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> BIO_F_OVERFLOW<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span>	hdr<span class="token punctuation">;</span>
	__u32				flags<span class="token punctuation">;</span>

	<span class="token comment">/* 8 bytes of data. */</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token class-name">binder_uintptr_t</span>	binder<span class="token punctuation">;</span>	<span class="token comment">/* local object */</span>
		__u32			handle<span class="token punctuation">;</span>	<span class="token comment">/* remote object */</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">/* extra data associated with local object */</span>
	<span class="token class-name">binder_uintptr_t</span>	cookie<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">binder_object_header</span> <span class="token punctuation">{</span>
	__u32        type<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>对于指针类型，会在数据区分配一个 flat_binder_object 结构体的数据，将指针数据保存在结构体的 binder 成员中。在偏移区将 flat_binder_object 相对 data0 的偏移值保存在 offs 指向的内存，offs 再加 1。完成数据保存后，其内存结构如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174129.png" alt=""></p> <p>这里给出一个 binder_io 结构示例，以加深理解：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174139.png" alt=""></p> <p>binder_transaction_data_secctx 是一个简单的封装，我们需要的数据大部分都保存在 binder_transaction_data 中：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> transaction_data<span class="token punctuation">;</span>
	<span class="token class-name">binder_uintptr_t</span> secctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token punctuation">{</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		__u32	handle<span class="token punctuation">;</span>
		<span class="token class-name">binder_uintptr_t</span> ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> target<span class="token punctuation">;</span>
	<span class="token class-name">binder_uintptr_t</span>	cookie<span class="token punctuation">;</span>
	__u32		code<span class="token punctuation">;</span>

	__u32	        flags<span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span>		sender_pid<span class="token punctuation">;</span>
	<span class="token class-name">uid_t</span>		sender_euid<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span>	data_size<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span>	offsets_size<span class="token punctuation">;</span>

	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token class-name">binder_uintptr_t</span>	buffer<span class="token punctuation">;</span>
			<span class="token class-name">binder_uintptr_t</span>	offsets<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> ptr<span class="token punctuation">;</span>
		__u8	buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>接下来再回头来看 binder_loop 具体实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_loop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token comment">//ioctl 读写数据类型</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> readbuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//告诉驱动，应用程序要进入循环了</span>
    readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> BC_ENTER_LOOPER<span class="token punctuation">;</span>
    <span class="token comment">//ioctl 的基本封装</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> readbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//结合上面 bwr 的赋值，这里是要读数据</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>
        <span class="token comment">//向驱动发起读操作</span>
        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: unexpected reply?!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;binder_loop: io error %d %s\n&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//binder_write 是对 ioctl + BINDER_WRITE_READ 写操作的简单封装</span>
<span class="token keyword">int</span> <span class="token function">binder_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> len<span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder_write: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span>
                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>binder_loop 调用 ioctl 读取数据，当前线程阻塞在此处直到有 ioctl 收到服务相关的远程调用请求。</p> <h2 id="_2-binder-服务注册过程第二阶段-server-端发起服务注册请求"><a href="#_2-binder-服务注册过程第二阶段-server-端发起服务注册请求" class="header-anchor">#</a> 2. Binder 服务注册过程第二阶段——Server 端发起服务注册请求</h2> <p>Server 端发起服务注册请求的流程如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174152.png" alt=""></p> <p>Server 端发起服务注册请求的代码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> svcmgr <span class="token operator">=</span> BINDER_SERVICE_MANAGER<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> handle<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token comment">//打开驱动</span>
    bs <span class="token operator">=</span> <span class="token function">binder_open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/binder&quot;</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to open binder driver\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//添加服务</span>
	ret <span class="token operator">=</span> <span class="token function">svcmgr_publish</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> svcmgr<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> hello_service_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;failed to publish hello service\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token function">binder_loop</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> test_server_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>整个流程分为一下几步;</p> <ul><li>binder_open 初始化</li> <li>svcmgr_publish 注册函数，需要提供一个参数 hello_service_handler，也就是我们自己写的回调函数</li> <li>调用 binder_loop 进入循环，等待远程调用</li></ul> <p>binder_open 和 binder_loop 在上一节已做分析，这里我们接着分析 svcmgr_publish 的实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">svcmgr_publish</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> iodata<span class="token punctuation">[</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">,</span> reply<span class="token punctuation">;</span>

    <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> iodata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>iodata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// strict mode header</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> SVC_MGR_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_string16_x</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_obj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//通过 binder_call 发起远程函数调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_call</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> target<span class="token punctuation">,</span> SVC_MGR_ADD_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//fprintf(stderr, &quot;svcmgr_public 远程调用失败\n&quot;);</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">//解析返回值</span>
    status <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用成功返回0</span>
    <span class="token comment">//远程调用结束，通知驱动清理内存</span>
    <span class="token function">binder_done</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>svcmgr_publish 工作流程如下：</p> <ul><li>通过 binder_io 构造需要发送的数据 msg</li> <li>通过 binder_call 发起远程调用</li> <li>解析回复的数据，通过 binder_done 函数通知驱动通信完成,清理内存</li></ul> <p>其核心功能通过 binder_call 实现，binder_call 用于发起远程过程调用，其调用过程如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token comment">//调用过程</span>
<span class="token comment">// bs 是 binder_open 的返回值</span>
<span class="token comment">// msg 是上面代码构造的 binder_io 结构体</span>
<span class="token comment">// reply 是被调用方的返回数据</span>
<span class="token comment">// target 是一个整型变量，用于指定要访问哪个进程</span>
<span class="token comment">// SVC_MGR_ADD_SERVICE 表示我们要调用远程进程的 addservice 函数</span>
<span class="token function">binder_call</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> target<span class="token punctuation">,</span> SVC_MGR_ADD_SERVICE<span class="token punctuation">)</span>

<span class="token comment">//函数结构</span>
<span class="token keyword">int</span> <span class="token function">binder_call</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>接下来我们来分析 binder_call 的具体实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//binder_call 中的构造过程</span>
<span class="token keyword">int</span> <span class="token function">binder_call</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>

    <span class="token comment">//关注点1 binder_io *msg 转为 binder_write_read</span>
    <span class="token comment">//声明数据</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> bwr<span class="token punctuation">;</span>

    <span class="token comment">//binder_write_read 内部成员 write_buffer 的结构</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> writebuf<span class="token punctuation">;</span>
  
    <span class="token keyword">unsigned</span> readbuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//...... 省略非核心代码</span>

    <span class="token comment">//构造 binder_write_read 内部结构 writebuf</span>
    <span class="token comment">// BC_TRANSACTION 表示当前数据是用于发起远程调用</span>
    writebuf<span class="token punctuation">.</span>cmd <span class="token operator">=</span> BC_TRANSACTION<span class="token punctuation">;</span>
    <span class="token comment">// target 用于找到远程进程，即我们要调用哪个进程的函数</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>target<span class="token punctuation">.</span>handle <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token comment">// code 表示调用哪个函数</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>data <span class="token operator">-</span> msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> msg<span class="token operator">-&gt;</span>offs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> msg<span class="token operator">-&gt;</span>offs0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//data 是数据区，指向一个 binder_io 结构体</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
    writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>msg<span class="token operator">-&gt;</span>offs0<span class="token punctuation">;</span>

    <span class="token comment">//给 write 相关变量赋值</span>
    <span class="token comment">//表示当前进程是写入数据，即发送数据</span>
    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>writebuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>writebuf<span class="token punctuation">;</span>

    <span class="token function">hexdump</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>data <span class="token operator">-</span> msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//关注点2 写的同时也要读数据</span>
        <span class="token comment">//给 read 相关变量赋值</span>
        <span class="token comment">//同时，我们也要读取返回的结果值</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>

        <span class="token comment">//关注点3 发起读写操作</span>
        <span class="token comment">//发送 binder_write_read 数据</span>
        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//省略部分代码 ......</span>
        <span class="token comment">//关注点4 解析收到的数据 readbuf</span>
        <span class="token comment">// res = binder_parse(bs, reply, (uintptr_t) readbuf, bwr.read_consumed, 0);</span>
        <span class="token comment">// if (res == 0) return 0;</span>
        <span class="token comment">// if (res &lt; 0) goto fail;</span>
    <span class="token punctuation">}</span>

fail<span class="token operator">:</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>reply<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    reply<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> BIO_F_IOERROR<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//binder_write_read 结构体定义如下</span>
<span class="token keyword">struct</span> <span class="token class-name">binder_write_read</span> <span class="token punctuation">{</span>
	<span class="token class-name">binder_size_t</span>		write_size<span class="token punctuation">;</span>	<span class="token comment">/* bytes to write */</span>
	<span class="token class-name">binder_size_t</span>		write_consumed<span class="token punctuation">;</span>	<span class="token comment">/* bytes consumed by driver */</span>
	<span class="token class-name">binder_uintptr_t</span>	write_buffer<span class="token punctuation">;</span>

	<span class="token class-name">binder_size_t</span>		read_size<span class="token punctuation">;</span>	<span class="token comment">/* bytes to read */</span>
	<span class="token class-name">binder_size_t</span>		read_consumed<span class="token punctuation">;</span>	<span class="token comment">/* bytes consumed by driver */</span>
	<span class="token class-name">binder_uintptr_t</span>	read_buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token punctuation">{</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		__u32	handle<span class="token punctuation">;</span>
		<span class="token class-name">binder_uintptr_t</span> ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> target<span class="token punctuation">;</span>
	<span class="token class-name">binder_uintptr_t</span>	cookie<span class="token punctuation">;</span>
	__u32		code<span class="token punctuation">;</span>

	__u32	        flags<span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span>		sender_pid<span class="token punctuation">;</span>
	<span class="token class-name">uid_t</span>		sender_euid<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span>	data_size<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span>	offsets_size<span class="token punctuation">;</span>

	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token keyword">struct</span> <span class="token punctuation">{</span>
			<span class="token class-name">binder_uintptr_t</span>	buffer<span class="token punctuation">;</span>
			<span class="token class-name">binder_uintptr_t</span>	offsets<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> ptr<span class="token punctuation">;</span>
		__u8	buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><p>binder_write_read 是应用程序与驱动相互传递的数据，由两部分组成：</p> <ul><li>write 部分：发送给驱动的数据
<ul><li>write_buffer：指针，指向一个 writebuf 结构体</li> <li>write_size：指针指向数据的大小</li> <li>write_consumed：指针指向的数据已使用区域的数据大小</li></ul></li> <li>read 部分：用于接受远程调用的返回值
<ul><li>read_buffer：指针，指向一段内存，用于接收数据</li> <li>read_size：指针指向数据的大小</li> <li>read_consumed：指针指向的数据已使用区域的数据大小</li></ul></li></ul> <p>关注点 1 处，主要是使用 binder_io 构建 binder_write_read 的 write_buffer 部分：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//声明</span>
<span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> writebuf<span class="token punctuation">;</span>

<span class="token comment">//构造 writebuf</span>
writebuf<span class="token punctuation">.</span>cmd <span class="token operator">=</span> BC_TRANSACTION<span class="token punctuation">;</span>
writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>target<span class="token punctuation">.</span>handle <span class="token operator">=</span> target<span class="token punctuation">;</span>
writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>data <span class="token operator">-</span> msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> msg<span class="token operator">-&gt;</span>offs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> msg<span class="token operator">-&gt;</span>offs0<span class="token punctuation">)</span><span class="token punctuation">;</span>
writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>msg<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
writebuf<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>msg<span class="token operator">-&gt;</span>offs0<span class="token punctuation">;</span>
bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>writebuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">//赋值</span>
bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>writebuf<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>writebuffer 的结构如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174209.png" alt=""></p> <p>关注点 2 处，主要给 read_buffer 赋值，表示写的同时也要读取数据即等待返回值：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> readbuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>关注点 3 处，发起写操作，程序进入阻塞状态，直到收到远程调用的返回数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_3-binder-服务注册过程第三阶段-servicemanager-收到服务注册请求"><a href="#_3-binder-服务注册过程第三阶段-servicemanager-收到服务注册请求" class="header-anchor">#</a> 3. Binder 服务注册过程第三阶段—— ServiceManager 收到服务注册请求</h2> <p>ServiceManager 收到 Server 发送的数据，并从第一阶段的阻塞休眠中唤醒过来：</p> <p>流程如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174222.png" alt=""></p> <p>具体代码如下：</p> <p>binder.c 中 binder_loop 源码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_loop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//......</span>
    bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>
    
    <span class="token comment">//从这里唤醒，收到的数据保存在 bwr 变量中</span>
    res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//解析收到的数据，回调 func 方法，func 传入的是 svcmgr_handler</span>
    res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>收到的数据 readbuf 的格式如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>

    <span class="token comment">//可能存在多个数据组</span>
    <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>

    <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>

    <span class="token comment">//.......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703174231.png" alt=""></p> <p>接下来我们看看数据的解析过程：</p> <p>binder.c 中 binder_parse 源码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span>
                 <span class="token class-name">uintptr_t</span> ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uintptr_t</span> end <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> size<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>ptr <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//解析出 readbuf 中的 cmd</span>
        <span class="token class-name">uint32_t</span> cmd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
        ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//...... 省略非相关代码</span>
        <span class="token comment">// cmd == BR_TRANSACTION</span>
        <span class="token keyword">case</span> BR_TRANSACTION_SEC_CTX<span class="token operator">:</span>
        <span class="token keyword">case</span> BR_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> txn<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd <span class="token operator">==</span> BR_TRANSACTION_SEC_CTX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//...... 省略非相关代码</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token comment">/* BR_TRANSACTION */</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> ptr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;parse: txn too small (binder_transaction_data)!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//将 readbuf 中的数据解释为 binder_transaction_data 结构体</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                txn<span class="token punctuation">.</span>secctx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">binder_dump_txn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">unsigned</span> rdata<span class="token punctuation">[</span><span class="token number">256</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> msg<span class="token punctuation">;</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> reply<span class="token punctuation">;</span>
                <span class="token keyword">int</span> res<span class="token punctuation">;</span>

                <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> rdata<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将 binder_transaction_data 数据中的 data 数据区解析到 binder_io msg 中</span>
                <span class="token function">bio_init_from_txn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//调用回调函数，即 svcmgr_handler 函数</span>
                res <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">binder_free_buffer</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//走这儿</span>
                    <span class="token comment">//将结果发送给 server 进程</span>
                    <span class="token function">binder_send_reply</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> txn<span class="token punctuation">.</span>transaction_data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ...... 省略非相关代码</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>总结一下就是解析出 <code>binder_transaction_data binder_io</code>, 然后调用传入的回调函数 <code>svcmgr_handler</code></p> <p>接下来分析回调函数 svcmgr_handler 的实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// bs 是 binder_open 中构建的结构体</span>
<span class="token comment">//txn_secctx 和 msg 是收到的数据</span>
<span class="token comment">//reply 用于servicemanager 向 server 回复数据</span>
<span class="token keyword">int</span> <span class="token function">svcmgr_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> <span class="token operator">*</span>txn_secctx<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//一堆变量，暂时不管</span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> handle<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> strict_policy<span class="token punctuation">;</span>
    <span class="token keyword">int</span> allow_isolated<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> dumpsys_priority<span class="token punctuation">;</span>

    <span class="token comment">//获取到 binder_transaction_data 结构体数据</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>txn <span class="token operator">=</span> <span class="token operator">&amp;</span>txn_secctx<span class="token operator">-&gt;</span>transaction_data<span class="token punctuation">;</span>

    <span class="token comment">//对收到的数据做一些检查，暂时不管</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>ptr <span class="token operator">!=</span> BINDER_SERVICE_MANAGER<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>code <span class="token operator">==</span> PING_TRANSACTION<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// msg 中第一个数据一般是一个 32 位的 0</span>
    strict_policy <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// msg 中的第二个数据 ，一般也是 32 位的 0</span>
    <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// msg 中的第三个数据，一个字符串，正常情况是 android.os.IServiceManager</span>
    s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// svcmgr_id 是一个字符数组，内容是 android.os.IServiceManager</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">memcmp</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;invalid id %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//selinux 相关代码 省略 ......</span>

    <span class="token comment">//code 代表需要调用哪个函数</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取服务</span>
    <span class="token keyword">case</span> SVC_MGR_GET_SERVICE<span class="token operator">:</span>
    <span class="token keyword">case</span> SVC_MGR_CHECK_SERVICE<span class="token operator">:</span>
       <span class="token comment">//...... 省略无关代码</span>
    <span class="token comment">//添加服务</span>
    <span class="token keyword">case</span> SVC_MGR_ADD_SERVICE<span class="token operator">:</span>  <span class="token comment">//代码走这里</span>
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        handle <span class="token operator">=</span> <span class="token function">bio_get_ref</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        allow_isolated <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        dumpsys_priority <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">do_add_service</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">,</span> allow_isolated<span class="token punctuation">,</span> dumpsys_priority<span class="token punctuation">,</span>
                           txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> txn_secctx<span class="token operator">-&gt;</span>secctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">// list 已注册的服务</span>
    <span class="token keyword">case</span> SVC_MGR_LIST_SERVICES<span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token comment">// ...... 省略无关代码 </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;unknown code %d\n&quot;</span><span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//写入返回值</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>上面的代码从 <code>binder_transaction_data_secctx</code> 中获取到了code，code 代表了 server 端要执行的操作，在当前服务注册情景中，code 的值为  SVC_MGR_ADD_SERVICE，表示添加服务。</p> <p>接下来我们来分析一下添加服务相关的代码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>    <span class="token comment">//添加服务</span>
    <span class="token keyword">case</span> SVC_MGR_ADD_SERVICE<span class="token operator">:</span>
        <span class="token comment">//获取到服务的名字</span>
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取到服务在内核中的句柄 handle</span>
        handle <span class="token operator">=</span> <span class="token function">bio_get_ref</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//暂时不管下面两个参数的作用</span>
        allow_isolated <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        dumpsys_priority <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加服务，具体下面分析</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">do_add_service</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">,</span> allow_isolated<span class="token punctuation">,</span> dumpsys_priority<span class="token punctuation">,</span>
                           txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> txn_secctx<span class="token operator">-&gt;</span>secctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>do_add_service 的实现如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">do_add_service</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> handle<span class="token punctuation">,</span>
                   <span class="token class-name">uid_t</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> allow_isolated<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> dumpsys_priority<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> spid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle <span class="token operator">||</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">//一些权限判断，暂时可以不管</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">svc_can_register</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> spid<span class="token punctuation">,</span> sid<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;add_service('%s',%x) uid=%d - PERMISSION DENIED\n&quot;</span><span class="token punctuation">,</span>
             <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//源码中定义了一个单向链表用保存 service</span>
    <span class="token comment">// 链表的节点是 svcinfo，是 servicemanager 对一个服务的描述或表示，链表头是 svclist，是一个全局变量</span>
    <span class="token comment">//这里从链表中查找服务，这里是注册服务，链表中没有当前服务，查找到的值是 null</span>
    si <span class="token operator">=</span> <span class="token function">find_svc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// si 为 null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;add_service('%s',%x) uid=%d - ALREADY REGISTERED, OVERRIDE\n&quot;</span><span class="token punctuation">,</span>
                 <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">svcinfo_death</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        si<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 代码走这里</span>
        <span class="token comment">//构建新的节点</span>
        si <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>si<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;add_service('%s',%x) uid=%d - OUT OF MEMORY\n&quot;</span><span class="token punctuation">,</span>
                 <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 保存数据，并加入链表</span>
        si<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span> <span class="token comment">//handle 保存到节点中</span>
        si<span class="token operator">-&gt;</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
        <span class="token comment">// 服务的名字保存到节点中</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>death<span class="token punctuation">.</span>func <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> svcinfo_death<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>death<span class="token punctuation">.</span>ptr <span class="token operator">=</span> si<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>allow_isolated <span class="token operator">=</span> allow_isolated<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>dumpsys_priority <span class="token operator">=</span> dumpsys_priority<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>next <span class="token operator">=</span> svclist<span class="token punctuation">;</span>
        svclist <span class="token operator">=</span> si<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//binder_ref强引用加1操作，留到内核部分讲解，这里暂时不管</span>
    <span class="token function">binder_acquire</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//注册死亡通知，留到内核部分讲解，这里暂时不管</span>
    <span class="token function">binder_link_to_death</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>death<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>总结一下就是：</p> <ul><li>构建 svcinfo 链表节点</li> <li>根据收到的数据，给 svcinfo 赋值</li> <li>将 svcinfo 添加到 svclist 链表中</li></ul> <p>svcinfo 是 servicemanager 中对一个服务的描述，其中最重要的数据是 handle，用于标识一个 service，其值由驱动确定，并发送给了 servicemanger，保存在 svclist 链表中。</p> <h2 id="_4-servicemanager-告知-server-服务注册完毕-server-收到应答数据"><a href="#_4-servicemanager-告知-server-服务注册完毕-server-收到应答数据" class="header-anchor">#</a> 4. ServiceManager 告知 Server 服务注册完毕，Server 收到应答数据</h2> <p>在 svcmgr_handler 最后部分，写入返回数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">svcmgr_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data_secctx</span> <span class="token operator">*</span>txn_secctx<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//......</span>
    <span class="token comment">//写入返回数据</span>
    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在 binder_parse 中调用 <code>binder_send_relpy</code> 发送返回的数据。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_send_reply</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                       <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                       <span class="token class-name">binder_uintptr_t</span> buffer_to_free<span class="token punctuation">,</span>
                       <span class="token keyword">int</span> status<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//两块数据，不同的 cmd 对于不同的数据格式</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd_free<span class="token punctuation">;</span>
        <span class="token class-name">binder_uintptr_t</span> buffer<span class="token punctuation">;</span>
        <span class="token class-name">uint32_t</span> cmd_reply<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> txn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>

    data<span class="token punctuation">.</span>cmd_free <span class="token operator">=</span> BC_FREE_BUFFER<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>buffer <span class="token operator">=</span> buffer_to_free<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>cmd_reply <span class="token operator">=</span> BC_REPLY<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> TF_STATUS_CODE<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>status<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data_size <span class="token operator">=</span> reply<span class="token operator">-&gt;</span>data <span class="token operator">-</span> reply<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span>offs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span>offs0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>reply<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>txn<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>reply<span class="token operator">-&gt;</span>offs0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>流程基本和 server 注册服务一直，只是这里有两块数据，同时发送给 binder 驱动。第一块数据由驱动处理，第二块数据会返回给 Server 端，Server 端从阻塞中恢复：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_call</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">//省略部分代码 ......</span>

        <span class="token comment">//Server 从阻塞中恢复，同时收到数据</span>
        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;binder: ioctl failed (%s)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//解析收到的数据</span>
        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>解析返回数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span>
                 <span class="token class-name">uintptr_t</span> ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uintptr_t</span> end <span class="token operator">=</span> ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> size<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>ptr <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
        ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TRACE</span></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">&quot;%s:\n&quot;</span><span class="token punctuation">,</span> <span class="token function">cmd_name</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//...... 省略部分代码</span>
        <span class="token keyword">case</span> BR_REPLY<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>txn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> ptr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>txn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">&quot;parse: reply too small!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">binder_dump_txn</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bio<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//数据放到 bio 中，即上一层传入的 reply</span>
                <span class="token function">bio_init_from_txn</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                bio <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/* todo FREE BUFFER */</span>
            <span class="token punctuation">}</span>
            ptr <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//省略部分代码 ......</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>binder_parse 返回 0，收到的数据保存在 reply 中：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">binder_call</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">,</span>
                <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">//binder_parse 返回</span>
        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 返回值是 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> fail<span class="token punctuation">;</span>

    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>binder_call 返回到 svcmgr_publish</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">svcmgr_publish</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//......</span>

    <span class="token comment">//binder_call 返回 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_call</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> target<span class="token punctuation">,</span> SVC_MGR_ADD_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//fprintf(stderr, &quot;svcmgr_public 远程调用失败\n&quot;);</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">//解析返回值</span>
    <span class="token comment">//解析出的值是 0 表示调用成功</span>
    status <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用成功返回0</span>
    <span class="token comment">//远程调用结束，通知驱动清理内存</span>
    <span class="token function">binder_done</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> status<span class="token punctuation">;</span> <span class="token comment">//返回 0 给 main 主程序，调用成功</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>最后调用 binder_done 通知驱动清理内存:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">binder_done</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                 __unused <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                 <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
        <span class="token class-name">uintptr_t</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> BIO_F_SHARED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>cmd <span class="token operator">=</span> BC_FREE_BUFFER<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span>data0<span class="token punctuation">;</span>
        <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reply<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>到这里，服务的注册过程就分析完了，后面的文章我们会继续分析服务的获取和调用过程。</p> <h2 id="关于"><a href="#关于" class="header-anchor">#</a> 关于</h2> <p>我叫阿豪，2015 年本科毕业于国防科学技术大学指挥信息系统专业，毕业后从事信息化装备的研发工作，主要研究方向是 Android Framework 与 Linux Kernel。</p> <p>如果你对 Android Framework 感兴趣或者正在学习 Android Framework，可以关注我的微信公众号和抖音，我会持续分享我的学习经验，帮助正在学习的你少走一些弯路。学习过程中如果你有疑问或者你的经验想要分享给大家可以添加我的微信，我拉你进技术交流群。</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg" alt=""></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/003.Binder 程序示例之C语言篇.html" class="prev">
          4.Binder 程序示例之C语言篇
        </a></span> <span class="next"><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/005.Binder 服务获取与使用过程情景分析之C语言篇.html">
          6.Binder 服务获取与使用过程情景分析之C语言篇
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/AndroidFrameworkTutorialPages/assets/js/app.a5dad8b6.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/77.57d6d63d.js" defer></script>
  </body>
</html>
