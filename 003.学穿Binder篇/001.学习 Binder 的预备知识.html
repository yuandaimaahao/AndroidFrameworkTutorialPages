<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>学习 Binder 的预备知识 | Android Framework</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css" as="style"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/app.a5dad8b6.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/74.731ff6ad.js" as="script"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/10.337b766a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/100.1af765a2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/101.e96f0d69.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/102.b4e844a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/103.7fd8b73f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/104.3027cd01.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/105.1d287f51.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/106.775741ca.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/107.3c18da36.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/108.bc5b9d09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/109.6d0bfeff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/11.be2e0167.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/110.fb6f0c28.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/111.16370887.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/112.c7849d37.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/113.2ad757fa.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/114.8e71b0e4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/115.8ff602ee.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/116.43fbb597.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/117.0f8b1a2b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/118.4f51c7fd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/119.dc4ce472.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/120.0c35e50f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/121.d6ce64e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/122.afb666c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/123.a78c9f32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/124.cda8de32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/125.24ec5bd0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/126.69e9053c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/127.7c1ca90f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/128.35da468e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/129.0add3757.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/130.bd1f91fa.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/131.fe641bce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/132.2aee8a67.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/133.02c0e89d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/134.5e724532.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/135.b1c2411f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/136.844acb24.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/137.b9fa8a82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/138.78b4a9d7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/139.bb0caf5b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/14.7d944ea8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/140.c24c1c08.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/141.397612b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/142.c21a8fa4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/143.47e3beb6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/144.8d4b76d0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/145.5e7bedeb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/146.90e8ff0b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/147.0c73c160.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/148.613f0013.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/149.c72f81b8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/15.bf19b574.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/150.82fbb5a7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/151.339a1276.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/152.62bc0603.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/153.d4db757f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/154.7a80eb2c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/155.46d6d977.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/156.f032bb76.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/157.34314806.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/158.92790a71.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/159.a2d23ebb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/16.91ebb564.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/160.0179cfaf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/161.e9960d05.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/162.456e6e1b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/163.245efdf2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/164.33654df0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/165.d2f7f7bf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/166.b00be4c6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/167.2e76ebcc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/168.cc793aa2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/169.4233d468.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/17.bfe50ee3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/170.154bf18a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/171.9a47af6a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/172.2df208f4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/173.db64d3bc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/174.76ed09e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/18.05ccfb53.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/19.afa41ba1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/20.e9510ad7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/21.86ad6466.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/22.09086018.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/23.62e146ab.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/24.36df6bff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/25.99201ee4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/26.0dad3cd4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/27.be36597a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/28.4a19ff25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/29.5c2b113e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/3.97bbbdc8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/30.38a9b8bb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/31.0d5a08c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/32.804ecc25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/33.a8e71e21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/34.da185bf8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/35.e45072d9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/36.b81c8de2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/37.f26d2d52.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/38.057aa3b4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/39.8de59f74.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/4.983d15c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/40.b47d4570.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/41.516c396f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/42.b405090a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/43.4f3cf1ea.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/44.9020abbc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/45.76ee68b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/46.24ca3ec6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/47.ce306e3f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/48.594e18b2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/49.1ac45e0a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/5.574f6fbb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/50.5cf1e47d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/51.037e5442.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/52.141d9248.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/53.6b1fbef2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/54.e55084df.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/55.9e651b61.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/56.ac520841.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/57.63b15773.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/58.9810e4ec.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/59.61908f2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/6.a4122f72.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/60.a8c87ab2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/61.5f078d82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/62.7f4a403f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/63.8c484ea1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/64.cc875fce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/65.82180ec7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/66.2eb988a8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/67.6bdd390f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/68.c83deb44.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/69.add77acc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/70.25f6b2ba.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/71.e5e79631.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/72.d0b4c7a1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/73.914aa049.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/75.41ae114b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/76.3707b690.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/77.57d6d63d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/78.32d3f538.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/79.86fe3a2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/8.9d6eb8a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/80.c048f8e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/81.fec13824.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/82.ef5208fd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/83.ca729155.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/84.a8042c7e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/85.1b1e7f09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/86.702f2cd5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/87.7a90d741.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/88.8da58920.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/89.72be0795.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/9.bee9eff5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/90.34ba496d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/91.90e76ecb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/92.e6126fdf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/93.d83bc007.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/94.c2341ec2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/95.9f2d2ece.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/96.1e7ed15a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/97.fb305dd8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/98.50e603c5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/99.72017f6d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/vendors~docsearch.833ce4c0.js">
    <link rel="stylesheet" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Android Framework</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AndroidFrameworkTutorialPages/" class="home-link router-link-active"><!----> <span class="site-name">Android Framework</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>130</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <!----> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习路线与指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>玩转AOSP篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>学穿Binder篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/000.Binder 专题导学 —— 如何深入掌握 Binder.html" class="sidebar-link">1.专题导学 —— 如何深入掌握 Binder</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/001.学习 Binder 的预备知识.html" class="active sidebar-link">2.学习 Binder 的预备知识</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/002.Binder 基本原理.html" class="sidebar-link">3.Binder 基本原理</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/003.Binder 程序示例之C语言篇.html" class="sidebar-link">4.Binder 程序示例之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/004.Binder 服务注册过程情景分析之C语言篇.html" class="sidebar-link">5.Binder 服务注册过程情景分析之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/005.Binder 服务获取与使用过程情景分析之C语言篇.html" class="sidebar-link">6.Binder 服务获取与使用过程情景分析之C语言篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/006.Android Binder 驱动框架设计分析.html" class="sidebar-link">7.Android Binder 驱动框架设计分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/007.Binder 驱动情景分析之 ServiceManager 启动过程.html" class="sidebar-link">8.Binder 驱动情景分析之 ServiceManager 启动过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/008.Binder 驱动情景分析之服务注册过程.html" class="sidebar-link">9.Binder 驱动情景分析之服务注册过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/009.Binder 驱动情景分析之服务获取与使用过程.html" class="sidebar-link">10.Binder 驱动情景分析之服务获取与使用过程</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/010.Binder 程序示例之C++篇.html" class="sidebar-link">11.Binder 程序示例之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/011.Binder C++ 程序分析之主要类解析.html" class="sidebar-link">12.Binder C++ 程序分析之主要类解析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/012.Binder 服务注册过程情景分析之C++篇.html" class="sidebar-link">13.Binder 服务注册过程情景分析之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/013.Binder 服务获取与使用过程情景分析之C++篇.html" class="sidebar-link">14.Binder 服务获取与使用过程情景分析之C++篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/014.Binder 程序示例之 aidl-cpp 篇.html" class="sidebar-link">15.Binder 程序示例之 aidl-cpp 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/015.添加 Native 系统服务.html" class="sidebar-link">16.添加 Native 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/016.添加 Native 系统服务回调.html" class="sidebar-link">17.添加 Native 系统服务回调</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/017.Binder 程序示例之 Java 篇.html" class="sidebar-link">18.Binder 程序示例之 Java 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/018.Binder Java 层初始化.html" class="sidebar-link">19.Binder Java 层初始化</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/019.Binder Java 层服务注册过程分析.html" class="sidebar-link">20.Binder Java 层服务注册过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/020.Binder Java 层服务获取与使用过程分析.html" class="sidebar-link">21.Binder Java 层服务获取与使用过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/021.添加 Java 系统服务.html" class="sidebar-link">22.添加 Java 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/022.Android Java 系统服务框架与第三方 App 使用自定义 Java 系统服务.html" class="sidebar-link">23.Android Java 系统服务框架与第三方 App 使用自定义 Java 系统服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/023.添加 Java 系统服务回调.html" class="sidebar-link">24.添加 Java 系统服务回调</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/024.AIDL 数据类型详解之 Java 篇.html" class="sidebar-link">25.AIDL 数据类型详解之 Java 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/025.AIDL 数据类型详解之 C++ 篇.html" class="sidebar-link">26.AIDL 数据类型详解之 C++ 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/026.Java 调用 Native 服务.html" class="sidebar-link">27.Java 调用 Native 服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/027.Native 调用 Java 服务.html" class="sidebar-link">28.Native 调用 Java 服务</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/028.AIDL 关键字 in out inout oneway 解析.html" class="sidebar-link">29.AIDL 关键字 in out inout oneway 解析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/029.Binder 驱动 Debug 入门指南.html" class="sidebar-link">30.Binder 驱动 Debug 入门指南</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/030.Binder 匿名服务源码分析.html" class="sidebar-link">031.Binder 匿名服务源码分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/031.Binder 中的 Parcel 数据结构分析（C++）.html" class="sidebar-link">032.Binder 中的 Parcel 数据结构分析（C++）</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/032.Binder 中的 Parcel 数据结构分析（Java）.html" class="sidebar-link">033.Binder 中的 Parcel 数据结构分析（Java）</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/033.Binder 多线程情景分析.html" class="sidebar-link">034.Binder 多线程情景分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/034.Binder 线程池溢出问题.html" class="sidebar-link">035.Binder 线程池溢出问题</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/035.Binder 代理对象泄露问题分析.html" class="sidebar-link">036.Binder 代理对象泄露问题分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/036.Binder 死亡通知情景分析.html" class="sidebar-link">037.Binder 死亡通知情景分析</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/037.Binder 异常处理机制.html" class="sidebar-link">038.Binder 异常处理机制</a></li><li><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/039.Binder 面试题汇总.html" class="sidebar-link">039.Binder 面试题汇总</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础组件篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统启动篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>应用层框架篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hal 与硬件服务篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图形系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>输入系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统应用篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>构造系统篇</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>学习 Binder 的预备知识</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">学习 Binder 的预备知识</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>阿豪</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/3/2023</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/AndroidFrameworkTutorialPages/003.%E5%AD%A6%E7%A9%BFBinder%E7%AF%87/001.%E5%AD%A6%E4%B9%A0%20Binder%20%E7%9A%84%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1. 概述</h2> <p>我们先看一张 Binder 的结构图：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703164640.png" alt=""></p> <p>从图中可以看出，Binder 系统涉及的知识面横跨了内核、Native、JNI、Java 四层，要完整地掌握整个 Binder 系统，需要的基础知识包括了：</p> <ul><li><p>C/C++ Java 编程语言</p> <ul><li>C 语言推荐三本书 《一站式学习C编程》、《C语言非常道》、《嵌入式C语言自我修养》，建议任意一本快速过一遍语法，剩下的在实践中慢慢学习。</li> <li>C++ 推荐《21天学通 C++》第八版，老外写的，清晰易懂，和 C 语言一样，快速过一遍语法，剩下的在实践中慢慢学习</li> <li>Java 推荐看看《Java 核心技术》</li></ul></li> <li><p>JNI：JNI 没有特别适合的书，可以参考我写的专栏博客 《JNI 编程入门指南》</p></li> <li><p>Linux 系统编程，对于 Binder 学习，只需要了解文件访问相关的接口，需要深入学习的同学推荐一门课，三本书：</p> <ul><li><p><a href="https://www.icourse163.org/course/XIYOU-1461794181?from=searchPage&amp;outVendor=zw_mooc_pcssjg_" target="_blank" rel="noopener noreferrer">Linux编程技术<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,这是西安邮电大学提供的一套 mooc 课程，可供入门学习使用</p></li> <li><p>《Linux 系统编程 杰克-本尼 佩尔松》</p></li> <li><p>《UNIX 环境高级编程》《Linux/Unix 系统编程手册》：这两本书可以作为编程过程中的字典使用</p></li></ul></li> <li><p>Linux 内核入门，对于 Binder 学习，只需要了解驱动的基本开发流程以及内核中常用的一些数据结构，如果需要深入学习，推荐以下的一些资料：</p> <ul><li><p><a href="https://www.icourse163.org/course/XIYOU-1461809182?from=searchPage&amp;outVendor=zw_mooc_pcssjg_" target="_blank" rel="noopener noreferrer">操作系统及Linux内核<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 这是西安邮电大学提供的一套 mooc 课程，可供入门学习使用</p></li> <li><p>《深入理解 Linux 内核 第三版》</p></li> <li><p>《奔跑吧Linux 内核 系列书籍》</p></li> <li><p>Linux 驱动开发：推荐韦东山老师 B 站分享的系列课程</p></li></ul></li></ul> <p>以上的内容过于繁多了，等我们学完黄花菜都凉了。我抽取提炼了一些学习 Binder 必须要掌握的知识，供初学者快速入门，这些内容主要包含了：</p> <ul><li>AOSP 上手指南</li> <li>Linux 内核下载编译运行</li> <li>Linux 驱动开发入门</li> <li>Linux 内核常用数据结构</li> <li>虚拟内存</li> <li>Linux 文件访问接口</li> <li>JNI 编程入门，在基础篇做讲解</li></ul> <p>其他深入的内容，可以在实践中边做边学。</p> <h2 id="_2-aosp-上手指南"><a href="#_2-aosp-上手指南" class="header-anchor">#</a> 2. AOSP 上手指南</h2> <p>这部分内容请阅读 <a href="https://yuandaimaahao.github.io/AndroidFrameworkTutorialPages/002.%E7%8E%A9%E8%BD%ACAOSP%E7%AF%87/001.%20AOSP%E6%9E%81%E9%80%9F%E4%B8%8A%E6%89%8B.html" target="_blank" rel="noopener noreferrer">AOSP 极速上手<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_3-linux-内核下载编译运行"><a href="#_3-linux-内核下载编译运行" class="header-anchor">#</a> 3. Linux 内核下载编译运行</h2> <h3 id="_3-1-内核下载"><a href="#_3-1-内核下载" class="header-anchor">#</a> 3.1 内核下载</h3> <p>下载适用于模拟器的内核：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone https://aosp.tuna.tsinghua.edu.cn/android/kernel/goldfish.git
<span class="token comment">#查看分支</span>
<span class="token function">git</span> branch <span class="token parameter variable">-a</span>
<span class="token function">git</span> checkout android-goldfish-4.14-gchips 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>编写编译脚本：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86_64
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SUBARCH</span><span class="token operator">=</span>x86_64
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>x86_64-linux-android-
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>android源码目录/prebuilts/gcc/linux-x86/x86/x86_64-linux-android-4.9/bin:<span class="token environment constant">$PATH</span>
<span class="token function">make</span> x86_64_ranchu_defconfig
<span class="token function">make</span> <span class="token parameter variable">-j16</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>将以上的内容保存为 build.sh 脚本文件。执行 <code>sh build.sh</code> 开始编译。</p> <p>编译报错，修改代码：</p> <ul><li>删除 scripts/selinux/mdp/mdp.c 文件中的  #include &lt;sys/socket.h&gt;</li> <li>删除 scripts/selinux/genheaders/genheaders.c 文件中的  #include &lt;sys/socket.h&gt;</li> <li>在 security/selinux/include/classmap.h 头部添加 #include &lt;linux/socket.h&gt;</li></ul> <p>执行编译脚本 <code>sh build.sh</code> 即可编译成功</p> <h3 id="_3-2-自定义内核启动"><a href="#_3-2-自定义内核启动" class="header-anchor">#</a> 3.2 自定义内核启动</h3> <p>启动之前，需要把之前启动的模拟器和启动模拟器的终端都关掉。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
<span class="token builtin class-name">source</span> build/envsetup.sh

lunch aosp_x86_64-eng

emulator <span class="token parameter variable">-kernel</span> 内核地址/goldfish/arch/x86_64/boot/bzImage

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>启动成功，打开模拟器设置页面，进入版本信息。</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230721161813.png" alt=""></p> <p>可以看到 Kernel version 项里，已经是最新编译的内核版本了。</p> <h2 id="_4-linux-驱动开发入门"><a href="#_4-linux-驱动开发入门" class="header-anchor">#</a> 4. Linux 驱动开发入门</h2> <h3 id="_4-1-编写一个简单的-linux-内核模块"><a href="#_4-1-编写一个简单的-linux-内核模块" class="header-anchor">#</a> 4.1 编写一个简单的 Linux 内核模块</h3> <p>首先，我们需要理解什么是内核模块？简单来说，内核模块是一段 &quot;固定格式&quot; 的代码，像一个“插件”一样，linux 内核可以动态的加载并执行这段代码，也可以把这段代码编译进内核，在内核启动的时候来执行这段代码。</p> <p>下面我们写一个简单的 linux 模块：</p> <p>在内核的 /drivers/char 目录中添加 hello_module.c</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>

<span class="token comment">/**
 * __init 是一个宏，表示 hello_init 是一个初始化函数，会放到编译后目标文件的初始化段中
 */</span> 
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//printk 是内核中的日志打印函数</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/**
 * __exit 是一个宏，表示 hello_exit 是一个初始化函数，会放到编译后目标文件的初始化段中
 */</span> 
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;hello exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * hello_init 是当前模块的启动函数
 */</span> 
<span class="token function">module_init</span><span class="token punctuation">(</span>hello_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
 * hello_exit 是当前模块的退出函数
 */</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_4-2-将模块编译进内核"><a href="#_4-2-将模块编译进内核" class="header-anchor">#</a> 4.2 将模块编译进内核</h3> <p>接下来我们修改 /drivers/char/Kconfig 文件，使得我们的 hello 模块，能出现在内核的编译选项中。</p> <p>在 /drivers/char 中的 Kconfig 文件中添加：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>config HELLO_MODULE
	bool <span class="token string">&quot;hello module support&quot;</span>
	default y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后在 /drivers/char 下的 Makefile 文件中添加：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>obj-<span class="token variable"><span class="token variable">$(</span>CONFIG_HELLO_MODULE<span class="token variable">)</span></span>       <span class="token operator">+=</span> hello_module.o
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当在 make menuconfig 编译菜单中选中了 hello module support， CONFIG_HELLO_MODULE 的值是 y，没有选中值是 m（我们定义的默认值是 y）：</p> <ul><li>obj-y  += hello_module.o 的意思是将 hello_module.o 编译进内核</li> <li>obj-m += hello_module.o 的意思是文件 hello_module.o 作为&quot;模块&quot;进行编译，不会编译到内核，但是会生成一个独立的 &quot;hello_module.ko&quot; 文件，可以使用 insmod 命令将模块加载到内核中</li></ul> <p>最后配置内核：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cp</span> ./arch/x86/configs/x86_64_ranchu_defconfig .config
<span class="token function">make</span> menuconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>进入 Device Drivers 选项：
<img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/image%20(1).png" alt=""></p> <p>进入 Character devices
<img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/image%20(2).png" alt=""></p> <p>这里就可以看见我们刚才添加的选项，默认是选上的。
<img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/image%20(3).png" alt=""></p> <p>然后执行编译：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># clean 一下，防止出错</span>
<span class="token function">make</span> clean
<span class="token comment">#执行之前的编译脚本</span>
<span class="token function">sh</span> build.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>进入 AOSP 源码启动模拟器：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">source</span> build/envsetup.sh
lunch aosp_x86_64-eng
emulator <span class="token parameter variable">-kernel</span> ~/kernel/goldfish/arch/x86_64/boot/bzImage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看开机信息：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># dmesg 用于显示开机信息</span>
adb shell <span class="token function">dmesg</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/image%20(4).png" alt=""></p> <h3 id="_4-3-linux-中文件的读写"><a href="#_4-3-linux-中文件的读写" class="header-anchor">#</a> 4.3 linux 中文件的读写</h3> <p>驱动是干什么的？在驱动的相关书籍上，网络上你能看到很多专业的定义。我们暂时不关心这些专业的说法，仅从功能的角度来说，<strong>驱动程序使得应用程序可以访问硬件</strong>。</p> <p>那应用是如何访问硬件的？linux 中一切皆文件，访问硬件就是对文件的读写操作。比如 led 灯对应的文件是  /dev/led, 读写这个文件就能操作 led 灯。</p> <p>接下来的问题就是，linux 中如何读写文件？</p> <p>linux中文件读写相关的主要 api：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//打开文件</span>
<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//从文件中读数据</span>
<span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//向文件中写数据</span>
<span class="token class-name">ssize_t</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//专用于设备输入输出操作</span>
<span class="token keyword">int</span> <span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> request<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//关闭文件的读写，回收资源</span>
<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>函数的具体用法不是本文的重点，有兴趣的同学可以学习 <a href="https://book.douban.com/subject/4831448/" target="_blank" rel="noopener noreferrer">Linux程序设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的第二章。工作中忘了，可以通过 man 命名查看具体用法。</p> <p>下面来看一下 open 函数：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//该函数用于打开文件</span>
<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当打开一个文件的时候，会返回一个 int 值，一般称这个返回值为句柄或者 handle，在内核中，句柄是一个数组的索引（index），数组的成员是 struct file ：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token punctuation">{</span>
        <span class="token keyword">union</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">llist_node</span>       fu_llist<span class="token punctuation">;</span>
                <span class="token keyword">struct</span> <span class="token class-name">rcu_head</span>         fu_rcuhead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> f_u<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">path</span>             f_path<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">inode</span>            <span class="token operator">*</span>f_inode<span class="token punctuation">;</span>       <span class="token comment">/* cached value */</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span>    <span class="token operator">*</span>f_op<span class="token punctuation">;</span>   <span class="token comment">//关注1</span>

        <span class="token comment">/*
         * Protects f_ep_links, f_flags.
         * Must not be taken from IRQ context.
         */</span>
        <span class="token class-name">spinlock_t</span>              f_lock<span class="token punctuation">;</span>
        <span class="token keyword">enum</span> <span class="token class-name">rw_hint</span>            f_write_hint<span class="token punctuation">;</span>
        <span class="token class-name">atomic_long_t</span>           f_count<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>            f_flags<span class="token punctuation">;</span>  <span class="token comment">//关注2</span>
        <span class="token class-name">fmode_t</span>                 f_mode<span class="token punctuation">;</span>	  <span class="token comment">//关注3</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span>            f_pos_lock<span class="token punctuation">;</span>
        <span class="token class-name">loff_t</span>                  f_pos<span class="token punctuation">;</span>	  <span class="token comment">//关注4</span>
        <span class="token keyword">struct</span> <span class="token class-name">fown_struct</span>      f_owner<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span>       <span class="token operator">*</span>f_cred<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">file_ra_state</span>    f_ra<span class="token punctuation">;</span>

        u64                     f_version<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SECURITY</span></span>
        <span class="token keyword">void</span>                    <span class="token operator">*</span>f_security<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token comment">/* needed for tty driver, and maybe others */</span>
        <span class="token keyword">void</span>                    <span class="token operator">*</span>private_data<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_EPOLL</span></span>
        <span class="token comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>        f_ep_links<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>        f_tfile_llink<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* #ifdef CONFIG_EPOLL */</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">address_space</span>    <span class="token operator">*</span>f_mapping<span class="token punctuation">;</span>
        <span class="token class-name">errseq_t</span>                f_wb_err<span class="token punctuation">;</span>
<span class="token punctuation">}</span> __randomize_layout
  <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>struct file 的结构有点复杂，入门阶段主要关注代码中标注的四个关注点。</p> <p>在内核中，有一个 struct file 的数组，当调用 open 函数打开一个文件的时候，内核就会构建一个 struct file，并添加到这个数组中，返回 struct  file 在数组中的 index 给用户态程序，这个值就是 open 函数的返回值。</p> <p>根据文件的命名，容易猜出：使用 open 打开文件时，传入的 flags、mode 等参数会被记录在内核中，具体如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/image%20(5).png" alt=""></p> <p>struct file 有一个成员为 file_operations：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
	<span class="token class-name">loff_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>llseek<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//关注点1</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关注点2</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_iter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_iter<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kiocb</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>iterate<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dir_context</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>iterate_shared<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">dir_context</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>unlocked_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>compat_ioctl<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关注点3</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关注点4</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关注点5</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fl_owner_t</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关注点6</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关注点7</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fsync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">int</span> datasync<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fasync<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>sendpage<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_unmapped_area<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>check_flags<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>splice_write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>splice_read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setlease<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file_lock</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>fallocate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> offset<span class="token punctuation">,</span>
			  <span class="token class-name">loff_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>show_fdinfo<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONFIG_MMU</span></span>
	<span class="token keyword">unsigned</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap_capabilities<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>copy_file_range<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span>
			<span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>clone_file_range<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token punctuation">,</span>
			u64<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dedupe_file_range<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> u64<span class="token punctuation">,</span> u64<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span>
			u64<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> __randomize_layout<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>内部主要是一些函数指针，我们主要关注常用的几个函数：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fl_owner_t</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>驱动程序会定义与应用层函数（open write read ioctl close 等）对应的驱动层函数，驱动程序在初始化时将这些函数对应的函数指针赋值给 file_operations，然后在驱动注册时传入 file_operations 结构体，完成应用层系统调用与驱动程序函数的调用：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165857.png" alt=""></p> <p>至此，文件读写的大致流程就出来了：</p> <ul><li>app 调用 open read 等系统调用函数</li> <li>内核构建相应的 struct file，并添加进数组，返回 index 给 app</li> <li>调用驱动程序 file_operations 指针提供的 open read 等函数，完成实际的硬件操作</li></ul> <h3 id="_4-4-hello-驱动的编写"><a href="#_4-4-hello-驱动的编写" class="header-anchor">#</a> 4.4 Hello 驱动的编写</h3> <p>驱动就是一个模块，在模块的基础上添加驱动框架和硬件操作的部分就可以完成驱动程序的编写了。下面我们写一个 hello 驱动，这个驱动只是简单的在用户态和内核态之间拷贝数据，没有实际的硬件操作，仅用于流程的展示。编写驱动的步骤如下：</p> <ol><li>确定主设备号，也可以让内核分配 （设备号就是硬件的一个编号）</li> <li>定义自己的 file_operations 结构体</li> <li>实现对应的 drv_open/drv_read/drv_write 等函数，填入 file_operations 结构体</li> <li>定义 init 函数，在 init 函数中调用 register_chrdev 注册函数</li> <li>定义 exit 函数，在 exit 函数中调用 unregister_chrdev 卸载函数</li> <li>其他完善：提供设备信息，自动创建设备节点：class_create, device_create</li></ol> <p>在 ~/Project 目录下创建如下的目录结构：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>hello_drv
├── build_driver.sh
├── hello_drv.c
└── Makefile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>其中 hello_drv.c：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/miscdevice.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/major.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/seq_file.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/tty.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kmod.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gfp.h&gt;</span></span>

<span class="token comment">/* 1. 确定主设备号                                                                 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> kernel_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>hello_class<span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MIN</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> b <span class="token operator">?</span> a <span class="token operator">:</span> b<span class="token punctuation">)</span></span></span>

<span class="token comment">/* 3. 实现对应的open/read/write等函数，填入file_operations结构体                   */</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_drv_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>offset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s line %d\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> kernel_buf<span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">hello_drv_write</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>offset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s line %d\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>kernel_buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_drv_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s line %d\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_drv_close</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s line %d\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 2. 定义自己的file_operations结构体                                              */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> hello_drv <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>owner	 <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>open    <span class="token operator">=</span> hello_drv_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read    <span class="token operator">=</span> hello_drv_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write   <span class="token operator">=</span> hello_drv_write<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>release <span class="token operator">=</span> hello_drv_close<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 4. 把file_operations结构体告诉内核：注册驱动程序                                */</span>
<span class="token comment">/* 5. 谁来注册驱动程序啊？得有一个入口函数：安装驱动程序时，就会去调用这个入口函数 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">hello_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s line %d\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_drv<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* /dev/hello */</span>

	<span class="token comment">//提供设备信息，自动创建设备节点。</span>
	<span class="token comment">// /dev/hello</span>
	hello_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">&quot;hello_class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>hello_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>hello_class<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s line %d\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">device_create</span><span class="token punctuation">(</span>hello_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* /dev/hello */</span>
	<span class="token comment">//到这里我们就可以通过 /dev/hello 文件来访问我们的驱动程序了。</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 6. 有入口函数就应该有出口函数：卸载驱动程序时，就会去调用这个出口函数           */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s %s line %d\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">device_destroy</span><span class="token punctuation">(</span>hello_class<span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>hello_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* 7. 其他完善：提供设备信息，自动创建设备节点                                     */</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>hello_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">&quot;GPL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p>可以看出，除了定义 read write 等函数，其他都是一些模板代码。</p> <p>我们可以使用模块章节介绍的方法将驱动编译进内核。也可以直接编写 makefile 在 Kernel 源码外部编译驱动模块，然后通过命令行加载和卸载驱动程序。这里介绍第二种方法：</p> <p>创建 Makefile 文件：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token comment"># 指向你自己的 Kernel 路径</span>
KERN_DIR <span class="token operator">=</span> /home/zzh0838/kernel/goldfish

<span class="token target symbol">all</span><span class="token punctuation">:</span>
	make -C <span class="token variable">$</span><span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>`pwd` modules 

<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	make -C <span class="token variable">$</span><span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>`pwd` modules clean
	rm -rf modules.order
	rm -f hello_drv_test

obj-m	<span class="token operator">+=</span> hello_drv.o
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>-C  选项的作用是指将当前工作目录转移到你所指定的位置。“M=”选项的作用是，当用户需要以某个内核为基础编译一个外部模块的话，需要在 make modules  命令中加入“M=dir”，程序会自动到你所指定的 dir 目录中查找模块源码，将其编译，生成 KO 文件。</p> <p>编写编译驱动的脚本 build_driver.sh：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86_64
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SUBARCH</span><span class="token operator">=</span>x86_64
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>x86_64-linux-android-
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=~</span>/aosp/prebuilts/gcc/linux-x86/x86/x86_64-linux-android-4.9/bin:<span class="token environment constant">$PATH</span>
<span class="token function">make</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>执行 ./build_driver.sh，编译出 hello_drv.ko，接下来启动模拟器，把 ko 文件上传到模拟器：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> aosp目录
<span class="token builtin class-name">source</span> build/envsetup.sh
lunch aosp_x86_64-eng
<span class="token comment"># 驱动要和内核配套</span>
emulator <span class="token parameter variable">-kernel</span> ~/Project/Kernel/goldfish/arch/x86_64/boot/bzImage

<span class="token builtin class-name">cd</span> hello_drv
<span class="token comment"># 使用 adb 上传 ko 文件</span>
adb push hello_drv.ko /data/local/tmp
<span class="token comment"># 进入模拟器的 shell 环境</span>
adb shell 
<span class="token builtin class-name">cd</span> /data/local/tmp
<span class="token comment">#加载模块，加载完成后，/dev 目录下就会有一个 hello 文件</span>
insmod hello_drv.ko
<span class="token function">ls</span> /dev/hello <span class="token parameter variable">-l</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>接着我们再写一个测试程序：</p> <p>在 ~/Project 目录下创建如下的目录结构：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>hello_drv_test/
├── build_hello_driver_test.sh
├── CMakeLists.txt
└── hello_drv_test.c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>hello_drv_test.c</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token comment">/*
 * ./hello_drv_test -w abc
 * ./hello_drv_test -r
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> len<span class="token punctuation">;</span>

	<span class="token comment">/* 1. 判断参数 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Usage: %s -w &lt;string&gt;\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;       %s -r\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 2. 打开文件 */</span>
	fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/hello&quot;</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;can not open file /dev/hello\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* 3. 写文件或读文件 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;-w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		len <span class="token operator">=</span> len <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">?</span> len <span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">;</span>
		<span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		buf<span class="token punctuation">[</span><span class="token number">1023</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;APP read : %s\n&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>通过 cmake 的方式来编译测试程序:</p> <p>编写 CMakeLists.txt：</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token keyword">cmake_minimum_required</span><span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.0</span><span class="token punctuation">)</span>

<span class="token keyword">project</span><span class="token punctuation">(</span>hello_drv_test<span class="token punctuation">)</span>

<span class="token keyword">add_executable</span><span class="token punctuation">(</span><span class="token punctuation">${</span><span class="token variable">PROJECT_NAME</span><span class="token punctuation">}</span> hello_drv_test.c<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>编写编译脚本 build_driver_test.sh：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">ANDROID_NDK</span><span class="token operator">=</span>你的ndk安装目录

<span class="token function">rm</span> <span class="token parameter variable">-r</span> build
<span class="token function">mkdir</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build 

<span class="token comment"># CMake的内置支持</span>
<span class="token comment"># cmake -DCMAKE_SYSTEM_NAME=Android \</span>
<span class="token comment"># 	-DCMAKE_SYSTEM_VERSION=29 \</span>
<span class="token comment"># 	-DCMAKE_ANDROID_ARCH_ABI=x86_64 \</span>
<span class="token comment"># 	-DANDROID_NDK=$ANDROID_NDK \</span>
<span class="token comment"># 	-DCMAKE_ANDROID_STL_TYPE=c++_shared \</span>
<span class="token comment"># 	..</span>

<span class="token comment"># 工具链文件支持</span>
cmake <span class="token punctuation">\</span>
    <span class="token parameter variable">-DCMAKE_TOOLCHAIN_FILE</span><span class="token operator">=</span><span class="token variable">$ANDROID_NDK</span>/build/cmake/android.toolchain.cmake <span class="token punctuation">\</span>
    <span class="token parameter variable">-DANDROID_ABI</span><span class="token operator">=</span>x86_64 <span class="token punctuation">\</span>
    <span class="token parameter variable">-DANDROID_PLATFORM</span><span class="token operator">=</span>android-29 <span class="token punctuation">\</span>
	<span class="token parameter variable">-DANDROID_STL</span><span class="token operator">=</span>c++_shared <span class="token punctuation">\</span>
	  <span class="token punctuation">..</span>

cmake <span class="token parameter variable">--build</span> <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>编译程序并上传模拟器：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 编译</span>
<span class="token function">sh</span> ./build_driver_test.sh
<span class="token comment"># 打开模拟器，流程略</span>
<span class="token comment"># 上传可执行文件</span>
adb push build/hello_drv_test /data/local/tmp
<span class="token comment"># 进入到模拟器 shell</span>
adb shell
<span class="token comment"># 执行程序</span>
<span class="token builtin class-name">cd</span> /data/local/tmp
<span class="token comment"># 加载驱动程序</span>
insmod hello_drv.ko
./hello_drv_test <span class="token parameter variable">-w</span> <span class="token string">&quot;nihao&quot;</span>
./hello_drv_test <span class="token parameter variable">-r</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>执行程序的结果如下所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/image%20(6).png" alt=""></p> <h2 id="_5-linux-内核常用数据结构"><a href="#_5-linux-内核常用数据结构" class="header-anchor">#</a> 5. Linux 内核常用数据结构</h2> <p>Binder 是一个 Linux 驱动，驱动代码会涉及很多 Linux 内核中的数据结构，接下来我们就来看看 Linux 中的常用数据结构的基本使用：</p> <ul><li>双向链表 list_head</li> <li>hash 表 hlist</li> <li>红黑树 rbroot</li></ul> <h3 id="_5-1-双向链表"><a href="#_5-1-双向链表" class="header-anchor">#</a> 5.1 双向链表</h3> <p>list_head 是内核中定义的双向链表：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// kernel/inclue/linux/types.h</span>
<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>内核中提供了链表初始化的宏：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//初始化链表的宏</span>
<span class="token comment">//初始化一个 list_head 节点, 其 next prev 指针均指向自己</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_HEAD_INIT</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LIST_HEAD</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">list_head</span> name <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></span></span>

<span class="token comment">//也提供了初始化链表的函数：</span>
```c
<span class="token comment">//初始化一个 list_head 节点</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>list<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">WRITE_ONCE</span><span class="token punctuation">(</span>list<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//多线优化的赋值</span>
	list<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>常用 LIST_HEAD 初始化一个链表：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//宏展开</span>
<span class="token keyword">struct</span> <span class="token class-name">list_head</span> head <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token punctuation">}</span>；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>head 的 prev 和 next 指针都是指向自己:</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165113.png" alt=""></p> <p>但是如果只是利用 list_head 这样的结构体实现链表就没有什么实际意义了，因为正常的链表都是为了遍历结构体中的其它有意义的字段而创建的，而我们 list_head 中只有 prev 和 next 指针，却没有实际有意义的字段数据，所以毫无意义。我们可以创建一个宿主结构，然后在此结构中再嵌套 list_head 字段，宿主结构又有其它的字段（进程描述符 task_struct，页面管理的page结构等就是采用这种方法创建链表的）。接着看我们的示例：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">list_node_task</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span> <span class="token comment">//嵌套链表节点</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接着我们可以创建节点：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">list_node_task</span> first_task <span class="token operator">=</span> 
<span class="token punctuation">{</span> 
	<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>first_task<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以通过 list_add 方法在<strong>链表头</strong>插入新的数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//定义并初始化链表头</span>
<span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//链表插入节点,加入链表头</span>
<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>first_task<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们看一下, list_add 的具体实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/**
 * list_add - add a new entry
 * @new: new entry to be added
 * @head: list head to add it after
 *
 * Insert a new entry after the specified head.
 * This is good for implementing stacks.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>new<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>head<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">__list_add</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> head<span class="token punctuation">,</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Insert a new entry between two known consecutive entries.
 *
 * This is only for internal list manipulation where we know
 * the prev/next entries already!
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">__list_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>new<span class="token punctuation">,</span>
			      <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>prev<span class="token punctuation">,</span>
			      <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>next<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__list_add_valid</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
 
	next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> new<span class="token punctuation">;</span>
	new<span class="token operator">-&gt;</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
	new<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>
	<span class="token function">WRITE_ONCE</span><span class="token punctuation">(</span>prev<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>从源码可以看出，list_add 就是在 head 链表头后和链表头后第一个节点之间插入一个新节点。然后这个新的节点就变成了链表头后的第一个节点了。</p> <p>调用 <code>list_add(&amp;first_task.list, &amp;header)</code> 后，整体数据结构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165131.png" alt=""></p> <p>接着我们可以再构建一个节点，并插入链表：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">list_node_task</span> second_task <span class="token operator">=</span> 
<span class="token punctuation">{</span> 
	<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>second_task<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>second_task<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>完成上述操作后，链表的整体结构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165145.png" alt=""></p> <p>可以看出 list_add 是在链表的头部添加节点，也可以通过 list_add_tail 方法在链表尾插入新的数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">list_node_task</span> third_task <span class="token operator">=</span> 
<span class="token punctuation">{</span> 
	<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span>list <span class="token operator">=</span> <span class="token function">LIST_HEAD_INIT</span><span class="token punctuation">(</span>third_task<span class="token punctuation">.</span>list<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>third_task<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>删除节点也是链表的一个常用操作：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//删除节点</span>
<span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>first_task<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>list_del(struct list_head *entry)</code> 接口可以删除链表中的任意节点，但需注意，前提条件是这个节点是已知的，既在链表中真实存在，prev，next 指针都不为 NULL。</p> <p>链表的另一个重要操作是遍历:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//list_head 遍历</span>
<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>pos<span class="token punctuation">;</span>
<span class="token function">list_for_each</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
<span class="token punctuation">}</span>

<span class="token comment">//倒序遍历                                                                                                                </span>
<span class="token function">list_for_each_prev</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
<span class="token punctuation">}</span>

<span class="token comment">//宿主结构的遍历</span>
<span class="token keyword">struct</span> <span class="token class-name">list_node_task</span> <span class="token operator">*</span>task<span class="token punctuation">;</span>
<span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token operator">&amp;</span>header<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>上面的所有操作基本都是基于 list_head 这个链表进行的，涉及的结构体也都是:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>next<span class="token punctuation">,</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>实际我们真正更关心的是包含 list_head 这个结构体字段的宿主结构体，因为只有定位到了宿主结构体的起始地址，我们才能对宿主结构体中的其它有意义的字段进行操作。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">list_node_task</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>那我们如何根据 list 这个字段的地址而找到宿主结构 my_node_task 的位置呢？</p> <p>内核中提供了 list_entry 来实现这个功能：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 获得 second_task </span>
list_node_task <span class="token operator">*</span>temp <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>second_task<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">list_node_task</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165200.png" alt=""></p> <p>list_entry 通过 container_of 实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">list_entry</span><span class="token expression"><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> type<span class="token punctuation">,</span> member<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">container_of</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> type<span class="token punctuation">,</span> member<span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>container_of 在内核中有大量的使用，其内部实现主要是一些指针操作，有兴趣的同学可以自行查看一下源码。</p> <h3 id="_5-2-hash-表"><a href="#_5-2-hash-表" class="header-anchor">#</a> 5.2 hash 表</h3> <p>hlist 是 linux 内核中基于双向链表实现的 hash 表，相关的数据结构有两个：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//hash 桶的头结点</span>
<span class="token keyword">struct</span> <span class="token class-name">hlist_head</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token operator">*</span>first<span class="token punctuation">;</span><span class="token comment">//指向每一个hash桶的第一个结点的指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//hash 桶的普通结点</span>
<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token comment">//指向下一个结点的指针</span>
	<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token operator">*</span><span class="token operator">*</span>pprev<span class="token punctuation">;</span><span class="token comment">//指向上一个结点的next指针的地址</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>hash 表的结构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165215.png" alt=""></p> <ul><li>使用 hlist 通常会定义一个 hlist_head 的数组，</li> <li>hlist_head 结构体只有一个成员，即 first。 first 指针指向该 hlist 链表的第一个节点。</li> <li>hlist_node 结构体有两个成员，next 和 pprev。 next 指针很容易理解，它指向下个 hlist_node 结点，倘若该节点是链表的最后一个节点，next 指向 NULL。</li> <li>pprev 是一个二级指针，它指向前一个节点的 next 指针的地址</li></ul> <p>pprev 为什么要是一个执行向前一个节点的 next 指针地址的二级指针？ 直接指向上一个节点会不会更简单一点？</p> <p>这里应该是一个设计取向问题，因为 hash 桶的类型是 hlist_head，为了减少数据结构额外内存开销，其内部有一个只有一个指针，如果 hlist_node 采用传统的 next,prev指针，对于第一个节点和后面其他节点的处理会不一致。这样并不优雅。</p> <p>hlist_node 巧妙地将 pprev 指向上一个节点的 next 指针的地址，由于 hlist_head 的 first 域指向的结点类型和 hlist_node 指向的下一个结点的结点类型相同，这样就解决了通用性！</p> <p>这种编码的方式是值得我们学习的。</p> <p>接着我们来看一下，如何初始化一个 hash 表并插入数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code> <span class="token comment">//定义宿主结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">hdata_node</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//hash 数组</span>
<span class="token keyword">struct</span> <span class="token class-name">hlist_head</span> htable<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">hdata_node</span> <span class="token operator">*</span>hnode<span class="token punctuation">;</span>

<span class="token comment">//初始化</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hnode <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hdata_node</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_HLIST_NODE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>hnode<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hnode<span class="token operator">-&gt;</span>data <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token comment">//链表中插入数据</span>
    <span class="token comment">//自定义 hash 算法，这里简单取余</span>
    <span class="token keyword">int</span> key <span class="token operator">=</span> hnode<span class="token operator">-&gt;</span>data <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token comment">//添加到链表首部</span>
    <span class="token function">hlist_add_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hnode<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>htable<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>查询数据：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//查询</span>
<span class="token keyword">int</span> search <span class="token operator">=</span> <span class="token number">67</span> <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token comment">//自定义 hash 算法，这里简单取余</span>
<span class="token keyword">int</span> key <span class="token operator">=</span> search <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hlist_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htable<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//没有需要查询的项</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//遍历查询</span>
    <span class="token function">hlist_for_each_entry</span><span class="token punctuation">(</span>hnode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>htable<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hnode<span class="token operator">-&gt;</span>data <span class="token operator">==</span> search<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//找到了</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>删除数据:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//删除</span>
<span class="token keyword">int</span> delete <span class="token operator">=</span> <span class="token number">88</span> <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> key2 <span class="token operator">=</span> search <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token operator">*</span>n<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hlist_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htable<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//没有需要查询的项</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//遍历查询</span>
    <span class="token function">hlist_for_each_entry_safe</span><span class="token punctuation">(</span>hnode<span class="token punctuation">,</span> n <span class="token punctuation">,</span><span class="token operator">&amp;</span>htable<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hnode<span class="token operator">-&gt;</span>data <span class="token operator">==</span> search<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//找到了</span>
            <span class="token function">hlist_del</span><span class="token punctuation">(</span>hnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>内存清理：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//退出程序前释放资源</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//遍历每一个槽，有结点就删除</span>
    <span class="token function">hlist_for_each_entry_safe</span><span class="token punctuation">(</span>hnode<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token operator">&amp;</span>htable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">hlist_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hnode<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>hnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hnode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_5-3-红黑树"><a href="#_5-3-红黑树" class="header-anchor">#</a> 5.3 红黑树</h3> <p>红黑树，从理论到实现都是相对复杂的数据结构，但是实际编码中一般不需要我们去做实现，把它看成一个插入数据慢点，查找数据快点，排序非常快的链表即可。从使用上来说，红黑树主要又以下特点：</p> <ul><li>插入、删除、查找的时间复杂度接近 O(logN)，N 是节点个数；是一种性能非常稳定的二叉树！</li> <li>中序遍历的结果是从小到大排好序的</li></ul> <p>接着我们来看下 linux 内核中，红黑树的基本使用：</p> <p>内核中定义了以下几个红黑树相关的数据结构：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//红黑树节点</span>
<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>  __rb_parent_color<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>rb_right<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>rb_left<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//红黑树根节点</span>
<span class="token keyword">struct</span> <span class="token class-name">rb_root</span> <span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>rb_node<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>接下来我们看看如何如何使用内核中的红黑树：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//定义宿主结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//内核中没有提供现成的插入，查找函数，需要使用者自己实现</span>
<span class="token keyword">int</span> <span class="token function">rb_insert</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rb_root</span> <span class="token operator">*</span>root<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span> <span class="token operator">*</span>insert_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>n <span class="token operator">=</span> root<span class="token operator">-&gt;</span>rb_node<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获得宿主结构</span>
        <span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span> <span class="token operator">*</span>thiz <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parent <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thiz<span class="token operator">-&gt;</span>data <span class="token operator">&gt;</span> insert_node<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> n<span class="token operator">-&gt;</span>rb_left<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>thiz<span class="token operator">-&gt;</span>data <span class="token operator">&lt;</span> insert_node<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> n<span class="token operator">-&gt;</span>rb_right<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//已经有了待插入节点，直接退出</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//插入新的节点</span>
    <span class="token function">rb_link_node</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>insert_node<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rb_insert_color</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>insert_node<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//定义节点查询函数</span>
<span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span> <span class="token operator">*</span><span class="token function">rb_search</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rb_root</span> <span class="token operator">*</span>root<span class="token punctuation">,</span> <span class="token keyword">int</span> new<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>node <span class="token operator">=</span> root<span class="token operator">-&gt;</span>rb_node<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span> <span class="token operator">*</span>my_node <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>my_node<span class="token operator">-&gt;</span>data <span class="token operator">&gt;</span> new<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node <span class="token operator">=</span> node<span class="token operator">-&gt;</span>rb_left<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>my_node<span class="token operator">-&gt;</span>data <span class="token operator">&lt;</span> new<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node <span class="token operator">=</span> node<span class="token operator">-&gt;</span>rb_right<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> my_node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>
    
<span class="token keyword">struct</span> <span class="token class-name">rb_root</span> mytree <span class="token operator">=</span> RB_ROOT<span class="token punctuation">;</span>
    
<span class="token comment">//插入元素</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token operator">-&gt;</span>data <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">36</span><span class="token punctuation">;</span>
    <span class="token function">rb_insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytree<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token comment">//遍历红黑树</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>node <span class="token operator">=</span> <span class="token function">rb_first</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytree<span class="token punctuation">)</span><span class="token punctuation">;</span> node<span class="token punctuation">;</span> node <span class="token operator">=</span> <span class="token function">rb_next</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;key=%d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token comment">//红黑树内存清理</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>node <span class="token operator">=</span> <span class="token function">rb_first</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mytree<span class="token punctuation">)</span><span class="token punctuation">;</span> node<span class="token punctuation">;</span> node <span class="token operator">=</span> <span class="token function">rb_next</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token function">rb_entry</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">my_tree_node</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">rb_erase</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mytree<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><h2 id="_6-虚拟内存与-linux-文件访问接口"><a href="#_6-虚拟内存与-linux-文件访问接口" class="header-anchor">#</a> 6. 虚拟内存与 Linux 文件访问接口</h2> <h3 id="_6-1-什么是虚拟内存"><a href="#_6-1-什么是虚拟内存" class="header-anchor">#</a> 6.1 什么是虚拟内存</h3> <p>一些简单的计算机系统，比如简单的单片机，cpu 是直接访问物理内存的，不存在虚拟内存，同时也不存在操作系统，我们的程序直接跑在硬件之上。</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165235.png" alt=""></p> <p>读内存的过程如下：</p> <ul><li>cpu 通过控制总线向内存发送读指令</li> <li>随后将内存地址通过地址总线发送给内存</li> <li>内存读到数据后，通过数据总线将数据发送给 cpu</li></ul> <p>物理内存的地址从 0 开始，我们编写的代码读写内存也是从 0 开始。</p> <p>单片机上只跑一个程序的时候，一切安好。</p> <p>如果我们要再跑一个程序，我们读写内存如果还是从 0 开始，就会和第一个程序“打架”，发生冲突。如果不从 0 开始，比如我们规定第一个程序使用 0 到 4k的内存，第二个程序使用 4k 到 8k 的内存 ，这样能解决问题，但是，我们的程序就只能在特定环境下使用。</p> <p>那怎么办，加一层————虚拟内存。</p> <p>我们的每个进程访问的是从 0 开始的虚拟内存，在通过 mmu （内存管理单元）映射到物理内存，mmu 可以理解为一张巨大的表格，里面记录着每个进程使用的虚拟内存地址与物理内存地址的映射关系：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165246.png" alt=""></p> <p>有了虚拟内存以后，内存的读过程如下：</p> <ul><li>进程1 发出读内存信号</li> <li>进程1 向 MMU 发送一个虚拟地址</li> <li>MMU 在自己的表格中找到对应的物理地址，并从物理内存上读出数据，将数据返回给进程 1</li></ul> <p>对于虚拟地址空间一般分为：</p> <ul><li>内核地址空间：操作系统内核使用的虚拟内存区域</li> <li>用户地址空间：用户态程序使用的虚拟内存区域区域</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165253.png" alt=""></p> <p>不同进程之间的内核地址空间映射到相同的物理地址，即不同的进程的内核地址空间是共享的。不同进程之间的用户地址空间映射到不同的物理地址，相互之间是隔离的，无法访问的。</p> <p>以上是虚拟内存的一个形象理解，对于软件开发人员已经足够，实际情况要复杂很多，涉及了分段分页，一二级页表，快表等内容，更为详细的内容可以参考计算机组成，操作系统相关的书籍</p> <h3 id="_6-2-linux-文件访问系统调用"><a href="#_6-2-linux-文件访问系统调用" class="header-anchor">#</a> 6.2 Linux 文件访问系统调用</h3> <p>在 Linux 中一切皆文件，比如 Android 中的 binder 实际是一个字符驱动，其对应的文件是 <code>/dev/binder</code>。所以我们需要熟悉 Linux 中文件访问系统的接口。</p> <p>访问文件常用的函数有下面几个：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>open
close
read
write
ioctl
mmap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这些函数都是系统调用接口，由内核中的 VFS（ Virtual Filesystem）提供，VFS 对上（应用层）提供统一的文件访问接口，对下（文件系统，设备文件）根据不同目标特点，实现具体的操作，比如打开，读写等：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230703165304.png" alt=""></p> <p>实际上，我们应用层调用的 open read 等系统调用，通过内核部分的处理最终都是调用到驱动中实现的 xxx_open xxx_read 等函数。</p> <h2 id="关于"><a href="#关于" class="header-anchor">#</a> 关于</h2> <p>我叫阿豪，2015 年本科毕业于国防科学技术大学指挥信息系统专业，毕业后从事信息化装备的研发工作，主要研究方向是 Android Framework 与 Linux Kernel。</p> <p>如果你对 Android Framework 感兴趣或者正在学习 Android Framework，可以关注我的微信公众号和抖音，我会持续分享我的学习经验，帮助正在学习的你少走一些弯路。学习过程中如果你有疑问或者你的经验想要分享给大家可以添加我的微信，我拉你进技术交流群。</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg" alt=""></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/000.Binder 专题导学 —— 如何深入掌握 Binder.html" class="prev">
          1.专题导学 —— 如何深入掌握 Binder
        </a></span> <span class="next"><a href="/AndroidFrameworkTutorialPages/003.学穿Binder篇/002.Binder 基本原理.html">
          3.Binder 基本原理
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/AndroidFrameworkTutorialPages/assets/js/app.a5dad8b6.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/74.731ff6ad.js" defer></script>
  </body>
</html>
